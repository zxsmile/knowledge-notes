# 一、什么是`DNS`？

`DNS`往往是网络请求的第一步，在互联网上，通信是基于`TCP/IP`协议来进行的，如果`TCP|UDP`定义了数据传输的方式，那么通过`IP`协议，我们就可以知道数据传输的地点。 不过日常我们也是可以通过域名去访问对应的地址，而事实上只有`IP`地址才可以寻找到对应服务器，因此当你使用域名去访问，首先经历的是一个域名解析的过程，将域名转换成对应的`IP`地址，再去寻址。**它实质上是一个域名和 `IP`相互映射的分布式数据库，有了它我们就可以通过域名更方便的访问互联网。** `DNS`有以下特点:

- 分布式的
- 协议支持`TCP` 和 `UDP`, 常用端口是53
- 每一级域名的长度限制是63
- 域名总长度限制是253

# 二、为什么要使用`DNS` #

- 网络通讯大部分是基于`TCP/IP`的，而`TCP/IP`是基于``IP``地址的，所以计算机在网络上进行通讯时只能识别如“202.96.134.133”之类的``IP``地址，而不能认识域名。我们无法记住10个以上``IP``地址的网站，所以我们访问网站时，更多的是在浏览器地址栏中输入域名，就能看到所需要的页面，这是因为有一个叫“``DNS``服务器”的计算机自动把我们的域名“翻译”成了相应的``IP``地址，然后调出``IP``地址所对应的网页。

- 简单的说，通过域名，最终得到该域名对应的``IP``地址的过程叫做域名解析（或主机名解析）。**想要访问一台服务器，最终是靠`IP`地址访问的，而不是靠域名访问的。**

		`www.dnscache.com`  (域名)  - ``DNS``解析 --> 11.222.33.444 (``IP``地址)

- ``DNS``协议运行在`UDP`协议之上，使用端口号53。

# 三、`DNS` 为什么要通过 `IP` 确认通信对象

我们知道，在浏览器中，输入 `IP` 或者 `域名`，都可以访问我们的目的网站，既然如此，为什么不通过域名去确认通信对象，而是通过 `IP` 呢？

 从运行效率上来讲，`IP` 地址是 32 比特，也就是 4 字节，而域名，最短也要十几个字节，最长的时候，可能达到 255 字节，换句话讲，使用 `IP`  地址只需要处理 4 字节的数字，现在用域名，就要处理十几甚至 255 个字节的字符，这严重影响效率。同时添加了路由器的负担，传送数据也会花费更长的时间。

比如我发送一个 `2KB` 的字符串，中间有可能通过光纤传递传递，也有可能其他的方式，如早期的铜缆。不同的连接材料带宽不同。有可能一个包的 `maxSize` 只能 `1KB`。应用层的数据在通讯过程中会根据通讯设备的带宽分成很多个包。一个 `http` 请求并不是只发了一个包，可能一次请求被拆成了很多个包。所以如果用域名，网络请求的数据量会增加很多。

 “那使用高性能路由器不就能解决这个问题了吗”

`ok`，但是要知道，路由器的速度是有极限的，互联网内部流动的数据量已经让路由器疲于应付了。虽然随着技术发展，路由器性能会不断提升，但是与此同时，数据量也以更快的速度在增长。所以说，用域名确认通信对象不是一个明智的选择 。

# 三、域名

> **网域名称**（英语：`Domain Name`，简称：`Domain`），简称**域名**、**网域**，是由一串用点分隔的字符组成的互联网上某一台计算机或计算机组的名称，用于在数据传输时标识计算机的电子方位。域名可以说是一个`IP`地址的代称，目的是为了便于记忆后者。例如，`wikipedia.org`是一个域名。人们可以直接访问`wikipedia.org`来代替`IP`地址，然后域名系统（`DNS`）就会将它转化成便于机器识别的`IP`地址。这样，人们只需要记忆`wikipedia.org`这一串带有特殊含义的字符，而不需要记忆没有含义的数字域名。

全世界域名的最高管理机构，是一个叫做 `ICANN` （`Internet Corporation for Assigned Names and Numbers`）的组织，总部在美国加州。**`ICANN` 负责管理全世界域名系统的运作**。

域名其实是具有一定的层次结构的，从上到下依次为：**根域名**、**顶级域名**（`top level domain，TLD`）、**二级域名**、（三级域名）

![dns9](.\images\dns9.png)

## 顶级域名

先来讲讲**顶级域名**（`TLD`），即最高层级的域名。简单说，就是网址的最后一个部分。比如，网址`www.baidu.com` 的顶级域名就是 `.com`。`ICANN` 的一项主要工作，就是规定哪些字符串可以当作顶级域名。截至 2015 年 7 月，顶级域名共有 1058 个，它们大致可以分成两类：

- 一类是**通用顶级域名**（`gTLD`），比如`.com`、`.net`、`.edu`、`.org`、`.xxx`等等，共有 700 多个。
- 另一类是**国家顶级域名**（`ccTLD`），代表不同的国家和地区，比如`.cn`（中国）、`.io`（英属印度洋领地）、`.cc`（ 科科斯群岛）、`.tv`（图瓦卢）等，共有 300 多个。

当然，`ICANN` 自己不会去管理这些顶级域名，因为根本管不过来。想想看，顶级域名有1000多个，每个顶级域名下面都有许多批发商，如果每个都要管，就太麻烦了。`ICANN` 的政策是，每个顶级域名都找一个**托管商**，该域名的所有事项都由托管商负责。`ICANN` 只与托管商联系，这样管理起来就容易多了。举例来说，`.cn` 国家顶级域名的托管商就是中国互联网络信息中心（`CNNIC`），它决定了 `.cn` 域名的各种政策。

##  二级域名

而**二级域名**(`Second Level Domain,SLD`) 在通用顶级域名或国家顶级域名之下具有不同的意义：

- 通用顶级域名下的二级域名：一般是指域名注册人选择使用的网上名称，如 `yahoo.com`（商业组织通常使用自己的商标、商号或其他商业标志作为自己的网上名称，如 `baidu.com`）
- 国家顶级域名下的二级域名：一般是指类似于通用顶级域名的表示注册人类别和功能的标志。例如，在 `.com.cn` 域名结构中，`.com` 此时是置于国家顶级域名 `.cn` 下的二级域名，表示中国的商业性组织，以此类推。

**三级域名**是形如 `www.baidu.com` 的域名，可以当做是二级域名的子域名，特征为域名包含两个 `.`。对于域名所有者/使用者而言，三级域名都是二级域名的附属物而无需单独费用。**三级域名甚至不能称为域名，一般称之为域名下的 “二级目录”**

## 根域名

❓ 那么**根域名**在哪里呢？在层次结构中根域名不是最顶级的吗？域名中怎么没有看见它？

由于 `ICANN` 管理着所有的顶级域名，所以它是最高一级的域名节点，被称为根域名（`root domain`）。在有些场合，`www.xxx.com` 被写成 `www.xxx.com.`，即最后还会多出一个点。这个点就是根域名。

![dns10](.\images\dns10.png)

理论上，**所有域名的查询都必须先查询根域名**，因为只有根域名才能告诉你，某个顶级域名由哪台服务器管理。事实上也确实如此，**`ICANN` 维护着一张列表（根域名列表），里面记载着顶级域名和对应的托管商**。

![dns11](.\images\dns11.png)

比如，我要访问`abc.xyz`，也必须先去询问根域名列表，它会告诉我 `.xyz` 域名由 `CentralNic` 公司托管。根域名列表还记载，`.google`由谷歌公司托管，`.apple`由苹果公司托管等等。

由于根域名列表很少变化，大多数 `DNS` 服务商都会提供它的缓存，所以根域名的查询事实上不是那么频繁。

# 四、域名服务器

域名服务器是指管理域名的主机和相应的软件，它可以管理所在分层的域的相关信息。一个域名服务器所负责管里的分层叫作 **区 (`ZONE`)**。域名的每层都设有一个域名服务器：

- 根域名服务器
- 顶级域名服务器
- 权限域名服务器

下面这幅图就很直观了：

![dns12](.\images\dns12.png)

除了上面三种 `DNS` 服务器，还有一种不在 `DNS` 层次结构之中，但是很重要的 `DNS` 服务器，即**本地域名服务器**。下面我们分别讲解这四种服务器都是用来干什么的

## 根域名服务器

上面我们提到，`ICANN` 维护着一张根域名列表，里面记载着顶级域名和对应的托管商，其实根域名列表的正式名称是 **`DNS` 根区**（`DNS root zone`），保存 `DNS` 根区文件的服务器，就叫做 **`DNS` 根域名服务器**（`root name server`）。根域名服务器**保存所有的顶级域名服务器的地址**

由于早期的 `DNS` 查询结果是一个 512 字节的 `UDP` 数据包。这个包最多可以容纳 13 个服务器的地址，因此就规定全世界有 13 个根域名服务器，编号从 `a.root-servers.net` 一直到 `m.root-servers.net`。其中 10 台设置在美国，另外各有一台设置于荷兰、瑞典和日本。

在2016年之前全球一共拥有13台根服务器，1台主根服务器在美国，其他12台为辅根服务器，其中 10 台设置在美国，另外各有一台设置于荷兰、瑞典和日本，这13台根服务器主要管理互联网的主目录，主要作用`IPV4`。

2016年，中国下一代互联网工程中心领衔发起雪人计划，旨在为下一代互联网(`IPV6`)提供更多的根服务器解决方案，该计划于2017年完成，其中包含3台主根服务器，中国1台，美国1台，日本1台，22台辅根服务器，中国3台，美国2台，印度和法国分别有3台，德国2台，俄罗斯、意大利、西班牙、奥地利、智利、南非、澳大利亚、瑞士、荷兰各1台，共22台，从此形成了13台原有根服务器加25台`IPV6`根服务器的新格局。

![dns3](.\images\dns3.png)

前面我们说过，理论上**所有域名的查询都必须先查询根域名**，所以一般来说所有的域名服务器都会注册一份根域名服务器的 `IP` 地址的缓存，用于在必要的时候向其发送请求。

最高层次的域名服务器，也是最重要的域名服务器。所有的根域名服务器都知道所有的顶级域名服务器的域名和`IP`地址。不管是哪一个本地域名服务器，若要对因特网上任何一个域名进行解析，只要自己无法解析，就首先求助根域名服务器。所以根域名服务器是最重要的域名服务器。假定所有的根域名服务器都瘫痪了，那么整个`DNS`系统就无法工作。需要注意的是，在很多情况下，根域名服务器并不直接把待查询的域名直接解析出`IP`地址，而是告诉本地域名服务器下一步应当找哪一个顶级域名服务器进行查询。

##  顶级域名服务器

按照根域名服务器管理顶级域名的逻辑，顶级域名服务器显然就是用来**管理注册在该顶级域名下的所有二级域名**的，**记录这些二级域名的 `IP` 地址**。

顶级域名为域名最后一个`.`号右侧部分的单词，如`mail.baidu.com`的`com`就是顶级域名，顶级域名对应的服务器我们称之为顶级域名服务器，除此之外，常见的顶级域名还有`.NET`，`.TOP`，`.ORG`等，他们都有各自的用途。

- `.COM`：用于商业机构，没有使用限制，所有人都可以注册
- `.NET`：最开始用于网络组织，如服务商和维修商，现在没有使用限制，所有人都可以注册
- `.TOP`：用于行业内的顶级企业或个人，所有人都可以注册
- `.ORG`：用于各种组织，如非盈利组织、教育组织等，现在所有人都可以注册

## 权限域名服务器

按照上面的逻辑，权限域名服务器应该是管理注册在二级域名下的所有三/四级域名的，但其实不是这样，如果一个二级域名或者一个三/四级域名对应一个域名服务器，则域名服务器数量会很多，我们需要使用**划分区**的办法来解决这个问题。那么权限域名服务器就是负责管理一个“**区**”的域名服务器。

❓ 什么是区？怎样划分区呢？

区和域其实是不同的，区可以有多种不同的划分方法。以百度为例，我们假设有 `fanyi.baidu.com`、`ai.baidu.com`、`tieba.baidu.com` 这三个三级域名。我们可以这样分区，`fanyi.baidu.com` 和 `tieba.baidu.com` 放在 `baidu.com` 权限域名服务器，`ai.baidu.com` 放在 `ai.baidu.com` 权限域名服务器中。并且 `baidu.com` 权限域名服务器和 `ai.baidu.com` 权限域名服务器是**同等地位**的，而具体怎么分区是百度公司根据域名多少、访问多少等情况去自己规定的。

画个图直观理解一下：

![dns13](.\images\dns13.png)

## 本地域名服务器

除了上面三种 `DNS` 服务器，还有一种不在 `DNS`  层次结构之中，但是很重要的 `DNS` 服务器，就是**本地域名服务器**（也被称为**权威域名服务器**）。本地域名服务器是电脑解析时的**默认**域名服务器，即电脑中设置的首选 `DNS` 服务器和备选 `DNS` 服务器。常见的有电信、联通、谷歌、阿里等的本地 `DNS` 服务。

![dns14](.\images\dns14.png)

本地域名服务器一般在你的城市的某个角落，范围非常广，没有一个详细的定位，距离你不会很远，可能是某个运营商部署在该城市的一台服务器，也可能是某个公司的一台服务器，甚至可能是某个学校的某一台服务器，不必深究概念，只要知道有这样一台服务器就行。并且这台服务器的性能都很好，一般都会缓存域名解析结果，大约80%的域名解析到这里就完成了。

本地服务器不属于域名服务器的层次结构，但是它对域名系统非常重要。当一个主机发出`DNS`查询请求时，这个查询请求报文就发送给本地域名服务器。

每个因特网服务提供者或一所大学，甚至一所大学中的各个系，都可以拥有一个本地域名服务器。**当一台主机发出 `DNS` 查询请求时，这个查询请求报文就发送给该主机的本地域名服务器**。**本地域名服务器管理本地域名的解析和映射，并且能够向上级域名服务器进行查询**。

那么具体本地域名服务器是如何向上级域名服务器转发查询请求的呢？

# 五、``DNS``服务的体系架构是怎样的？ #

`DNS`是应用层协议，事实上它是为其他应用层协议工作的，包括不限于`HTTP`和`SMTP`以及`FTP`，用于将用户提供的主机域名解析为``IP``地址。

假设运行在用户主机上的某些应用程序（如`Webl`浏览器或者邮件阅读器）需要将主机名转换为`IP`地址。这些应用程序将调用`DNS`的客户机端，并指明需要被转换的主机名。用户主机的`DNS`客户端接收到后，向网络中发送一个`DNS`查询报文。所有`DNS`请求和回答报文使用的`UDP`数据报经过端口53发送，经过若干`ms`到若干`s`的延时后，用户主机上的`DNS`客户端接收到一个提供所希望映射的`DNS`回答报文。这个查询结果则被传递到调用`DNS`的应用程序。因此，从用户主机上调用应用程序的角度看，`DNS`是一个提供简单、直接的转换服务的黑盒子。但事实上，实现这个服务的黑盒子非常复杂，它由分布于全球的大量`DNS`服务器以及定义了`DNS`服务器与查询主机通信方式的应用层协议组成。

具体过程如下：

- 用户主机上运行着``DNS``的客户端，就是我们的`PC`机或者手机客户端运行着``DNS``客户端
- 浏览器将接收到的`url`中抽取出域名字段，就是访问的主机名，比如 `http://www.baidu.com/`, 并将这个主机名传送给``DNS``应用的客户端
- ``DNS``客户机端向``DNS``服务器端发送一份查询报文，报文中包含着要访问的主机名字段（中间包括一系列缓存查询以及分布式``DNS``集群的工作）
- 该``DNS``客户机最终会收到一份回答报文，其中包含有该主机名对应的``IP``地址
- 一旦该浏览器收到来自``DNS``的``IP``地址，就可以向该``IP``地址定位的`HTTP`服务器发起`TCP`连接

# 六、`DNS`的过程？ #

## 递归查询与迭代查询的区别

#### 递归查询

**主机向本地域名服务器的查询一般都是采用递归查询。**所谓递归查询就是：如果主机所询问的本地域名服务器不知道被查询的域名的`IP`地址，那么本地域名服务器就以`DNS`客户的身份，向其它根域名服务器继续发出查询请求报文(即替主机继续查询)，而不是让主机自己进行下一步查询。因此，递归查询返回的查询结果或者是所要查询的`IP`地址，或者是报错，表示无法查询到所需的`IP`地址。

#### 迭代查询

**`DNS`服务器之间属迭代查询。**迭代查询的特点：当根域名服务器收到本地域名服务器发出的迭代查询请求报文时，要么给出所要查询的`IP`地址，要么告诉本地服务器：“你下一步应当向哪一个域名服务器进行查询”。然后让本地服务器进行后续的查询。根域名服务器通常是把自己知道的顶级域名服务器的`IP`地址告诉本地域名服务器，让本地域名服务器再向顶级域名服务器查询。顶级域名服务器在收到本地域名服务器的查询请求后，要么给出所要查询的`IP`地址，要么告诉本地服务器下一步应当向哪一个权限域名服务器进行查询。最后，知道了所要解析的`IP`地址或报错，然后把这个结果返回给发起查询的主机。

## `DNS`缓存

为了提升域名查询效率，`DNS`也有它自己的缓存机制，当访问过某个网站并得到其`IP`地址后，会将其域名与`IP`缓存下来，下一次访问的时候，就不需要再请求域名服务器获取`IP`，直接使用缓存中的`IP`，提高响应速度。当缓存的有效时间（`TTL`）过了，再次请求网站，还是需要先请求域名解析。

有`DNS`的地方,就有缓存。浏览器、操作系统、`Local DNS`、根域名服务器，它们都会对`DNS`结果做一定程度的缓存。

## 举例说明域名解析过程

![dns1](.\images\dns1.png)

在`DNS`查询过程中，客户端和服务器也都会加入缓存的机制(将已经查询到的 `IP`用小本本记录下来)，这样可以减少查询的次数，加快域名解析过程。

如果某个用户正在用浏览器`mail.baidu.com`的网址，当你敲下回车键的一瞬间，会发生如下过程：

- 检查**浏览器缓存**中是否存在该域名与`IP`地址的映射关系，如果有则解析结束，没有则继续。

  > **浏览器缓存**：浏览器在获取网站域名的实际 `IP` 地址后会对其进行缓存，减少网络请求的损耗。每种浏览器都有一个固定的 `DNS` 缓存时间，如 `Chrome` 的过期时间是 1 分钟，在这个期限内不会重新请求 `DNS`

- 当浏览器缓存中无域名对应`IP`，则会到**系统本地**查找映射关系，一般在`hosts`文件中，操作系统会检查本地的`hosts`文件是否有这个网址映射关系，如果有则解析结束，否则继续。

  > **操作系统缓存**：操作系统的缓存其实是用户自己配置的 `hosts` 文件。比如 `Windows10` 下的 `hosts` 文件存放在 `C:\Windows\System32\drivers\etc\hosts`
  >
  > ![dns15](.\images\dns15.png)
  >
  > `Windows` 系统默认开启 `DNS` 缓存服务，服务名是 `DNSClient`，可以缓存一些常用的域名。
  >
  > ![dns16](.\images\dns16.png)
  >
  > 使用命令 `ipconfig/displaydns` 可以查看电脑中缓存的域名。
  >
  > ![dns17](.\images\dns17.png)

- 当浏览器及系统缓存中均无域名对应`IP`则进入**路由器缓存**中检查，以上三步均为客服端的`DNS`缓存；

- 当以上均未命中 ，客户端会向本地`DNS`服务器发起查询。本地`DNS`服务器收到查询时，如果要查询的域名包含在本地配置区域资源中，则返回解析结果给客户机，完成域名解析。如果本地`DNS`器本地区域文件与缓存解析都失效，则查询根域名服务器。

- **本地域名服务器**查询**根域名服务器**，根域名服务器是最高层次的，它并不会直接指明这个域名对应的 `IP` 地址，而是返回顶级域名服务器的地址，也就是说给本地域名服务器指明一条道路，让他去这里寻找答案。

- 本地域名服务器拿到这个**顶级域名服务器**的地址后，就向其发起请求，获取**权限域名服务器**的地址

- **查询到权威域名服务器之后，任意层级的域名都会在这里解析（所以叫权威域名服务器）。**本地域名服务器根据权限域名服务器的地址向其发起请求，最终得到该域名对应的 `IP` 地址。

- 本地域名服务器把返回的`IP` 地址保存到缓存，方便下次查询或其他用户查找，同时将该结果反馈给客户端，客户端通过这个`IP`地址与`web`服务器建立链接。

- 如果还有下级服务器，则依此方法进行查询，直至返回映射关系或报错

像该过程中的第4点，仅限于在`本地域名服务器`中查找，如果有则直接返回映射关系，否则就以`DNS`客户的身份去其他`DNS`服务器中查询，这种查询方式我们叫做**递归查询**。

第5、6、7、8过程，他们只会给出下级`DNS`服务器的地址，并不会直接返回映射关系，这种查询方式叫做**迭代查询**

本机查找完缓存后如果没有结果，会先查找`hosts`文件，如果没有找到再把查询发送给`DNS`服务器，但这仅仅是默认情况，这个默认顺序是可以改变的。在`/etc/nsswitch.conf`中有一行" `hosts: files DNS`"就是定义先查找`hosts`文件还是先提交给`DNS`服务器的，如果修改该行为"`hosts: DNS files`"则先提交给`DNS`服务器，这种情况下`hosts`文件几乎就不怎么用的上了。

由于缓存是多层次缓存的，所以真正的查询可能并没有那么多步骤，上图的步骤是完全没有所需缓存的查询情况。假如某主机曾经向`DNS`服务器提交了`www.baidu.com`的查询，那么在`DNS`服务器上除了缓存了 `www.baidu.com`的记录，还缓存了"`.com`"和"`baidu.com`"的记录，如果再有主机向该`DNS`服务器提交`ftp.baidu.com`的查询，那么将跳过".“和”.com"的查询过程直接向`baidu.com`发出查询请求。

# 七、`DNS`缓存

为了缓解各个域名服务器的查询压力和加快 `DNS` 查询速度，浏览器、操作系统、域名服务器都会将 `DNS` 的查询结果进行缓存，当在缓存有效时间内再次收到重复的 `DNS` 请求时，就会直接返回 `IP` 地址，而不会继续下一步的域名查询了。

缓存的优先级由 `DNS` 查询的路径来定，相信这个很好理解

浏览器缓存>操作系统缓存> `hosts` 文件>本地`DNS` 服务器缓存>根域名服务器缓存>...

## 缓存时长如何控制

缓存时间一般由 `DNS`响应报文 中 资源记录部分 中的 `TTL` (`Time to live`)指定的值，单位为秒

```yaml
    baidu.com: type A, class IN, addr 220.181.57.216         #资源记录部分
        Name: baidu.com                                      #域名字段, 这里请求的域名为baidu.com
        Type: A (Host Address) (1)                           #类型字段, 这里为A类型
        Class: IN (0x0001)                                   #类字段
        Time to live: 5                                      #生存时间
        Data length: 4                                       #数据长度
        Address: 220.181.57.216                              #资源数据, 这里为IP地址
```

但是有些浏览器或者操作系统会因为 `TTL` 值过小或者其他的原因不遵守 `TTL` 约定的缓存时间。这也导致很多缓存问题的 `TTL` 解决方案失效。

> `hosts`文件并不是缓存，所以它是永久有效的

# 八、`DNS`使用`UDP`还是`TCP`

`DNS` 同时使用 `TCP` 和 `UDP` 协议的 `53` 号端口。这种单个应用协议同时使用两种传输协议的情况在 `TCP/IP` 栈也算是个另类。但很少有人知道 `DNS` 分别在什么情况下使用这两种协议。

`DNS` 在 区域传输 （同步解析记录）和 `DNS` 响应大于 `UDP` 报文最大长度的时候使用 `TCP` 协议，其他时候使用 `UDP` 协议。

## 为什么使用`UDP`

快，是`UDP`的最大优势

客户端向 `DNS` 服务器查询域名，一般返回的内容都不超过 `512字节` ，用 `UDP` 传输即可。不用经过三次握手，这样 `DNS` 服务器负载更低，响应更快。

理论上说，客户端也可以指定向 `DNS` 服务器查询时用 `TCP`，但事实上，很多 `DNS` 服务器进行配置的时候，仅支持 `UDP` 查询包。

## 何时使用TCP

#### **传输数据大于`UDP`最大报文长度的时候使用TCP协议：**

首先了解一下 `TCP` 与 `UDP` 传送字节的长度限制：

`UDP` 报文的最大长度为 `512` 字节，而 `TCP` 则允许报文长度超过 `512` 字节。当 `DNS` 查询超过 `512` 字节时会将后面的数据部分丢掉，所以这时需要使用 `TCP` 发送。但是通常传统的 `UDP` 报文一般不会大于 `512` 字节。即使 `DNS` 服务器中符合条件的记录很多， `DNS` 服务器也会限制最多返回 `13条` 来防止报文大于 `512` 字节。

#### **`DNS`区域传输的时候使用TCP协议：**

> `DNS`的规范规定了 2 种类型的 `DNS` 服务器，一个叫 主 `DNS`  服务器，一个叫 辅助`DNS` 服务器。 在一个 区中 主 `DNS` 服务器从自己本机的数据文件中读取该区的 `DNS` 数据信息，而 辅助`DNS` 服务器则从区的 主 `DNS` 服务器中读取该区的 `DNS` 数据信息。当一个 辅助 `DNS` 服务器 启动时，它需要与 主 `DNS` 服务器 通信，并加载数据信息，这就叫做 区传送（`zone transfer`）。
>
> `DNS 区域传送`（`DNS zone transfer`）指的是一台备用服务器使用来自主服务器的数据刷新自己的域（zone）数据库，目的是为了做冗余备份，防止主服务器出现故障时 `dns` 解析不可用。

辅域名服务器会定时（一般 3 小时）向主域名服务器进行查询以便了解数据是否有变动。如有变动，会执行一次区域传输，进行数据同步。区域传输使用 `TCP` 而不是 `UDP`，因为数据同步传送的数据量比一个请求应答的数据量要多得多，且需要保证数据的 可靠性 和 完整性。

> `DNS`区域(`ZONE`)：`DNS`域名空间中连续的树，将域名空间按照需要划分为若干较小的管理单位。
>
> `DNS`服务器中，必须先建立区域，在区域中建立子域，在区域或者子域中添加主机记录。
>
> 存储区域数据的文件，称为区域文件。一台`DNS`服务器上可以存放多个区域文件，同一个区域文件也可以存放在多台`DNS`服务器上。
>
> 区域文件包含主机名和对应`IP`地址、刷新间隔和过期时间等信息。

区域文件通常只配置一个域名，区域名字即为域名。它可以包含多个记录。它的表达形式为 ：一条记录就是一条从资源到名字的单一映射。

# 九、`DNS` 带来的问题

上面详细的讲述了`DNS`  解析过程，在这个过程中客户端和服务端都会加入缓存机制，这可能会导致如下问题：

> 网站所有者已将网站迁移到新`DNS` （和`IP`地址）的其他服务器，则由于本地计算机缓存了老的服务器的`DNS` ，您可能仍会看到旧服务器上的网站。要从新服务器获取网站最新内容，您需要清除你本地电脑的`DNS` 缓存。有时缓存存储时间较长，在清除缓存之前，您将无法看到新的网站内容。

## 清除 `DNS` 缓存的方法

#### 通过清除 `Web` 浏览器强制刷新网页

在刷新`DNS`之前，您可以尝试强制刷新要访问的网页。 这将清除网页缓存，帮助浏览器查找网页的更新文件。

- `Windows`操作系统：`Internet Explorer`，`Microsoft Edge`，`Mozilla Firefox`或`Google Chrome`，使用组合键“`Ctrl + F5`”。
- `Apple/MAC`计算机：`Mozilla Firefox`或`Google Chrome`，使用组合键“`CMD + SHIFT + R`”。如果您使用`Apple Safari`，则使用组合键“`SHIFT + Reload`”。

还可以尝试使用隐身模式（`Chrome`）或隐私窗口（`Firefox`）访问该页面。如果这个方式无效我们可以试试从操作系统的层面上去清除缓存。

#### `Windows`

1、进入命令提示符模式：

- 使用键盘组合键`Windows+R`

- 弹窗`Run`窗口

  ![dns4](.\images\dns4.png)

- 在输入框中键入`CMD`
- `Enter`键确定将打开命令提示符窗口

2、输入 `ipconfig/flushdns`并按`Enter`键，如下所示

![dns5](.\images\dns5.png)

3、窗户提示`DNS Flush`的成功信息

![dns6](.\images\dns6.png)

#### `Mac`

1. 打开 `Terminal`(终端)

2. 执行以下命令清除计算机上的 `DNS` 缓存

   ```
   sudo killall -HUP mDNSResponder && echo macOS DNS Cache Reset
   ```

   

3. 注意以上命令因操作系统版本而异，各版本对应的命令如下所示：

   1. ```
      1. Mac OS Sierra, Mac OS X El Capitan, Mac OS X Mavericks, Mac OS X Mountain Lion, Mac OS X Lion操作系统使用以下命令
      
         sudo killall -HUP mDNSResponder
      
      2. Mac OS X Yosemite操作系统使用以下命令
      
         sudo discoveryutil udnsflushcaches
      
      3. Mac OS X Snow Leopard操作系统使用以下命令
      
         sudo dscacheutil -flushcache
      
      4. Mac OS X Leopard and below操作系统使用以下命令
      
         sudo lookupd -flushcache
      ```

      

#### `Linux`

**在`Ubuntu Linux`和`Linux Mint`上：**

1. 使用键盘组合键`Ctrl+Alt+T`打开终端

2. 启动终端后，输入以下命令代码

   ```
   sudo /etc/init.d/networking restart
   ```

   

![dns7](.\images\dns7.png)

1. 它可能会要求输入管理员密码

2. 一旦成功，它将显示如下确认消息：

   ```
   [OK] Restarting networking **(\**via systemctl\**)**: networking.service
   ```

3. 如果`DNS Flush`不成功，请按照以下步骤操作

4. 在终端输入以下命令

   ```
   sudo apt install nscd
   ```

5. 完成上述命令后，重复步骤1到4

#### `CentOS`

1. 使用键盘组合键`Ctrl+Alt+T`打开终端

2. 输入以下命令：

   ```
   nscd -i hosts
   ```

   

3. 要重新启动`DNS`服务，请输入以下命令

   ```
   service nscd restart
   ```

   

![dns8](.\images\dns8.png)



# 十、`DNS`分类 #

* 主`DNS`服务器： 就是一台存储着原始资料的`DNS`服务器。
* 从`DNS`服务器： 使用自动更新方式从主`DNS`服务器同步数据的`DNS`服务器。也称辅助`DNS`服务器。
* 缓存服务器： 不负责本地解析，采用递归方式转发客户机查询请求，并返回结果给客户机的`DNS`服务器。同时缓存查询回来的结果，也叫递归服务器。
* 转发器： 这台`DNS`发现非本机负责的查询请求时，不再向根域发起请求，而是直接转发给指定的一台或者多台服务器。自身并不缓存查询结果。

# 十一、`DNS`解析记录类型

域名解析本质上是将域名指向一个`IP`地址，配置了域名与`IP`地址的对应关系后，我们就完成了所谓的`DNS`记录配置。其中常见的`DNS`记录类型包括：

| 记录类型        | 作用                                     | 描述                                                         |
| --------------- | ---------------------------------------- | ------------------------------------------------------------ |
| **`A`记录**     | 映射域名到`IPv4`地址                     | 例如，`example.com` 解析到 `192.0.2.1`                       |
| **`AAAA`记录**  | 映射域名到`IPv6`地址                     | 例如，`example.com` 解析到 `2001:0db8:85a3:0000:0000:8a2e:0370:7334` |
| **`MX`记录**    | 邮件交换记录，指定邮件服务器地址         | 例如，`example.com` 的邮件服务器是 `mail.example.com`        |
| **`CNAME`记录** | 别名记录，将一个域名映射到另一个域名     | 例如，`www.example.com` 被重定向到 `example.com`             |
| **`NS`记录**    | 指定域名的权威名称服务器                 | 例如，`example.com` 使用 `ns1.exampledns.com` 作为名称服务器 |
| **`TXT`记录**   | 存储任意文本数据，用于多种验证和配置目的 | 例如，验证域名所有权或配置`SPF`、`DKIM`等                    |
| **`PTR`记录**   | 反向`DNS`解析记录，从`IP`地址映射回域名  | 用于反向查找，通常用于邮件服务器的反垃圾邮件措施             |

类型 A 就是查询到了域名对应的 IP，可以直接告诉客户端。

类型 NS 是需要去另一台 DNS 服务器做解析，比如顶级域名服务器需要进一步去权威域名服务器解析。

CNAME 是给当前域名起个别名，两个域名会解析到同样的 IP。

PTR 是由 IP 查询域名用的，DNS 是支持反向解析的

而 MX 是邮箱对应的域名或者 IP，用于类似 @xxx.com 的邮件地址的解析。

当 DNS 服务器接收到 DNS 协议数据就会去这个记录表里查找对应的记录，然后通过 DNS 协议的格式返回。

# 十二、利用`DNS`解析记录的攻击手法

| 攻击类型                                 | 攻击方式描述                                                 | 影响                                                   | 防御措施                                                     |
| ---------------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------ | ------------------------------------------------------------ |
| **`DNS`欺骗（`DNS`Spoofing）**           | 攻击者伪造`DNS`响应，将受害者的请求重定向到恶意服务器。      | 使受害者访问恶意网站，可能导致数据泄露或恶意软件下载。 | 使用`DNSSEC`加密`DNS`通信，验证`DNS`记录的真实性；启用`DNS`缓存保护。 |
| **`DNS`放大攻击（`DNS Amplification`）** | 攻击者利用公开的`DNS`服务器进行反射式`DDoS`攻击，通过发送小量请求引发大量响应，从而放大攻击流量。 | 使目标服务器过载，导致拒绝服务（`DoS`）攻击。          | 配置防火墙来限制`DNS`请求来源，禁用开放解析，部署`DDoS`防护。 |
| **`DNS`隧道（`DNS Tunneling`）**         | 攻击者通过`DNS`查询和响应通道传递恶意数据，绕过防火墙或网络监控。 | 绕过防火墙进行数据泄露或远程命令执行。                 | 配置`DNS`流量监控，阻止非正常`DNS`流量，使用`DNS`隧道检测工具。 |
| **域名劫持**                             | 攻击者修改域名的`DNS`记录（如A记录、`MX`记录）将流量重定向到恶意服务器或伪造邮件服务器。 | 数据泄露，邮件被截取或篡改，用户访问恶意网站。         | 配置强密码和双因素认证，定期检查域名注册和`DNS`记录，启用域名保护服务。 |
| **缓存投毒（`Cache Poisoning`）**        | 攻击者向`DNS`缓存中插入恶意或伪造的`DNS`记录，使得合法域名解析到恶意`IP`地址。 | 用户访问恶意网站或服务。                               | 启用`DNSSEC`，验证缓存记录的完整性，使用防毒`DNS`解析服务。  |
| **`DNS`回溯攻击**                        | 攻击者通过反向`DNS`解析（`PTR`记录）**获取目标网络中的详细信息**，例如邮件服务器的实际`IP`地址或特定主机信息。 | 攻击者可以基于这些信息发起进一步的攻击。               | 使用反向`DNS`记录隐私保护，定期审查`PTR`记录，配置反向查询限制。 |
| **`DNS`泄露**                            | 攻击者通过非加密通道获取`DNS`请求内容，泄露目标用户访问的域名信息，可能暴露用户行为或敏感信息。 | **泄露用户上网行为**，可能引发隐私泄露。               | 启用`DNS`加密（如`DNS over HTTPS`或`DNS over TLS`）。        |



