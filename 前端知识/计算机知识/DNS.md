# 一、什么是`DNS`？

`DNS`往往是网络请求的第一步，在互联网上，通信是基于`TCP/IP`协议来进行的，如果`TCP|UDP`定义了数据传输的方式，那么通过`IP`协议，我们就可以知道数据传输的地点。 不过日常我们也是可以通过域名去访问对应的地址，而事实上只有`IP`地址才可以寻找到对应服务器，因此当你使用域名去访问，首先经历的是一个域名解析的过程，将域名转换成对应的`IP`地址，再去寻址。**它实质上是一个域名和 `IP`相互映射的分布式数据库，有了它我们就可以通过域名更方便的访问互联网。** `DNS`有以下特点:

- 分布式的
- 协议支持`TCP` 和 `UDP`, 常用端口是53
- 每一级域名的长度限制是63
- 域名总长度限制是253

# 二、为什么要使用`DNS` #

- 网络通讯大部分是基于`TCP/IP`的，而`TCP/IP`是基于``IP``地址的，所以计算机在网络上进行通讯时只能识别如“202.96.134.133”之类的``IP``地址，而不能认识域名。我们无法记住10个以上``IP``地址的网站，所以我们访问网站时，更多的是在浏览器地址栏中输入域名，就能看到所需要的页面，这是因为有一个叫“``DNS``服务器”的计算机自动把我们的域名“翻译”成了相应的``IP``地址，然后调出``IP``地址所对应的网页。

- 简单的说，通过域名，最终得到该域名对应的``IP``地址的过程叫做域名解析（或主机名解析）。**想要访问一台服务器，最终是靠`IP`地址访问的，而不是靠域名访问的。**

		`www.dnscache.com`  (域名)  - ``DNS``解析 --> 11.222.33.444 (``IP``地址)

- ``DNS``协议运行在`UDP`协议之上，使用端口号53。

# 三、域名服务器

`DNS`域名系统是一个四层树状结构的分布式系统，分别包括：本地域名服务器、跟域名服务器、顶级域名服务器、权威域名服务器

![dns2](.\images\dns2.png)

## 根域名服务器

在2016年之前全球一共拥有13台根服务器，1台主根服务器在美国，其他12台为辅根服务器，其中美国9台，英国1台，瑞典1台，日本1台，这13台根服务器主要管理互联网的主目录，主要作用`IPV4`。

2016年，中国下一代互联网工程中心领衔发起雪人计划，旨在为下一代互联网(`IPV6`)提供更多的根服务器解决方案，该计划于2017年完成，其中包含3台主根服务器，中国1台，美国1台，日本1台，22台辅根服务器，中国3台，美国2台，印度和法国分别有3台，德国2台，俄罗斯、意大利、西班牙、奥地利、智利、南非、澳大利亚、瑞士、荷兰各1台，共22台，从此形成了13台原有根服务器加25台`IPV6`根服务器的新格局。

![dns3](.\images\dns3.png)

​	

最高层次的域名服务器，也是最重要的域名服务器。所有的根域名服务器都知道所有的顶级域名服务器的域名和`IP`地址。不管是哪一个本地域名服务器，若要对因特网上任何一个域名进行解析，只要自己无法解析，就首先求助根域名服务器。所以根域名服务器是最重要的域名服务器。假定所有的根域名服务器都瘫痪了，那么整个`DNS`系统就无法工作。需要注意的是，在很多情况下，根域名服务器并不直接把待查询的域名直接解析出`IP`地址，而是告诉本地域名服务器下一步应当找哪一个顶级域名服务器进行查询。

- (2)顶级域名服务器

  - 负责管理在该顶级域名服务器注册的二级域名。

- (3)权限域名服务器

  - 负责一个“区”的域名服务器。

- (4)本地域名服务器

  - 本地服务器不属于域名服务器的层次结构，但是它对域名系统非常重要。当一个主机发出`DNS`查询请求时，这个查询请求报文就发送给本地域名服务器。

# 三、`DNS`的过程？ #

![dns1](.\images\dns1.png)







- `DNS`是应用层协议，事实上他是为其他应用层协议工作的，包括不限于`HTTP`和`SMTP`以及`FTP`，用于将用户提供的主机名解析为``IP``地址。
- 具体过程如下：

  - 用户主机上运行着``DNS``的客户端，就是我们的`PC`机或者手机客户端运行着``DNS``客户端
  - 浏览器将接收到的`url`中抽取出域名字段，就是访问的主机名，比如 `http://www.baidu.com/`, 并将这个主机名传送给``DNS``应用的客户端
  - ``DNS``客户机端向``DNS``服务器端发送一份查询报文，报文中包含着要访问的主机名字段（中间包括一系列缓存查询以及分布式``DNS``集群的工作）
  - 该``DNS``客户机最终会收到一份回答报文，其中包含有该主机名对应的``IP``地址
  - 一旦该浏览器收到来自``DNS``的``IP``地址，就可以向该``IP``地址定位的`HTTP`服务器发起`TCP`连接

# 三、``DNS``服务的体系架构是怎样的？ #

- 主要作用就是将主机域名转换为`IP`地址
- 假设运行在用户主机上的某些应用程序（如`Webl`浏览器或者邮件阅读器）需要将主机名转换为`IP`地址。这些应用程序将调用``DNS``的客户机端，并指明需要被转换的主机名。用户主机的`DNS`客户端接收到后，向网络中发送一个`DNS`查询报文。所有`DNS`请求和回答报文使用的`UDP`数据报经过端口53发送，经过若干`ms`到若干`s`的延时后，用户主机上的`DNS`客户端接收到一个提供所希望映射的`DNS`回答报文。这个查询结果则被传递到调用`DNS`的应用程序。因此，从用户主机上调用应用程序的角度看，`DNS`是一个提供简单、直接的转换服务的黑盒子。但事实上，实现这个服务的黑盒子非常复杂，它由分布于全球的大量`DNS`服务器以及定义了`DNS`服务器与查询主机通信方式的应用层协议组成。

#### 四、域名服务器 ####

- (1)根域名服务器

  - 最高层次的域名服务器，也是最重要的域名服务器。所有的根域名服务器都知道所有的顶级域名服务器的域名和`IP`地址。不管是哪一个本地域名服务器，若要对因特网上任何一个域名进行解析，只要自己无法解析，就首先求助根域名服务器。所以根域名服务器是最重要的域名服务器。假定所有的根域名服务器都瘫痪了，那么整个`DNS`系统就无法工作。需要注意的是，在很多情况下，根域名服务器并不直接把待查询的域名直接解析出`IP`地址，而是告诉本地域名服务器下一步应当找哪一个顶级域名服务器进行查询。

- (2)顶级域名服务器

   - 负责管理在该顶级域名服务器注册的二级域名。

- (3)权限域名服务器

   - 负责一个“区”的域名服务器。

- (4)本地域名服务器

   - 本地服务器不属于域名服务器的层次结构，但是它对域名系统非常重要。当一个主机发出`DNS`查询请求时，这个查询请求报文就发送给本地域名服务器。

#### 五、域名的解析过程 ####

- (1)递归查询

   - 主机向本地域名服务器的查询一般都是采用递归查询。所谓递归查询就是：如果主机所询问的本地域名服务器不知道被查询的域名的`IP`地址，那么本地域名服务器就以`DNS`客户的身份，向其它根域名服务器继续发出查询请求报文(即替主机继续查询)，而不是让主机自己进行下一步查询。因此，递归查询返回的查询结果或者是所要查询的`IP`地址，或者是报错，表示无法查询到所需的`IP`地址。

- (2)迭代查询

  - 本地域名服务器向根域名服务器的查询的迭代查询。迭代查询的特点：当根域名服务器收到本地域名服务器发出的迭代查询请求报文时，要么给出所要查询的`IP`地址，要么告诉本地服务器：“你下一步应当向哪一个域名服务器进行查询”。然后让本地服务器进行后续的查询。根域名服务器通常是把自己知道的顶级域名服务器的`IP`地址告诉本地域名服务器，让本地域名服务器再向顶级域名服务器查询。顶级域名服务器在收到本地域名服务器的查询请求后，要么给出所要查询的`IP`地址，要么告诉本地服务器下一步应当向哪一个权限域名服务器进行查询。最后，知道了所要解析的`IP`地址或报错，然后把这个结果返回给发起查询的主机。

- (3)举例说明域名解析过程

   * 在浏览器中输入`www . qq .com` 域名，操作系统会先检查自己本地的hosts文件是否有这个网址映射关系，如果有，就先调用这个`IP`地址映射，完成域名解析。
   * hosts文件没有就去查本地`DNS`解析器有没有缓存。
   * 如果hosts与本地`DNS`解析器缓存都没有相应的网址映射关系，首先会找`TCP/IP`参数中设置的首选`DNS`服务器，在此我们叫它本地`DNS`服务器，此服务器收到查询时，如果要查询的域名，包含在本地配置区域资源中，则返回解析结果给客户机，完成域名解析，此解析具有权威性。 
   * 如果要查询的域名，不由本地`DNS`服务器区域解析，但该服务器已缓存了此网址映射关系，则调用这个`IP`地址映射，完成域名解析，此解析不具有权威性。
   * 如果本地`DNS`服务器本地区域文件与缓存解析都失效[ 注：当`DNS`服务器在接收到`DNS`客户端的查询请求后，它将在所管辖区域的数据库中寻找是否有该客户端的数据。如果该`DNS`服务器的区域中没有该客户端的数据（在`DNS`服务器所在管辖区域数据库中没有该`DNS`客户端所查询的主机名）时，该`DNS`服务器需要转向其他的`DNS`服务器进行查询。`DNS`服务器可以解析自己区域文件中的域名，对于本服务器查询不了的域名，默认情况下是将直接转发查询请求到根域`DNS`服务器。除此之外还有一种方法，在`DNS`服务器上设置转发器将请求转发给其他`DNS`服务器。转发到转发器的查询一般为递归查询。则根据本地`DNS`服务器的设置（是否设置转发器）进行查询，如果未用转发模式，本地`DNS`就把请求发至13台根`DNS`，根`DNS`服务器收到请求后会判断这个域名(`.com`)是谁来授权管理，并会返回一个负责该顶级域名服务器的一个`IP`。本地`DNS`服务器收到`IP`信息后，将会联系负责`.com`域的这台服务器。这台负责.com域的服务器收到请求后，如果自己无法解析，它就会找一个管理`.com`域的下一级`DNS`服务器地址(`http://qq.com`)给本地`DNS`服务器。当本地`DNS`服务器收到这个地址后，就会找`http://qq.com`域服务器，重复上面的动作，进行查询，直至找到`www . qq .com`主机。
   * 如果用的是转发模式，此`DNS`服务器就会把请求转发至上一级`DNS`服务器，由上一级服务器进行解析，上一级服务器如果不能解析，或找根`DNS`或把转请求转至上上级，以此循环。不管是本地`DNS`服务器用是是转发，还是根提示，最后都是把结果返回给本地`DNS`服务器，由此`DNS`服务器再返回给客户机。

   * **注：**
     * 本机查找完缓存后如果没有结果，会先查找`hosts`文件，如果没有找到再把查询发送给`DNS`服务器，但这仅仅是默认情况，这个默认顺序是可以改变的。在`/etc/nsswitch.conf`中有一行" `hosts: files DNS`"就是定义先查找`hosts`文件还是先提交给`DNS`服务器的，如果修改该行为"`hosts: DNS files`"则先提交给`DNS`服务器，这种情况下`hosts`文件几乎就不怎么用的上了。
      * 由于缓存是多层次缓存的，所以真正的查询可能并没有那么多步骤，上图的步骤是完全没有所需缓存的查询情况。假如某主机曾经向`DNS`服务器提交了`www.baidu.com`的查询，那么在`DNS`服务器上除了缓存了 `www.baidu.com`的记录，还缓存了"`.com`"和"`baidu.com`"的记录，如果再有主机向该`DNS`服务器提交`ftp.baidu.com`的查询，那么将跳过".“和”.com"的查询过程直接向`baidu.com`发出查询请求。
     
    * `DNS`解析过程中存在两种查询类型：递归查询（从客户机至指定`DNS`服务器）、迭代查询（从`DNS`服务器至各个域）。

#### 六、解析顺序 ####

* 浏览器缓存

　　当用户通过浏览器访问某域名时，浏览器首先会在自己的缓存中查找是否有该域名对应的`IP`地址（若曾经访问过该域名且没有清空缓存便存在）；
　
* 系统缓存

　　当浏览器缓存中无域名对应`IP`则会自动检查用户计算机系统Hosts文件`DNS`缓存是否有该域名对应`IP`；

* 路由器缓存

　　当浏览器及系统缓存中均无域名对应`IP`则进入路由器缓存中检查，以上三步均为客服端的`DNS`缓存；

* `ISP`（互联网服务提供商）`DNS`缓存

　　当在用户客服端查找不到域名对应`IP`地址，则将进入`ISP DNS`缓存中进行查询。比如你用的是电信的网络，则会进入电信的`DNS`缓存服务器中进行查找；

* 根域名服务器

　　当以上均未完成，则进入根服务器进行查询。全球仅有13台根域名服务器，1个主根域名服务器，其余12为辅根域名服务器。根域名收到请求后会查看区域文件记录，若无则将其管辖范围内顶级域名（如`.com`）服务器`IP`告诉本地`DNS`服务器；

* 顶级域名服务器

　　顶级域名服务器收到请求后查看区域文件记录，若无则将其管辖范围内主域名服务器的`IP`地址告诉本地`DNS`服务器；

* 主域名服务器
　　主域名服务器接受到请求后查询自己的缓存，如果没有则进入下一级域名服务器进行查找，并重复该步骤直至找到正确纪录；

* 保存结果至缓存

　　本地域名服务器把返回的结果保存到缓存，以备下一次使用，同时将该结果反馈给客户端，客户端通过这个`IP`地址与`web`服务器建立链接。

#### 七、`DNS`分类 ####

* 主`DNS`服务器： 就是一台存储着原始资料的`DNS`服务器。
* 从`DNS`服务器： 使用自动更新方式从主`DNS`服务器同步数据的`DNS`服务器。也成辅助`DNS`服务器。
* 缓存服务器： 不负责本地解析，采用递归方式转发客户机查询请求，并返回结果给客户机的`DNS`服务器。同时缓存查询回来的结果，也叫递归服务器。
* 转发器： 这台`DNS`发现非本机负责的查询请求时，不再向根域发起请求，而是直接转发给指定的一台或者多台服务器。自身并不缓存查询结果。

#### 八、解析记录 ####

- (1)`A`记录：最简单最常用，添加记录时候填写`IP`地址即可。`A`记录(`Address`)是用来指定主机名（或域名）对应的`IP`地址记录。通过A记录您可以将该域名指向到自己的网站服务器`IP`地址，同时也可以设置您域名的二级域名。 
- (2)`MX`记录：是`Mail Exchanger`的缩写，意思是邮件交换记录。它指向一个邮件服务器，用于电子邮件系统发邮件时根据收信人的地址后缀来定位邮件服务器。例如，当`Internet`上的某用户要发一封信给 `user@vIPiis.com`时，该用户的邮件系统通过`DNS`查找`vIPiis.com`这个域名的`MX`记录，如果`MX`记录存在， 用户计算机就将邮件发送到`MX`记录所指定的邮件服务器上。 
- (3)`CNAME`记录 ：也被称为别名记录，是双线智能解析和使用`CDN`加速必须用到的解析方法。`CNAME`解析通常是一个三级域名地址，您可以在主机管理后台"绑定域名"位置看到`CNAME`解析地址的信息提示，不同服务器会使用不同的`CNAME`解析地址。通过`CNAME`解析，可以让域名捆绑到多个服务器`IP`地址，需要注意的是`CNAME`解析地址后面有个英文“.”符号。 因为用到的解析类型是`CNAME`记录，所以着重学习了解了一下这个类型。以新网为例子，讲解一下该解析的使用步骤：

   * 在主机名处填写`www`或者其他名称;
   * 在记录类型选择类型为`CNAME`记录;
   * 在记录值填写别名地址;
   * 点击立即添加，完成添加别名解析。

   - 通常来说，别名解析可以提供更大的灵活性，便于统一管理。举个例子来说，当主机因各种因素的影响需要更换`IP`时，如果域名做了`CNAME`记录，就可以同时更新别名的解析指向，不用需要进行新的解析操作，也就是说可以做到无缝更换`IP`，这对实际中`IP`的维护是很实用的。而且对于双线主机来说，电信和联通有不同的接口对应不同的`IP`,由于A记录只能指向一个`IP`,这时采用别名解析就可以很好的解决这个问题。当然了`CNAME`记录也存在一定的不足，很多人认为不同的`IP`会对网站优化产生一定的影响，当蜘蛛每次爬行的时候，`IP`变化容易让蜘蛛产生网站不稳定的误解。不过见仁见智，到底好不好还需要自己去判断。

- (4)`NS`记录：是域名`DNS`服务器记录，全称`Name Server`记录，用来指定该域名由哪个`DNS`服务器来对您的域名进行解析。您注册域名时，总有默认的`DNS`服务器，每个注册的域名都是由一组`DNS`域名服务器来解析的。
- (5) `TXT`记录：一种文本记录，仅用于对主机名或者域名的记录信息，对解析无实质影响。
- (6)`TTL`值：全称是“生存时间（`Time To Live`)”，简单的说它表示`DNS`记录在`DNS`服务器上缓存时间。默认即可。 

- 泛解析：使用“*”建立二级域名解析到同一独立`IP`。在域名前添加任何子域名，均可解析到指定的服务器`IP`地址。 


 ![](`DNS`2.png)     



