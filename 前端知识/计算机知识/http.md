#### 一、简介 ####

- http协议(超文本传输协议)是客户端浏览器或其他程序与Web服务器之间的应用层通信协议,在Internet上的web服务器上存放的都是超文本信息，客户机需要通过HTTP协议传输所要访问的超文本信息。HTTP包含命令和传输信息，不仅可用于Web访问，也可以用于其他因特网/内联网应用系统之间的通信，从而实现各类应用资源超媒体访问的集成

#### 二、协议的功能 ####

- HTTP协议（HyperText Transfer Protocol，超文本传输协议）是用于从万维网（WWW:World Wide Web ）服务器传输超文本到本地浏览器的传送协议。它可以使浏览器更加高效，使网络传输减少。它不仅保证计算机正确快速地传输超文本文档，还确定传输文档中的哪一部分，以及哪部分内容首先显示(如文本先于图形)等


#### 三、http协议的组成 ####

- http协议由http请求和http响应两部分组成,当在浏览器中输入网址访问某个网站时， 你的浏览器会将你的请求封装成一个Http请求发送给服务器站点，服务器接收到请求后会组织响应数据封装成一个Http响应返回给浏览器。即没有请求就没有响应,这样就限制了使用HTTP协议，无法实现在客户端没有发起请求的时候，服务器将消息推送给客户端<br/>

- 浏览器发起HTTP请求的典型场景中背后的细节：

   * 浏览器（客户端）进行了地址解析

      * 当我们在浏览器中输入一个地址，按下回车后，浏览器获取到的是一个字符串。浏览器此时要对这个地址进行解析，获取协议，主机，端口，路径等信息
      * 浏览器会对一些默认的东西进行补齐。例如：互联网url默认端口号为80，浏览器默认补齐功能会补齐协议http，有些还会直接在域名前面补上www。所以实际上，即使我们输入的是imooc.com，然而实际访问的却是http://www.imooc.com
        
   * 将解析出的域名进行DNS解析

      * 第一步地址解析中我们已经获取到服务器的域名。此时就需要将域名换成对应的ip地址,浏览器根据域名查询DNS从而获取到对于的IP地址
        
   * 通过IP寻址和ARP，找到目标（服务器）地址

     * 获取到了IP，此时直接通IP寻址找到IP对应的服务器，然后通过ARP协议找到服务器的MAC地址
     * 地址解析协议，即ARP（Address Resolution Protocol），是根据IP地址获取物理地址的一个TCP/IP协议

	    1. 首先，每个主机都会在自己的ARP缓冲区中建立一个ARP列表，以表示IP地址和MAC地址之间的对应关系
		2. 当源主机要发送数据时，首先检查ARP列表中是否有对应IP地址的目的主机的MAC地址，如果有，则直接发送数据，如果没有，就向本网段的所有主机发送ARP数据包，该数据包包括的内容有：源主机 IP地址，源主机MAC地址，目的主机的IP 地址
	    3. 当本网络的所有主机收到该ARP数据包时，首先检查数据包中的IP地址是否是自己的IP地址，如果不是，则忽略该数据包，如果是，则首先从数据包中取出源主机的IP和MAC地址写入到ARP列表中，如果已经存在，则覆盖，然后将自己的MAC地址写入ARP响应包中，告诉源主机自己是它想要找的MAC地址。
	    4. 源主机收到ARP响应包后。将目的主机的IP和MAC地址写入ARP列表，并利用此信息发送数据。如果源主机一直没有收到ARP响应数据包，表示ARP查询失败。
					
        * 注意：广播（255.255.255.255）发送ARP请求，单播发送ARP响应。
        
   * 进行tcp三次握手，建立tcp连接

     * 我们找到了目标ip，并获得了服务器ip的mac地址，此时浏览器就会请求和服务器建立TCP连接（如果是https协议还需要TLS/SSL握手），用来传输数据
        
   * 浏览器发送数据，等待服务器响应

     * 浏览器会对请求进行包装，包装成请求报文
     * 报文的格式如下：
        * 起始行：如 GET / HTTP/1.0 （请求的方法 请求的URL 请求所使用的协议）
        * 头部信息：User-Agent Host等成对出现的值
        * 主体
     * 请求头部和主体之间有一个回车换行。如果是get请求，则没有主体部分，post请求有主体部分。当然里面还有些请求头部比较重要
    
  * 服务器收到HTTP请求后将HTML页面作为包体返回给浏览器

    * 由于http是无状态的，正常情况下，客户端收到响应后就会直接断开连接，然后一次http请求就完成了。但是http1.0有一个keep-alive的请求字段，可以在一定时间内不断开连接（有时时间甚至很长）。http1.1直接就默认开启了keep-alive选项。这导致了一个后果是服务器已经处理完了请求，但是客户端不会主动断开连接，这就导致服务器资源一直被占用。这时服务器就不得不自己主动断开连接，而主动断开连接的一方会出现TIME_WAIT，占用连接池，这就是产生SYN Flood攻击的原因
    * 此时有三种处理方式，第一是客户端主动断开连接，第二是服务器主动断开连接，第三是对tcp连接经行设置。第一种情况，如果服务器返回的数据都有确定的content-length属性，或者客户端知道服务器返回的内容终止，则客户端主动断开连接。第二种情况，服务器可以通过设置一个最大超时时间，可以主动断开tcp连接。第三种情况，调整t三个tcp参数，第一个是：tcp_synack_retries 可以用他来减少重试次数；第二个是：tcp_max_syn_backlog，可以增大syn连接数；第三个是：tcp_abort_on_overflow 处理不过来干脆就直接拒绝连接了

  * 浏览器引擎解析响应，得到html代码

  * 浏览器渲染包体至用户界面，并根据超链接构造其他的HTTP请求
    
#### 四、连接 ####

- 在服务器响应完毕后，一次会话就结束了，请问这时候连接会断开吗？

1. 长短连接

   - 是否断开我们需要区分HTTP版本：

      * 在HTTP/1.0版本的时候，客户端与服务器完成一个请求/响应之后，会将之前建立的TCP连接断开，下次请求的时候又要重新建立TCP连接，这也被称为短连接
      * 在HTTP1.0发布仅半年后（1997年1月） ，HTTP/1.1版本发布并带来一个新的功能：在客户端与服务器完成一次请求/响应之后，允许不断开TCP连接，这意味着下次请求就直接使用这个TCP连接而不再需要重新握手建立新连接，这也被称为长连接
   - 注意：长连接是指一次TCP连接允许多次HTTP会话，HTTP永远都是一次请求/响应，会话结束，HTTP本身不存在长连接之说。
   - 早在1999年HTTP1.1就推广普及，所以现在浏览器在请求时请求头中都会携带一个参数：Connection:keep-alive，这表示浏览器要求与服务器建立长连接，而服务器也可以设置是否愿意建立长连接。

2. 长连接优缺点

   - 对于服务器来说建立长连接有优点也有缺点：

     * 优点：当网站中有大量静态资源（图片、css、js等）就可以开启长连接，这几张图片就可以通过一次TCP连接发送。
     * 缺点：当客户端请求一次时候不在请求，而服务器却开着长连接资源被占用着，这是严重浪费资源。

  - 所以是否开启长连接，长连接时间都需要根据网站自身来合理设置。<br/>




