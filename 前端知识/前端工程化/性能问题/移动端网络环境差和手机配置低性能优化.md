在**移动端网络环境差（`2G/3G`、高延迟、低带宽） + 手机配置差（低端 `Android`、内存小、`CPU` 弱）** 的双重挑战下，前端优化必须 **“极致轻量 + 智能降级 + 用户感知优先”**。以下是系统性、可落地的优化策略，覆盖 **加载性能、运行性能、用户体验** 三大维度。

#  一、核心目标

| 维度         | 目标                          |
| ------------ | ----------------------------- |
| **加载速度** | 首屏 < `2s`（即使 `2G` 网络） |
| **内存占用** | `JS` 堆内存 < `50MB`          |
| **交互响应** | `TTI`（可交互时间）< `3s`     |
| **容错能力** | 弱网/断网仍可用基础功能       |

# 二、加载性能优化（让页面快点出来）

## 1. 极致压缩资源体积

- `JS/CSS`：

  - 启用 **`Brotli` 压缩**（比 `Gzip` 小 15~20%）
  - 移除未用代码：`webpack-bundle-analyzer` 分析 + `Tree Shaking`
  - 按需引入第三方库（如 `lodash/debounce` 而非全量）

- 图片：

  - 全站转 **`WebP/AVIF`**（体积减少 30~70%）

  - 使用`<picture>`降级兼容：

    ```
    <picture>
      <source srcset="image.avif" type="image/avif">
      <source srcset="image.webp" type="image/webp">
      <img src="image.jpg" alt="...">
    </picture>
    ```

  - 首屏图 **内联为 `Base64`**（< `2KB`）

- 字体：

  - 使用系统默认字体（避免加载自定义字体）
  - 必须用 `WebFont`？→ `font-display: swap` + 子集化（只保留中文常用字）

## 2. 代码分割 + 懒加载

- 路由级懒加载（`Vue/React`）：

  ```
  // Vue 3
  const Home = () => import('./views/Home.vue');
  ```

- 组件级懒加载（非首屏组件）：

  ```
  <template>
    <LazyComment v-if="showComments" />
  </template>
  <script>
  import { defineAsyncComponent } from 'vue';
  export default {
    components: {
      LazyComment: defineAsyncComponent(() => import('./Comment.vue'))
    }
  };
  </script>
  ```

## 3. 关键资源预加载 + 缓存策略

- 预加载首屏关键 `JS/CSS`：

  ```
  <link rel="preload" as="script" href="critical.js">
  ```

- 强缓存静态资源：

  ```
  # Nginx 配置
  location ~* \.(js|css|png|jpg|webp)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
  }
  ```

- `Service Worker` 缓存

  （即使离线也能看）：

  - 缓存 `HTML Shell` + 关键 `API` 数据
  - 使用 `Workbox` 自动生成策略

##  4. 考虑 `SSR / SSG`（服务端渲染）

**优势**：首屏直接返回 `HTML`，无需等待 `JS` 执行

方案：

- `Vue → Nuxt.js（SSR/SSG）`
- `React → Next.js`
- 静态内容 → `VitePress / Hugo`（纯静态）

> 💡 在低端机上，**`CSR`（客户端渲染）白屏时间可能长达 `5s+`，`SSR` 可降至 `1s` 内**

#  三、运行性能优化（让页面跑得动）

## 1. 减少主线程工作

- 避免长任务（`>50ms`）：

  - 大数据计算 → 放到 **`Web Worker`**
  - 列表渲染 > 50 条 → **虚拟滚动**（`vue-virtual-scroller`, `react-window`）

- 防抖节流高频事件：

  ```
  // scroll / resize 用节流
  window.addEventListener('scroll', throttle(handleScroll, 100));
  // input 搜索用防抖
  input.addEventListener('input', debounce(search, 300));
  ```

## 2. 降低 `DOM` 复杂度

- **减少 `DOM` 节点数**：首屏 < 1000 个节点

- **避免深层嵌套**：`CSS` 选择器层级 < 3 层

- 用 `CSS` 动画替代 `JS` 动画：

  ```
  .fade-in {
    animation: fadeIn 0.3s ease;
    /* 而非 JS 修改 style */
  }
  ```

##  3. 内存泄漏防护

- 及时销毁监听器：

  ```
  // Vue 2
  beforeDestroy() { window.removeEventListener('resize', this.handler); }
  // Vue 3
  onBeforeUnmount(() => { ... });
  ```

- **避免闭包持有大对象**

- **图片/视频及时释放**：离开页面时 `src = ''`

# 四、用户体验优化（让用户感觉快）

## 1. 骨架屏（`Skeleton Screen`）

- 替代“白屏”或“`Loading...`”

- 用纯 `CSS` 实现，零 `JS` 开销：

  ```
  <div class="skeleton-card">
    <div class="skeleton-avatar"></div>
    <div class="skeleton-line"></div>
  </div>
  ```

## 2. 智能降级策略

| 场景                                                         | 降级方案                            |
| ------------------------------------------------------------ | ----------------------------------- |
| **检测到低端机**                                             | 关闭动画、简化 `UI`、禁用非核心功能 |
| **弱网（`navigator.connection.effectiveType === 'slow-2g'`）** | 自动切换低清图片、暂停自动播放视频  |
| **内存不足**                                                 | 减少缓存、限制列表长度              |

> 🔍 检测网络/设备：
>
> ```
> // 网络状态
> if ('connection' in navigator) {
>   console.log(navigator.connection.effectiveType); // '4g', '3g', '2g', 'slow-2g'
> }
> // 设备内存（实验性）
> if ('deviceMemory' in navigator) {
>   console.log(navigator.deviceMemory); // 0.25, 0.5, 1, 2, 4, 8 (GB)
> }
> ```

##  3. 离线可用（`PWA`）

- 缓存核心页面和 `API` 数据
- 断网时提示：“当前无网络，已加载缓存内容”
- 表单提交失败 → 本地暂存，网络恢复后自动重发

#  五、构建与部署优化

| 措施                     | 说明                                         |
| ------------------------ | -------------------------------------------- |
| **启用 `HTTP/2 + CDN`**  | 多路复用 + 全球加速                          |
| **域名收敛**             | 减少 `DNS` 查询（静态资源用同一 `CDN` 域名） |
| **移除 `sourceMap`**     | 生产环境不传 `.map` 文件                     |
| **关闭 `devtools` 警告** | `Vue` 生产版本自动移除                       |

# 六、监控与度量

- 核心指标监控：
  - `FCP`（首次内容绘制）< `1.8s`
  - `LCP`（最大内容绘制）< `2.5s`
  - `TTI`（可交互时间）< `3s`
  - `JS` 堆内存 < `50MB`
- 工具：
  - `Lighthouse`（模拟 `Moto G4 + Slow 3G`）
  - `WebPageTest`（选择“`Emerging Markets`”设备）
  - 自建 `RUM`（真实用户监控）上报低端机性能数据

## 七、终极 `checklist`（上线前必看）

-  首屏 `JS < 100KB`（压缩后）
-  图片全部转 `WebP` + 懒加载
-  路由/组件懒加载已启用
-  关键 `CSS` 内联 or 预加载
-  启用 `Brotli + CDN`
-  骨架屏覆盖首屏
-  弱网/低端机降级逻辑
-  `Service Worker` 缓存核心资源
-  无内存泄漏（`Chrome Memory` 面板验证）

#  总结：为“最差环境”设计

> **不要假设用户有 `5G` 和 `iPhone`**。
>  在印度、东南亚、非洲等新兴市场，**`2G + 1GB` 内存手机仍是主流**。

**优化哲学**：

- **能不加载就不加载**
- **能晚加载就晚加载**
- **能不用 `JS` 就不用 `JS`**
- **能让用户“感觉快”就别追求“绝对快”**

通过以上策略，即使在网络 `100KB/s`、`CPU` 主频 `1GHz` 的设备上，也能提供**可用、流畅、不崩溃**的体验。