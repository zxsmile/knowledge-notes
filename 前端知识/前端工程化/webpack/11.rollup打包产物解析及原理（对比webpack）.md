# ä¸€ã€`rollup`å®šä½

`rollup`æ¯”`webpack`æ™šå‡º2å¹´ï¼Œå¯¹æ¯”`webpack`è‚¯å®šæ˜¯æœ‰å·®å¼‚åŒ–çš„ã€‚æˆ‘ä»¬å¯ä»¥æŸ¥çœ‹å®˜ç½‘ï¼Œå¾—åˆ°ä»¥ä¸‹å‡ ä¸ªç‰¹ç‚¹ï¼š

1ã€å»ºè®®å¼€å‘è€…ä½¿ç”¨`esm`å†™æ¨¡å—ï¼Œä½¿ç”¨`esm`æ¨¡å—çš„å¥½å¤„æœ‰å¾ˆå¤šï¼š

- é«˜ç‰ˆæœ¬æµè§ˆå™¨åŸç”Ÿæ”¯æŒï¼ˆæµè§ˆå™¨åªæœ‰2ç§æ–¹æ³•æ”¯æŒå¼•å…¥`js`æ¨¡å—ï¼Œ1æ˜¯`script`æ ‡ç­¾ï¼Œ2å°±æ˜¯`esm`æ¨¡å—ï¼‰
- å¯ä»¥åš`tree shaking`ï¼ˆæ—©æœŸ`webpack`ç‰ˆæœ¬æ˜¯ä¸æ”¯æŒ`tree shaking`çš„ï¼‰
- å¯ä»¥è§£å†³å¾ªç¯å¼•ç”¨çš„é—®é¢˜

2ã€`esm`æœ€ç»ˆå°†åœ¨ä»»ä½•åœ°æ–¹éƒ½å¯ä»¥å®ç°ï¼ˆæµè§ˆå™¨+`node`éƒ½å¯ä»¥ç”¨ï¼Œæ˜¯æœªæ¥çš„æ ‡å‡†ï¼‰ï¼Œä½† `Rollup` è®©æ‚¨ä»Šå¤©å°±å¯ä»¥å®ç°ã€‚

- è¿™å¥è¯å¾ˆé‡è¦ï¼Œä¹Ÿæ˜¯`rollup`çš„ç‰¹ç‚¹ï¼Œä¹Ÿæ˜¯è¯ç”Ÿçš„åŸå› 
- ç®€å•çš„è¯´å°±æ˜¯ï¼š`ESM - ECMAScript` æ¨¡å—æ˜¯æœªæ¥çš„å®˜æ–¹æ ‡å‡†å’Œä¸»æµã€‚ä½†æ˜¯æµè§ˆå™¨çš„ç‰ˆæœ¬éœ€è¦æ¯”è¾ƒé«˜ï¼Œæ¯”å¦‚`chorme`éƒ½éœ€è¦63ç‰ˆæœ¬ä»¥ä¸Š

**`rollup`çš„ç‰¹è‰²æ˜¯ `ES6` æ¨¡å—å’Œä»£ç  `Tree-shaking`ï¼Œè¿™äº› `webpack` åŒæ ·æ”¯æŒï¼Œé™¤æ­¤ä¹‹å¤– `webpack` è¿˜æ”¯æŒçƒ­æ¨¡å—æ›¿æ¢ã€ä»£ç åˆ†å‰²ã€é™æ€èµ„æºå¯¼å…¥ç­‰æ›´å¤šåŠŸèƒ½ã€‚**

**å½“å¼€å‘åº”ç”¨æ—¶å½“ç„¶ä¼˜å…ˆé€‰æ‹©çš„æ˜¯ `webpack`ï¼Œä½†æ˜¯è‹¥ä½ é¡¹ç›®åªéœ€è¦æ‰“åŒ…å‡ºä¸€ä¸ªç®€å•çš„ `bundle` åŒ…ï¼Œå¹¶æ˜¯åŸºäº `ES6` æ¨¡å—å¼€å‘çš„ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ `rollup`ã€‚**

**`rollup` ç›¸æ¯” `webpack`ï¼Œå®ƒæ›´å°‘çš„åŠŸèƒ½å’Œæ›´ç®€å•çš„ apiï¼Œæ˜¯æˆ‘ä»¬åœ¨æ‰“åŒ…ç±»åº“æ—¶é€‰æ‹©å®ƒçš„åŸå› ã€‚**

# äºŒã€`rollup`ä½¿ç”¨æµç¨‹

#### æµè§ˆå™¨ç¯å¢ƒä½¿ç”¨çš„åº”ç”¨ç¨‹åºçš„è¯ï¼š

- æ— éœ€è€ƒè™‘æµè§ˆå™¨å…¼å®¹é—®é¢˜çš„è¯
  - å¼€å‘è€…å†™`esm`ä»£ç  -> `rollup`é€šè¿‡**å…¥å£**ï¼Œé€’å½’è¯†åˆ«`esm`æ¨¡å— ->  æœ€ç»ˆæ‰“åŒ…æˆä¸€ä¸ªæˆ–å¤šä¸ª`bundle.js` -> æµè§ˆå™¨ç›´æ¥å¯ä»¥æ”¯æŒå¼•å…¥

- éœ€è€ƒè™‘æµè§ˆå™¨å…¼å®¹é—®é¢˜çš„è¯
  - å¯èƒ½ä¼šæ¯”è¾ƒå¤æ‚ï¼Œéœ€è¦ç”¨é¢å¤–çš„`polyfill`åº“ï¼Œæˆ–ç»“åˆ`webpack`ä½¿ç”¨

#### æ‰“åŒ…æˆnpmåŒ…çš„è¯ï¼š

- å¼€å‘è€…å†™`esm`ä»£ç  -> `rollup`é€šè¿‡å…¥å£ï¼Œé€’å½’è¯†åˆ«`esm`æ¨¡å— -> ï¼ˆå¯ä»¥æ”¯æŒé…ç½®è¾“å‡ºå¤šç§æ ¼å¼çš„æ¨¡å—ï¼Œå¦‚`esm`ã€`cjs`ã€`umd`ã€`amd`ï¼‰æœ€ç»ˆæ‰“åŒ…æˆä¸€ä¸ªæˆ–å¤šä¸ª`bundle.js`
  - ï¼ˆå¼€å‘è€…è¦å†™`cjs`ä¹Ÿå¯ä»¥ï¼Œéœ€è¦æ’ä»¶`@rollup/plugin-commonjs`ï¼‰ åˆæ­¥çœ‹æ¥
- å¾ˆæ˜æ˜¾ï¼Œ`rollup`æ¯”è¾ƒé€‚åˆæ‰“åŒ…`js`åº“ï¼ˆ`react`ã€`vue`ç­‰çš„æºä»£ç åº“éƒ½æ˜¯`rollup`æ‰“åŒ…çš„ï¼‰æˆ– é«˜ç‰ˆæœ¬æ— éœ€å¾€ä¸‹å…¼å®¹çš„æµè§ˆå™¨åº”ç”¨ç¨‹åºï¼ˆç°åœ¨2022å¹´äº†ï¼Œæ—¶é—´è¶Šå¾€åï¼Œè¿ç§»åˆ°`rollup`ä¼šè¶Šå¤šï¼ŒçŒœæµ‹ï¼‰
- è¿™æ ·æ‰“åŒ…å‡ºæ¥çš„åº“ï¼Œå¯ä»¥å……åˆ†ä½¿ç”¨ä¸Š`esm`çš„`tree shaking`ï¼Œä½¿æºåº“ä½“ç§¯æœ€å°

## ä¸¾ä¸ªå°ğŸŒ°ç®€å•çš„å¯¹æ¯”ä¸€ä¸‹ `webpack`æ‰“åŒ…å’Œ`rollup`æ‰“åŒ…

æ­¤`demo`æ˜¯çº¯`esm`çš„å†™æ³•

```js
// å…¥å£mainã€‚js
import { b } from './test/a'
console.log(b + 1)
console.log(1111)

// './test/a'
export const b = 'xx'
export const bbbbbbb = 'xx'
```

rollupæ‰“åŒ…æ•ˆæœï¼ˆéå¸¸å¹²å‡€ï¼Œæ— æ³¨å…¥ä»£ç ï¼‰

```js
const b = 'xx';
console.log(b + 1);
console.log(1111);
```

`webpack`æ‰“åŒ…æ•ˆæœï¼ˆæœ‰å¾ˆå¤šæ³¨å…¥ä»£ç ï¼‰

- å®é™…ä¸Šï¼Œæˆ‘ä»¬è‡ªå·±å†™çš„ä»£ç åœ¨æœ€ä¸‹é¢ã€‚ä¸Šé¢æ³¨å…¥çš„å¤§æ®µä»£ç  éƒ½æ˜¯**`webpack`è‡ªå·±çš„å…¼å®¹ä»£ç **ï¼Œ**ç›®çš„æ˜¯è‡ªå·±å®ç°`require`ï¼Œ`modules.exports`ï¼Œ`export`ï¼Œè®©æµè§ˆå™¨å¯ä»¥å…¼å®¹`cjs`å’Œ`esm`è¯­æ³•**
- ï¼ˆå¯ä»¥ç†è§£ä¸ºï¼Œ**`webpack`è‡ªå·±å®ç°polyfillæ”¯æŒæ¨¡å—è¯­æ³•ï¼Œ`rollup`æ˜¯åˆ©ç”¨é«˜ç‰ˆæœ¬æµè§ˆå™¨åŸç”Ÿæ”¯æŒ`esm`(æ‰€ä»¥`rollup`æ— éœ€ä»£ç æ³¨å…¥)**ï¼‰

```js
/******/ (function(modules) { // webpackBootstrap
/******/   // The module cache
/******/   var installedModules = {};
/******/
/******/   // The require function
/******/   function __webpack_require__(moduleId) {
/******/
/******/    // Check if module is in cache
/******/    if(installedModules[moduleId]) {
/******/     return installedModules[moduleId].exports;
/******/    }
/******/    // Create a new module (and put it into the cache)
/******/    var module = installedModules[moduleId] = {
/******/     i: moduleId,
/******/     l: false,
/******/     exports: {}
/******/    };
/******/
/******/    // Execute the module function
/******/    modules[moduleId].call(module.exports, module, module.exports, __webpack_require__);
/******/
/******/    // Flag the module as loaded
/******/    module.l = true;
/******/
/******/    // Return the exports of the module
/******/    return module.exports;
/******/   }
/******/
/******/
/******/   // expose the modules object (__webpack_modules__)
/******/   __webpack_require__.m = modules;
/******/
/******/   // expose the module cache
/******/   __webpack_require__.c = installedModules;
/******/
/******/   // define getter function for harmony exports
/******/   __webpack_require__.d = function(exports, name, getter) {
/******/    if(!__webpack_require__.o(exports, name)) {
/******/     Object.defineProperty(exports, name, { enumerable: true, get: getter });
/******/    }
/******/   };
/******/
/******/   // define __esModule on exports
/******/   __webpack_require__.r = function(exports) {
/******/    if(typeof Symbol !== 'undefined' && Symbol.toStringTag) {
/******/     Object.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });
/******/    }
/******/    Object.defineProperty(exports, '__esModule', { value: true });
/******/   };
/******/
/******/   // create a fake namespace object
/******/   // mode & 1: value is a module id, require it
/******/   // mode & 2: merge all properties of value into the ns
/******/   // mode & 4: return value when already ns object
/******/   // mode & 8|1: behave like require
/******/   __webpack_require__.t = function(value, mode) {
/******/    if(mode & 1) value = __webpack_require__(value);
/******/    if(mode & 8) return value;
/******/    if((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;
/******/    var ns = Object.create(null);
/******/    __webpack_require__.r(ns);
/******/    Object.defineProperty(ns, 'default', { enumerable: true, value: value });
/******/    if(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));
/******/    return ns;
/******/   };
/******/
/******/   // getDefaultExport function for compatibility with non-harmony modules
/******/   __webpack_require__.n = function(module) {
/******/    var getter = module && module.__esModule ?
/******/     function getDefault() { return module['default']; } :
/******/     function getModuleExports() { return module; };
/******/    __webpack_require__.d(getter, 'a', getter);
/******/    return getter;
/******/   };
/******/
/******/   // Object.prototype.hasOwnProperty.call
/******/   __webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };
/******/
/******/   // __webpack_public_path__
/******/   __webpack_require__.p = "./";
/******/
/******/
/******/   // Load entry module and return exports
/******/   return __webpack_require__(__webpack_require__.s = 0);
/******/ })
/************************************************************************/
/******/ ([
/* 0 */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
// ESM COMPAT FLAG
__webpack_require__.r(__webpack_exports__);

// CONCATENATED MODULE: ./src/test/a.js
const b = 'xx';
const bbbbbbb = 'xx';

// CONCATENATED MODULE: ./src/main.js
console.log(b + 1);
console.log(1111); 

/***/ })
/******/ ]);
```

# ä¸‰ã€ä¸¤è€…å¤„ç†æºä»£ç æ¨¡å—çš„å¯¹æ¯”

|           | çº¯`esm`            | çº¯`cjs`                                           | ä¸¤è€…æ··ç”¨                                          |
| --------- | ------------------ | ------------------------------------------------- | ------------------------------------------------- |
| `webpack` | æ”¯æŒï¼ˆæœ‰ä»£ç æ³¨å…¥ï¼‰ | æ”¯æŒï¼ˆæœ‰ä»£ç æ³¨å…¥ï¼‰                                | æ”¯æŒï¼ˆæœ‰ä»£ç æ³¨å…¥ï¼‰                                |
| `rollup`  | **æ”¯æŒï¼ˆæ— æ³¨å…¥ï¼‰** | åŸç”Ÿä¸æ”¯æŒï¼ˆéœ€å¢åŠ æ’ä»¶`@rollup/plugin-commonjsï¼‰` | åŸç”Ÿä¸æ”¯æŒï¼ˆéœ€å¢åŠ æ’ä»¶`@rollup/plugin-commonjs`ï¼‰ |

**`rollup`çš„åˆè¡·ä¹Ÿæ˜¯å¸Œæœ›å¼€å‘è€…å»å†™`esm`ï¼Œè€Œä¸æ˜¯`cjs`ã€‚å› ä¸º`esm`æ˜¯`javascript`çš„æ–°æ ‡å‡†ï¼Œæ˜¯æœªæ¥ï¼Œæœ‰å¾ˆå¤šä¼˜ç‚¹ï¼Œé«˜ç‰ˆæœ¬æµè§ˆå™¨ä¹Ÿæ”¯æŒ

# å››ã€ä¸¤è€…å¤„ç†å¯¹å¤–æš´éœ²æ¨¡å—ï¼Œéå¸¸ä¸ä¸€æ ·ï¼ï¼ï¼ˆè§£é‡Š`rollup`ä¸ºä»€ä¹ˆé€‚åˆæ‰“åŒ…åº“ï¼‰

ä¸Šé¢çš„`demo` **åŠ ä¸Š`export` å¯¼å‡º**

```js
// å…¥å£mainã€‚js
import { b } from './test/a'
console.log(b + 1)
console.log(1111)
export { // æ–°å¢å¯¼å‡º
  b
}

// './test/a'
export const b = 'xx'
export const bbbbbbb = 'xx'
```

`rollup`æ‰“åŒ…å¯¼å‡ºï¼ˆéå¸¸å¹²å‡€ï¼Œæ— æ³¨å…¥ä»£ç ï¼‰

- `rollup`æœ¬èº«ä¸å»åš`polyfill`

- `rollup`çš„é…ç½®æ–‡ä»¶æ— éœ€ç‰¹æ®Šé…ç½®ï¼Œè€Œä¸”è¿˜å¯ä»¥æ”¯æŒå¤šç§æ¨¡å—å¯¼å‡ºï¼ˆ`esm`ï¼Œ`cjs`ï¼Œ`umd`ï¼Œ`amd`ï¼‰

  ```js
  // rollup.config.js
  const OUTPUT_DIR = 'dist'
  const INPUT_FILE = 'src/main.js'
  export default[
   // esm
    {
      input: INPUT_FILE,
      output: {
        file: OUTPUT_DIR + '/esm/index.js',
        format: 'esm' // å¯¼å‡ºesmæ¨¡å— 
      }
    },
    // commonjs
    {
      input: INPUT_FILE,
      output: {
        file: OUTPUT_DIR + '/cjs/index.js',
        format: 'cjs' // å¯¼å‡ºcjsæ¨¡å— 
      }
    },
    // umd
    {
      input: INPUT_FILE,
      output: {
        file: OUTPUT_DIR + '/umd/index.js',
        format: 'umd' // å¯¼å‡ºumdæ¨¡å— 
      }
    },
  ]
  ```

  æ‰“åŒ…å¾—åˆ° `esm` å’Œ `cjs`

  ```js
  // esm
  const b = 'xx';
  console.log(b + 1);
  console.log(1111);
  export { b };
  
  // cjs
  const b = 'xx';
  console.log(b + 1);
  console.log(1111);
  exports.b = b;
  
  // umd ï¼ˆå…¼å®¹3ç§å†™æ³•ï¼šcjsï¼Œamdï¼Œglobalï¼ˆglobalå¯ä»¥åˆæ­¥ç†è§£ä¸ºç›´æ¥é€šè¿‡windowä¼ å€¼ï¼‰ï¼‰
  (function (global, factory) {
      typeof exports === 'object' && typeof module !== 'undefined' ? factory(exports) :
      typeof define === 'function' && define.amd ? define(['exports'], factory) :
      (global = typeof globalThis !== 'undefined' ? globalThis : global || self, factory(global.aa = {}));
  })(this, (function (exports) { 'use strict';
      const b = 'xx';
      console.log(b + 1);
      console.log(1111);
      exports.b = b;
      Object.defineProperty(exports, '__esModule', { value: true });
  }));
  ```

`webpack`å¯¼å‡º ï¼ˆåŒºåˆ«å·¨å¤§ï¼Œæ³¨å…¥ä»£ç è¾ƒå¤šï¼Œå¯¼å‡º`esm`æ”¯æŒçš„ä¸å¤ªå¥½ï¼‰

- `webpack`éœ€é…ç½® ï¼ˆæ­¤å¤„æ˜¯ `webpack 4.x`ï¼‰

  ```js
  output: {
    ...,
    library: 'myLib', // æš´éœ²å‡ºå»çš„å˜é‡çš„åå­—
    libraryTarget: 'commonjs',
  }
  ```

  `webpack`æš‚æ—¶åªèƒ½æ”¯æŒå¯¼å‡º `cjs` æˆ– æ›´å¾€å‰å…¼å®¹çš„åŒ…(`umd`)**ä¸æ”¯æŒ`esm`ï¼ˆå®éªŒæ€§ï¼‰**

  ![webpack177](..\images\webpack177.png)

- æˆ‘ä»¬æ­¤å¤„å¯¼å‡º cjsçš„åŒ…ï¼Œ å’Œ`rollup`å¯¹æ¯”ä¸€ä¸‹

  - æ³¨å…¥ä»£ç ç‰¹åˆ«å¤šï¼Œæ¯”è¾ƒå†—ä½™

  ```js
  exports["myLib"] =
  /******/ (function(modules) { // webpackBootstrap
  /******/   // The module cache
  /******/   var installedModules = {};
  /******/
  /******/   // The require function
  /******/   function __webpack_require__(moduleId) {
  /******/
  /******/    // Check if module is in cache
  /******/    if(installedModules[moduleId]) {
  /******/     return installedModules[moduleId].exports;
  /******/    }
  /******/    // Create a new module (and put it into the cache)
  /******/    var module = installedModules[moduleId] = {
  /******/     i: moduleId,
  /******/     l: false,
  /******/     exports: {}
  /******/    };
  /******/
  /******/    // Execute the module function
  /******/    modules[moduleId].call(module.exports, module, module.exports, __webpack_require__);
  /******/
  /******/    // Flag the module as loaded
  /******/    module.l = true;
  /******/
  /******/    // Return the exports of the module
  /******/    return module.exports;
  /******/   }
  /******/
  /******/
  /******/   // expose the modules object (__webpack_modules__)
  /******/   __webpack_require__.m = modules;
  /******/
  /******/   // expose the module cache
  /******/   __webpack_require__.c = installedModules;
  /******/
  /******/   // define getter function for harmony exports
  /******/   __webpack_require__.d = function(exports, name, getter) {
  /******/    if(!__webpack_require__.o(exports, name)) {
  /******/     Object.defineProperty(exports, name, { enumerable: true, get: getter });
  /******/    }
  /******/   };
  /******/
  /******/   // define __esModule on exports
  /******/   __webpack_require__.r = function(exports) {
  /******/    if(typeof Symbol !== 'undefined' && Symbol.toStringTag) {
  /******/     Object.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });
  /******/    }
  /******/    Object.defineProperty(exports, '__esModule', { value: true });
  /******/   };
  /******/
  /******/   // create a fake namespace object
  /******/   // mode & 1: value is a module id, require it
  /******/   // mode & 2: merge all properties of value into the ns
  /******/   // mode & 4: return value when already ns object
  /******/   // mode & 8|1: behave like require
  /******/   __webpack_require__.t = function(value, mode) {
  /******/    if(mode & 1) value = __webpack_require__(value);
  /******/    if(mode & 8) return value;
  /******/    if((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;
  /******/    var ns = Object.create(null);
  /******/    __webpack_require__.r(ns);
  /******/    Object.defineProperty(ns, 'default', { enumerable: true, value: value });
  /******/    if(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));
  /******/    return ns;
  /******/   };
  /******/
  /******/   // getDefaultExport function for compatibility with non-harmony modules
  /******/   __webpack_require__.n = function(module) {
  /******/    var getter = module && module.__esModule ?
  /******/     function getDefault() { return module['default']; } :
  /******/     function getModuleExports() { return module; };
  /******/    __webpack_require__.d(getter, 'a', getter);
  /******/    return getter;
  /******/   };
  /******/
  /******/   // Object.prototype.hasOwnProperty.call
  /******/   __webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };
  /******/
  /******/   // __webpack_public_path__
  /******/   __webpack_require__.p = "./";
  /******/
  /******/
  /******/   // Load entry module and return exports
  /******/   return __webpack_require__(__webpack_require__.s = 0);
  /******/ })
  /************************************************************************/
  /******/ ([
  /* 0 */
  /***/ (function(module, __webpack_exports__, __webpack_require__) {
  
  "use strict";
  // ESM COMPAT FLAG
  __webpack_require__.r(__webpack_exports__);
  
  // EXPORTS  è¿™ä¸€è¡Œæ˜¯å¤„ç†esmçš„å¯¼å‡ºï¼Œå› ä¸ºæˆ‘ä»¬ç”¨çš„æ˜¯ export { b: xx }ï¼Œ å¦‚æœæˆ‘ä»¬ç”¨cjsçš„å¯¼å‡º æ¯”å¦‚ module.exports = { b: xx }ï¼Œ æ­¤å¤„å°±ä¼šæ²¡æœ‰ï¼Œä¼šæ›´ç®€å•ï¼Œç›´æ¥æ˜¯ module.exports = { b: xx }
  __webpack_require__.d(__webpack_exports__, "b", function() { return /* reexport */ b; });
  
  // CONCATENATED MODULE: ./src/test/a.js
  const b = 'xx';
  const bbbbbbb = 'xx';
  
  // CONCATENATED MODULE: ./src/main.js
  console.log(b + 1);
  console.log(1111);
  
  /***/ })
  /******/ ]);
  ```

  æ³¨æ„çœ‹  å€’æ•°ç¬¬10å¤šè¡Œï¼Œæœ‰ä¸ª

  ```java
  // EXPORTS 
  __webpack_require__.d(__webpack_exports__, "b", function() { return /* reexport */ b; });
  
  è¿™ä¸€è¡Œæ˜¯å¤„ç†esmçš„å¯¼å‡ºï¼Œå› ä¸ºæˆ‘ä»¬ç”¨çš„æ˜¯ export { b: xx }ï¼Œ
  å¦‚æœæˆ‘ä»¬ç”¨cjsçš„å¯¼å‡º æ¯”å¦‚ module.exports = { b: xx }ï¼Œ æ­¤å¤„å°±ä¼šæ²¡æœ‰æ­¤è¡Œï¼Œä¼šæ›´ç®€å•ï¼Œç›´æ¥æ˜¯ module.exports = { b: xx }   ï¼ˆ webpackä¼šè‡ªå·±æ¨¡æ‹Ÿå®ç° module.exports ï¼‰
  ```

# äº”ã€ä¸ºä»€ä¹ˆ`webpack`éœ€è¦æ³¨å…¥è¿™ä¹ˆå¤šä»£ç ï¼Ÿ

å› ä¸º`webpack`æ¯”`rollup`æ—©å‡º2å¹´ï¼Œè¯ç”Ÿåœ¨`esm`æ ‡å‡†å‡ºæ¥å‰ï¼Œ`commonjs`å‡ºæ¥åï¼Œå½“æ—¶çš„æµè§ˆå™¨åªèƒ½é€šè¿‡`script`æ ‡ç­¾åŠ è½½æ¨¡å—ï¼Œ`script`æ ‡ç­¾åŠ è½½ä»£ç æ˜¯æ²¡æœ‰ä½œç”¨åŸŸçš„ï¼Œåªèƒ½åœ¨ä»£ç å†… ç”¨`iife`çš„æ–¹å¼ å®ç°ä½œç”¨åŸŸæ•ˆæœã€‚**è¿™å°±æ˜¯`webpack`æ‰“åŒ…å‡ºæ¥çš„ä»£ç  å¤§ç»“æ„éƒ½æ˜¯`iife`çš„åŸå› **ï¼Œå¹¶ä¸”**æ¯ä¸ªæ¨¡å—éƒ½è¦è£…åˆ°`function`é‡Œé¢**ï¼Œæ‰èƒ½ä¿è¯äº’ç›¸ä¹‹é—´ä½œç”¨åŸŸä¸å¹²æ‰°ã€‚**è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ `webpack`æ‰“åŒ…çš„ä»£ç ä¸ºä»€ä¹ˆä¹çœ‹ä¼šæ„Ÿè§‰ä¹±ï¼Œæ‰¾ä¸åˆ°è‡ªå·±å†™çš„ä»£ç çš„çœŸæ­£åŸå› **ã€‚

å…³äº`webpack`çš„ä»£ç æ³¨å…¥é—®é¢˜ï¼Œæ˜¯å› ä¸ºæµè§ˆå™¨ä¸æ”¯æŒ`cjs`ï¼Œæ‰€ä»¥`webpack`è¦å»è‡ªå·±å®ç°`require`å’Œ`module.exports`æ–¹æ³•ï¼ˆæ‰æœ‰å¾ˆå¤šæ³¨å…¥ï¼‰ï¼ˆ`webpack`è‡ªå·±å®ç°`polyfill`ï¼‰è¿™ä¹ˆå¤šå¹´äº†ï¼Œç”šè‡³åˆ°ç°åœ¨2022å¹´ï¼Œæµè§ˆå™¨ä¸ºä»€ä¹ˆä¸æ”¯æŒ`cjs`

ï¼Ÿ

- **`cjs`æ˜¯åŒæ­¥çš„ï¼Œè¿è¡Œæ—¶çš„ï¼Œ`node`ç¯å¢ƒç”¨`cjs`ï¼Œ`node`æœ¬èº«è¿è¡Œåœ¨æœåŠ¡å™¨ï¼Œæ— éœ€ç­‰å¾…ç½‘ç»œæ¡æ‰‹ï¼Œæ‰€ä»¥åŒæ­¥å¤„ç†æ˜¯å¾ˆå¿«çš„**
- **æµè§ˆå™¨æ˜¯ å®¢æˆ·ç«¯ï¼Œè®¿é—®çš„æ˜¯æœåŠ¡ç«¯èµ„æºï¼Œä¸­é—´éœ€è¦ç­‰å¾…ç½‘ç»œæ¡æ‰‹ï¼Œå¯èƒ½ä¼šå¾ˆæ…¢ï¼Œæ‰€ä»¥ä¸èƒ½ åŒæ­¥çš„ å¡åœ¨é‚£é‡Œç­‰æœåŠ¡å™¨è¿”å›çš„ï¼Œä½“éªŒå¤ªå·®**

- **åç»­å‡ºæ¥`esm`åï¼Œ`webpack`ä¸ºäº†å…¼å®¹ä»¥å‰å‘åœ¨`npm`ä¸Šçš„è€åŒ…**ï¼ˆå¹¶ä¸”å½“æ—¶å¿ƒè¿˜ä¸å¤Ÿå†³ç»ï¼Œå¯¼è‡´è¿™ç§â€œä¸‘ç»“æ„çš„åŒ…â€è¶Šæ¥è¶Šå¤šï¼Œä»¥åå°±æ›´ä¸å¯èƒ½æ”¹è¿™ç§â€œä¸‘ç»“æ„äº†â€ï¼‰ï¼Œæ‰€ä»¥ä¿ç•™è¿™ä¸ª`iife`çš„ç»“æ„å’Œä»£ç æ³¨å…¥ï¼Œ**å¯¼è‡´ç°åœ¨çœ‹`webpack`æ‰“åŒ…çš„äº§ç‰©ï¼Œä¹çœ‹ç»“æ„æ¯”è¾ƒä¹±ä¸”æœ‰å¾ˆå¤šçš„ä»£ç æ³¨å…¥ï¼Œè‡ªå·±å†™çš„ä»£ç éƒ½æ‰¾ä¸åˆ°**

`rollup`è¯ç”Ÿäº`esm`æ ‡å‡†å‡ºæ¥åï¼Œå°±æ˜¯é’ˆå¯¹`esm`è®¾è®¡çš„ï¼Œä¹Ÿæ²¡æœ‰å†å²åŒ…è¢±ï¼Œæ‰€ä»¥å¯ä»¥åšåˆ°çœŸæ­£çš„â€œæ‰“åŒ…â€ï¼ˆç²¾ç®€ï¼Œæ— é¢å¤–æ³¨å…¥ï¼‰

- ï¼ˆæ ¹æ®`npm`ç‰ˆæœ¬ä¸Šä¼ æ˜¾ç¤ºæœ€æ—©ä¸Šä¼ æ—¶é—´ï¼š **`webpack`æ˜¯2013å¹´å·¦å³ï¼Œ`rollup`æ˜¯2015.5**ï¼‰

# å…­ã€`rollup`å¦‚ä½•æ‰“åŒ…ç¬¬ä¸‰æ–¹ä¾èµ– å’Œ æ‡’åŠ è½½æ¨¡å— å’Œ å…¬å…±æ¨¡å—ï¼Ÿ

å’Œ`webpack`æ‰“åŒ…ä¸€æ ·ï¼Œæœ‰ä¸¤ç§ï¼šå•`chunk`åŒ… å’Œ å¤š`chunk`åŒ…

## å•`chunk`åŒ…

æ— é¢å¤–é…ç½®ï¼Œä¸€èˆ¬ä¼šæŠŠæ‰€æœ‰`js`æ‰“æˆä¸€ä¸ªåŒ…ã€‚æ‰“åŒ…å¤–éƒ¨ä¾èµ–ï¼ˆç¬¬ä¸‰æ–¹ï¼‰ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚æ¯”å¦‚ï¼š

```js
// å…¥å£ main.js
import Axios from 'axios'
Axios.get()
console.log(1111)

------ æ‰“åŒ…åçš„ç»“æœ ------
// æœ€ç»ˆä¼šæŠŠaxiosçš„æºä»£ç  å’Œ main.js ä¸»ä»£ç ï¼Œæ‰“åŒ…åˆ°ä¸€ä¸ªæ–‡ä»¶å†…ï¼Œæ— é¢å¤–ä»£ç æ³¨å…¥ 
// ä»¥ä¸‹æ˜¯æˆªå–äº†ä¸€å¤´ä¸€å°¾ï¼Œä¸­é—´çœç•¥
import require$$1$1 from 'http';
import require$$2 from 'https';
import require$$0$1 from 'url';
import require$$3 from 'assert';
import require$$4 from 'stream';
import require$$0 from 'tty';
import require$$1 from 'util';
import require$$7 from 'zlib';

var axios$1 = {exports: {}};

var bind$2 = function bind(fn, thisArg) {
  return function wrap() {
    var args = new Array(arguments.length);
    for (var i = 0; i < args.length; i++) {
      args[i] = arguments[i];
    }
    return fn.apply(thisArg, args);
  };
};

...
...
...

axios$1.exports = axios;

// Allow use of default import syntax in TypeScript
axios$1.exports.default = axios;

var _axios_0_18_1_axios = axios$1.exports;
_axios_0_18_1_axios.get();
console.log(1111);
```

**æ­¤å¤„`rollup`æ‰“åŒ…æœ‰ä¸ªæ³¨æ„ç‚¹**ï¼š

- å¾ˆå¤šç¬¬ä¸‰æ–¹ä¾èµ–å¾ˆæ—©å°±æœ‰äº†ï¼Œæ‰€ä»¥ç”¨çš„æ˜¯**`commonjs`æ¨¡å—å¯¼å‡º**ï¼Œ`rollup`æ‰“åŒ…çš„è¯ï¼Œéœ€è¦å®‰è£…æ’ä»¶`@rollup/plugin-node-resolve`ã€‚å› ä¸ºæ˜¯`cjs`çš„åŒ…ï¼Œæ‰€ä»¥ä¹Ÿä¸å­˜åœ¨`tree shaking`
  - æ’ä»¶åŸç†æ˜¯ï¼ŒæŠŠ`cjs`çš„åŒ…ï¼Œè½¬æˆ`esm`åŒ…ï¼Œåœ¨æ‰“åŒ…
- ç°åœ¨æ¯”è¾ƒæµè¡Œçš„`monorepo`ï¼Œå°±æ˜¯å®Œå…¨ç”¨`esm`å†™åº“+`rollup`æ‰“åŒ…ï¼Œå¯ä»¥å¾ˆè½»æ˜“çš„åšåˆ°`tree shaking`ï¼Œ**è®©æ ¸å¿ƒåº“å˜çš„æ›´å°ï¼Œè§£æé€Ÿåº¦æ›´å¿«ï¼Œè¿˜å¯ä»¥å¯¹å¤–æä¾›å·¥å…·ï¼Œæ‰©å¤§å½±å“åŠ›**

## å¤šä¸ª`chunk`åŒ…ï¼ˆä»£ç åˆ†ç¦»ï¼‰

1. é…ç½®å¤šä¸ªå…¥å£ï¼Œæ­¤æ³•æ¯”è¾ƒç®€å•ï¼Œå¯è‡ªè¡Œæµ‹è¯•

   ```js
   // rollup.config.js
    input: {            
        index: 'src/main.js',            
        other: 'src/other.js',            
    },
   ```

2. ä»£ç åˆ†ç¦» ï¼ˆ**åŠ¨æ€`import`ï¼Œæ‡’åŠ è½½ï¼Œ `import(xxx).then(module => {}`)** ï¼‰

- æ­¤å¤„æœ‰ä¸€ä¸ªå®˜æ–¹çš„ä¾‹å­ï¼Œå†æ¸…æ¥šä¸è¿‡äº†

  ```js
  // å…¥å£ main.js
  /* DYNAMIC IMPORTS åŠ¨æ€import
      Rollup supports automatic chunking and lazy-loading  Rollupæ”¯æŒè‡ªåŠ¨åˆ†å—å’Œæ‡’åŠ è½½
      via dynamic imports utilizing the import mechanism   é€šè¿‡dynamic importsåŠ¨æ€å¯¼å…¥
      of the host system. 
      */
  if (displayMath) {
      import('./maths.js').then(function (maths) {
              console.log(maths.square(5));
              console.log(maths.cube(5));
      });
  }
  
  // './maths.js'
  import square from './square.js';
  export {default as square} from './square.js';
  export function cube (x ) {
          return square(x) * x;
  }
  
  // './square.js'
  export default function square ( x ) {
          return x * x;
  }
  
  
  ---------------- æ‰“åŒ…ç»“æœ ----------------
  // main.js
  'use strict';
  /* DYNAMIC IMPORTS åŠ¨æ€import
      Rollup supports automatic chunking and lazy-loading  Rollupæ”¯æŒè‡ªåŠ¨åˆ†å—å’Œæ‡’åŠ è½½
      via dynamic imports utilizing the import mechanism   é€šè¿‡dynamic importsåŠ¨æ€å¯¼å…¥
      of the host system. 
      */
  if (displayMath) {
          // æ‰“åŒ…æˆcjsæ¨¡å—çš„è¯ï¼Œimportæ›¿æ¢æˆ Promise + require
          // Promise.resolve(require('../chunk-0ee5c472.js')).then(function (maths) {
          import('../chunk-c4d97f01.js').then(function (maths) {
                  console.log(maths.square(5));
                  console.log(maths.cube(5));
          });
  }
  
  // '../chunk-0ee5c472.js'
  'use strict';
  function square ( x ) {
          return x * x;
  }
  function cube (x ) {
          return square(x) * x;
  }
  exports.cube = cube;
  exports.square = square;
  ```

  å¯¹äºä»£ç åˆ†å‰²ï¼Œè¿˜æœ‰ä¸€ç§æ–¹æ³•å¯ä»¥é€šè¿‡ **`output.manualChunks`** é€‰é¡¹**æ˜¾å¼**å‘Šè¯‰ `Rollup` å“ªäº›æ¨¡å—è¦**åˆ†å‰²æˆå•ç‹¬çš„å—**ã€‚

## **æ€»ç»“**ï¼š

- **åŠ¨æ€`import`ï¼Œ`rollup`å¯¹æ¯”`webpack`æ‰“åŒ…åçš„æ¨¡å—æ ¼å¼çš„æ”¯æŒåº¦**

  | æ‰“åŒ…åçš„æ¨¡å—æ ¼å¼ï¼š | `esm`          | `cjs` | `amd` | `umd`  |
  | ------------------ | -------------- | ----- | ----- | ------ |
  | `webpack`          | ä¸æ”¯æŒï¼Œå®éªŒä¸­ | æ”¯æŒ  | æ”¯æŒ  | æ”¯æŒ   |
  | `rollup`           | æ”¯æŒ           | æ”¯æŒ  | æ”¯æŒ  | ä¸æ”¯æŒ |

- å®ç°åŸç†ï¼Œå¯¹æ¯”`webpack`ï¼š

  - `webpack`æ˜¯è‡ªå·±å®ç°çš„â€œåŠ¨æ€`import`â€œï¼ˆå€ŸåŠ©`promise + script`æ ‡ç­¾ + `window`å¯¹è±¡ + æ¨¡æ‹Ÿ`import`æ–¹æ³•ï¼‰

  - `rollup`æ˜¯  ï¼ˆæ‰“åŒ…æˆesmæ¨¡å—ï¼‰åˆ©ç”¨æµè§ˆå™¨ï¼ˆ`chorme63` ä»¥ä¸Šï¼‰å¤©ç„¶æ”¯æŒ

    åŠ¨æ€`import`æˆ–  ï¼ˆæ‰“åŒ…æˆ`cjs`æ¨¡å—ï¼‰`promise + cjs`çš„`require`

- **æ­¤å¤„æœ‰ä¸ªå¾ˆé‡è¦ç»†èŠ‚ç‚¹**

  - `rollup`æ‰“çš„åŒ…ï¼Œå¦‚æœè¦ç”¨ åŠ¨æ€`import`ï¼ˆç°åœ¨`vue`å’Œ`react`çš„å•é¡µé¡¹ç›® ç‰¹åˆ«æµè¡Œç”¨åŠ¨æ€`import`åŠ è½½è·¯ç”±ï¼Œç®—ç¡¬éœ€æ±‚äº†ï¼‰

  - æ³¨æ„å¦‚æœè¦åœ¨æµè§ˆå™¨ä¸Šè·‘ï¼Œé¦–å…ˆè¦æ˜¯`esm`çš„åŒ…ï¼ˆæµè§ˆå™¨ä¸æ”¯æŒ`cjs`ï¼‰ï¼Œç„¶åæµè§ˆå™¨ç‰ˆæœ¬è¦æ³¨æ„ï¼ˆ`chorme63` ä»¥ä¸Šï¼‰ï¼Œå› ä¸º`rollup`ä¸åšé¢å¤–ä»£ç æ³¨å…¥ï¼Œå®Œå…¨åˆ©ç”¨é«˜ç‰ˆæœ¬æµè§ˆå™¨åŸç”Ÿæ”¯æŒ`import`ï¼ˆæ‰€ä»¥ä»£ç ç‰¹åˆ«å¹²å‡€ï¼Œ`webpack`ä¼šåšå¤§é‡çš„å…¼å®¹ è‡ªå·±å®ç°`require`å’Œ`import`ï¼‰

    ![webpack178](..\images\webpack178.png)

## `rollup`å¦‚ä½•å¤„ç†å…¬å…±æ¨¡å—ï¼Ÿï¼ˆæ¯”å¦‚ï¼Œ `aã€bã€c` 3ä¸ªæ¨¡å— åŒæ—¶ä¾èµ– `d`ï¼‰

**æœ‰2ç§æƒ…å†µï¼š**

1. æºä»£ç å†… **ä¸å­˜åœ¨ åŠ¨æ€`import`**ï¼Œé‚£ä¹ˆä¼šæ‰“æˆ**ä¸€ä¸ª`chunk`**ï¼ˆ`aã€bã€cã€d` 4ä¸ªæ¨¡å—éƒ½åœ¨ä¸€åŒ…å†…ï¼Œ`d`åªæ­£å¸¸æœ‰ä¸€ä»½ï¼‰

2. æºä»£ç å†… **å­˜åœ¨ æ‡’åŠ è½½æ¨¡å—ï¼Œå¹¶ä¸”æ‡’åŠ è½½çš„æ¨¡å—ä¹Ÿè®¿é—®äº†å…¬å…±ä¾èµ–**ï¼Œæ¯”å¦‚

   ```js
   // å…¥å£ main.js
   import {deepCopy} from '@xxx/methods/deepCopy.js' // è¿™æ˜¯æ”¾åœ¨å…¬å¸çš„npmåŸŸå†…çš„ä¸€ä¸ªåŒ…ï¼Œå¯ä»¥ç†è§£ä¸ºexportä¸€ä¸ªç®€å•çš„deepCopyå‡½æ•°
   console.log(deepCopy(a))
   import('./test/a').then(e => {
     console.log(e)
   })
   
   // './test/a' æ‡’åŠ è½½æ¨¡å— ä¹Ÿä¾èµ– åŒä¸€å…¬å…±æ¨¡å—
   import {deepCopy} from '@xxx/methods/deepCopy.js'
   const a = {a: 1}
   export const b = deepCopy(a)
   
   ---------- æ˜¯å¦ä¼šæŠŠ å…¬å…±ä¾èµ–  æ‰“åŒ…2ä»½å‘¢?  --------------
   ç­”æ¡ˆæ˜¯noï¼Œrollupè¿˜æ˜¯ç‰›pï¼Œå…¬å…±ä¾èµ–åªä¼šå‡ºæ¥ä¸€ä»½ï¼Œç„¶åå¯¹å¤– export  ï¼ˆæ­¤å¤„ä¸¾ä¾‹æ˜¯å¯¼å‡ºesmæ ¼å¼ï¼Œ äº²æµ‹å¯¼å‡ºcjsæ ¼å¼ä¸€æ ·çš„å¯ä»¥ï¼Œæ­¤å¤„å°±ä¸èµ˜è¿°ï¼Œæœ‰å…´è¶£å¯ä»¥è‡ªå·±testä¸€ä¸‹ï¼‰
   
   ç”Ÿæˆçš„ç›®å½•ç»“æ„ï¼Œæœ‰3ä¸ªæ–‡ä»¶
       a-19173be8.js
       main.js
       main-219c2eaf.js
   
   // main.js
   import './main-219c2eaf.js';
   
   // main-219c2eaf.js
   const deepCopy = function (obj) {
     // do ..
   };
   console.log(deepCopy(a));
   import('./a-19173be8.js').then(e => {
     console.log(e);
   });
   
   // a-19173be8.js
   import { d as deepCopy } from './main-219c2eaf.js';
   const a = {a: 1};
   const b = deepCopy(a);
   export { b };
   ```

   æ€»ç»“ï¼š**å¯¹äºå…¬å…±ä¾èµ–ï¼Œ`rollup`ä¸ä¼šå‡ºç°é‡å¤æ‰“åŒ…çš„æƒ…å†µï¼å¹¶ä¸”å®Œå…¨æ— æ³¨å…¥ä»£ç ï¼æ— éœ€é¢å¤–é…ç½®ã€‚**  å¯¹æ¯”`webpack`çš„è¯ï¼Œ`webpack`éœ€è¦é…ç½® `optimization.splitChunks` ï¼ˆ`webpack4.x` ä»¥ä¸Šï¼‰

# ä¸ƒã€**æ€»ç»“** `rollup vs webpack`

## 1ã€åº”ç”¨åœºæ™¯ä¸åŒ

å¯¹äºåº”ç”¨åœºæ™¯è€Œè¨€ï¼Œ`Webpack` é€šå¸¸ç”¨äºå¤æ‚åº”ç”¨çš„æ‰“åŒ…ï¼Œè¿™ç§åº”ç”¨å¤§å¤šæ˜¯ç”±å¤šä¸ªå•ç‹¬çš„æ¨¡å—ç»„æˆçš„ï¼Œå¹¶ä¸”ä½¿ç”¨äº†**å¤šç§èµ„æº**ï¼ˆä¾‹å¦‚å›¾ç‰‡ã€æ ·å¼è¡¨ç­‰ï¼‰ã€‚`Webpack` é€‚åˆè¿™ç§å¤æ‚åº”ç”¨çš„æ‰“åŒ…ï¼Œå› ä¸ºå®ƒèƒ½å¤Ÿå¤„ç† `JavaScript` èµ„æºä»¥å¤–çš„ä»»ä½•æ–‡ä»¶ï¼ŒåŒæ—¶è¿˜æ”¯æŒå„ç§æ’ä»¶ï¼Œä¾‹å¦‚ä»£ç å‹ç¼©ã€ä»£ç åˆ†ç¦»ã€çƒ­æ›´æ–°ç­‰ç­‰ã€‚

å¦ä¸€æ–¹é¢ï¼Œ`Rollup` æ›´é€‚åˆç”¨äºåº“çš„æ‰“åŒ…ï¼Œå°¤å…¶æ˜¯é‚£äº›ä¸“æ³¨äº `ES6` æ¨¡å—çš„åº“ã€‚è¿™æ˜¯å› ä¸º `Rollup` çš„ç›®æ ‡æ˜¯äº§ç”Ÿ**å°½å¯èƒ½å°å’Œå°½å¯èƒ½å¿«**çš„ä»£ç ï¼Œè€Œä¸”å®ƒèƒ½å¤Ÿåˆ†ææ‰€æœ‰çš„ `ES6` æ¨¡å—ï¼Œåˆ é™¤ä¸éœ€è¦çš„ä»£ç ï¼Œå¹¶å°†è®¡ç®—åˆå¹¶åœ¨ä¸€èµ·ï¼Œä»è€Œäº§ç”Ÿå‡ºæ›´å°æ›´å¿«çš„ä»£ç ï¼Œè¿™æ ·çš„è¾“å‡ºå¯ä»¥åœ¨æ‰€æœ‰çš„ç°ä»£æµè§ˆå™¨ä¸­é€å­—è§£æã€‚

ä½¿ç”¨ `Rollup` çš„å¼€æºé¡¹ç›®ï¼š

- `react`
- `vue`
- `vuex`
- `vue-router`

![webpack181](..\images\webpack181.png)

ä½¿ç”¨`webpack`çš„é¡¹ç›®ï¼š

- `elemnt-ui`
- `mint-ui`
- `vue scaffold`

![webpack182](..\images\webpack182.png)

å¯ä»¥çœ‹å‡º `Webpack` æ›´åå‘å‰ç«¯å·¥ç¨‹ï¼Œ`Rollup` æ›´åå‘äº `JavaScript` åº“

## 2ã€æ‰“åŒ…æ–¹å¼ä¸åŒ

å¯¹äºæ‰“åŒ…æ–¹å¼è€Œè¨€ï¼Œ`Webpack` çš„æ‰“åŒ…æ–¹å¼æ˜¯å°†æ‰€æœ‰çš„æ–‡ä»¶æ‰“åŒ…åœ¨ä¸€èµ·ï¼Œä»¥å½¢æˆä¸€ä¸ªæˆ–å¤šä¸ªæ–‡ä»¶ï¼Œ**è¿™äº›æ–‡ä»¶åŒ…å«äº†æ‰€æœ‰çš„ `JavaScript`ã€æ ·å¼è¡¨ã€å›¾åƒå’Œå­—ä½“ç­‰ç­‰**ã€‚åŒæ—¶è¿˜éœ€è¦å¤„ç†æ¯”è¾ƒå¤æ‚çš„ä»£ç å’Œä¾èµ–å…³ç³»ï¼Œè¿˜éœ€è¦è¿›è¡Œä¸€ç³»åˆ—çš„ä¼˜åŒ–å’Œå¤„ç†ï¼Œæ¯”å¦‚åŠ è½½å’Œè§£ææ¨¡å—ï¼Œåˆ†ç¦»å‡ºå…±äº«ä»£ç ç­‰ï¼Œæ‰€ä»¥ `Webpack` ä¼šç›¸å¯¹æ…¢ä¸€äº›ã€‚

`Rollup` é»˜è®¤æ˜¯åªç”Ÿæˆä¸€ä¸ªæ–‡ä»¶ï¼Œä¼šä»å…¥å£æ–‡ä»¶å¼€å§‹**éå†æ•´ä¸ªä¾èµ–å›¾**ï¼Œå¹¶åªå°†é¡¹ç›®çš„æ‰€éœ€éƒ¨åˆ†åŒ…å«åœ¨ç”Ÿæˆçš„  `JavaScript`æ–‡ä»¶ä¸­ã€‚è¿™ç§æ–¹å¼é€šå¸¸æœ‰æ•ˆåœ°æ¸…é™¤äº†ç”Ÿæˆæ–‡ä»¶ä¸éœ€è¦çš„éƒ¨åˆ†å¹¶ç”Ÿæˆæ›´å°ï¼Œæ›´å¿«çš„è¾“å‡ºã€‚

> å…³é”®åœ¨äºåªå…³æ³¨ `ES6` æ¨¡å—å¤„ç†ï¼Œå¹¶ä¸”èƒ½å¤Ÿæ›´å¥½åœ°åˆ©ç”¨ `Tree Shaking` ç­‰æŠ€æœ¯æ¶ˆé™¤ä¸å¿…è¦çš„ä»£ç ã€‚

## 3ã€è®¿é—®é€Ÿåº¦ä¸åŒ

åœ¨è®¿é—®é€Ÿåº¦æ–¹é¢ï¼Œå› ä¸º **`Webpack`  æ‰“åŒ…åçš„æ–‡ä»¶è¾ƒå¤§**ï¼Œæ‰€ä»¥å®ƒéœ€è¦èŠ±è´¹æ›´é•¿çš„æ—¶é—´ä¸‹è½½ã€‚æ­¤å¤–ï¼Œç”±äºå…¶ä¸­åŒ…å«è¿è¡Œæ—¶ç¯å¢ƒï¼Œå› æ­¤å®ƒéœ€è¦æ—¶é—´æ¥è§£æä»£ç ã€‚

`Rollup` çš„**è¾“å‡ºæ–‡ä»¶æ›´å°**ï¼Œæ‰€ä»¥å®ƒéœ€è¦æ›´å°‘çš„æ—¶é—´å»ä¸‹è½½ï¼ŒåŒæ—¶å®ƒä¸åŒ…å«ä»»ä½•å¤šä½™çš„ä»£ç ï¼Œå› æ­¤å®ƒå¯ä»¥æ›´å¿«åœ°åŠ è½½å’Œè¿è¡Œã€‚

ä¸‹å›¾æ˜¯ `Rollup` å’Œ `Webpack` æ‰“å‡ºçš„ `bundle`ï¼Œå¯ä»¥çœ‹åˆ° `Rollup` éå¸¸çš„ç®€æ´

![webpack183](..\images\webpack183.png)

## 4ã€ç”Ÿæ€å’Œæ‰©å±•æ€§ä¸åŒ

å¯¹äºç”Ÿæ€å’Œæ‰©å±•æ€§è€Œè¨€ï¼Œ`Webpack` çš„æ‰©å±•æ€§éå¸¸å¼ºå¤§ï¼Œå®ƒæœ‰ç€ä¼—å¤šçš„æ’ä»¶å’Œ `Loader` å¯ä»¥ä½¿ç”¨ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ä¸ºæˆ‘ä»¬çš„åº”ç”¨æ·»åŠ å„ç§åŠŸèƒ½å’Œç‰¹æ€§ï¼Œè€Œä¸ç”¨è‡ªå·±å»å®ç°ä¸€ä¸ª

ä¾‹å¦‚æˆ‘ä»¬ç”¨ `CSS loader` å’Œ `style loader` æ¥å¤„ç† `CSS` ä»£ç ï¼Œç”¨ `Babel loader` æ¥å¤„ç†æœ€æ–°çš„ `JavaScript` ä»£ç ç­‰ç­‰

> åœ¨å‰é¢æˆ‘ä»¬ä¸æ–­çš„æåˆ°äº† `Rollup` æ˜¯ `ESModule` çš„äº§ç‰©ï¼Œé‚£ä¹ˆ**ä¸ºä»€ä¹ˆ `ESModule` ä¼šæ¯” `CommonJS` å¿«å‘¢ï¼Ÿ**
>
> `ESModule` å’Œ `CommonJS`éƒ½æ˜¯æ¨¡å—åŒ–çš„æ ‡å‡†åŒ–æ–¹æ¡ˆï¼Œä½†å®ƒä»¬åœ¨åŠ è½½æ¨¡å—æ—¶çš„å®ç°æ–¹å¼ä¸åŒã€‚
>
> `CommonJS require` æ˜¯**åŒæ­¥åŠ è½½æ¨¡å—**ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ä¸ªæ¨¡å—åœ¨è¢«å¼•å…¥åï¼Œå¼•å…¥æ¨¡å—çš„ä»£ç ä¼šç­‰å¾…æ¨¡å—åŠ è½½å®Œæˆæ‰ç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚
>
> `CommonJS`æ¨¡å—æ˜¯ `ESModule` æå‡ºå‰çš„ä¸€ç§æš‚æ—¶æ€§è§£å†³æ–¹æ¡ˆï¼Œæœªæ¥å‘å±•ç¼“æ…¢ã€‚
>
> è€Œ `ESModule import` æ˜¯**å¼‚æ­¥åŠ è½½æ¨¡å—**ï¼Œå®ƒå…è®¸æµè§ˆå™¨åœ¨è§£æ `JavaScript` ä»£ç æ—¶ï¼Œå°†æ¨¡å—çš„åŠ è½½æ”¾åˆ°åå°å»ï¼Œè®©æ‰§è¡Œçº¿ç¨‹ä¸è¢«é˜»å¡ã€‚è¿™ç§å¹¶è¡ŒåŠ è½½çš„æ–¹æ³•èƒ½å¤Ÿæé«˜ `JavaScript` ä»£ç çš„æ‰§è¡Œæ•ˆç‡ã€‚
>
> `ESModule` å¯ä»¥åœ¨**ç¼–è¯‘æ—¶è¿›è¡Œé™æ€ä¼˜åŒ–**ï¼Œè¿˜æ”¯æŒ `Tree shaking`ï¼Œå¯ä»¥åœ¨ä»£ç æ‰“åŒ…æ—¶åˆ é™¤æœªä½¿ç”¨çš„ä»£ç ï¼Œä»è€Œå‡å°‘æ‰“åŒ…åä»£ç çš„ä½“ç§¯å’ŒåŠ è½½æ—¶é—´ï¼Œè¿™ä¹Ÿæ˜¯ `ESModule` æ¯” `CommonJS`æ›´å¿«çš„åŸå› ä¹‹ä¸€ã€‚åŒæ—¶è¿˜æä¾›äº†ä¸€äº›é«˜çº§ç‰¹æ€§ï¼Œæ¯”å¦‚å¾ªç¯å¼•ç”¨å’Œå®æ—¶ç»‘å®š
>
> **æœ€å…³é”®çš„ä¸¤ä¸ªåŸå› å°±æ˜¯ `TreeShaking` å’Œ å¼‚æ­¥åŠ è½½**
>
> åŒæ—¶ `ESModule` çš„å…¼å®¹æ€§æ›´ä½³ï¼Œåœ¨æœªæ¥å°†å˜å¾—æ›´åŠ é‡è¦ã€‚

## 5ã€æ€»ç»“

`Webpack` å’Œ `Rollup`  ä¸»è¦å­˜åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢çš„ä¸åŒ

- æ‰“åŒ…é…ç½®ä¸åŒ
- ä¸åŒæ–‡ä»¶ç±»å‹çš„è½¬æ¢ä¸åŒï¼Œ`Webpack` ç”¨ `loader`ï¼Œ`Rollup` ç”¨ `plugins`
- `dev-server` ä¸åŒï¼Œ`HMR` ä¸åŒï¼ˆ`Rollup` æ²¡æœ‰ï¼‰
- `Tree shaking` å®ç°ä¸åŒ
- åº”ç”¨åœºæ™¯ä¸åŒ
- æ‰“åŒ…æ–¹å¼ä¸åŒï¼Œ
- è®¿é—®é€Ÿåº¦
- ç”Ÿæ€å’Œæ‰©å±•æ€§

åœ¨ä¸åŒåœºæ™¯ä¸‹ï¼Œ`Webpack`  å’Œ `Rollup` éƒ½èƒ½å‘æŒ¥è‡ªèº«ä¼˜åŠ¿ä½œç”¨ã€‚

`Webpack` å¯¹äº**ä»£ç åˆ†å‰²å’Œé™æ€èµ„æºå¯¼å…¥**æœ‰ç€â€œå…ˆå¤©ä¼˜åŠ¿â€ï¼Œå¹¶ä¸”æ”¯æŒ `HMR`ï¼Œè€Œ `Rollup` å¹¶ä¸æ”¯æŒï¼Œæ‰€ä»¥å½“é¡¹ç›®éœ€è¦ç”¨åˆ°ä»¥ä¸Šï¼Œåˆ™å¯ä»¥è€ƒè™‘é€‰æ‹© `Webpack` ã€‚

ä½†æ˜¯ï¼Œ`Rollup` å¯¹äº `Tree shaking`å’Œ `ES6` æ¨¡å—æœ‰ç€ç®—æ³•ä¼˜åŠ¿ä¸Šçš„æ”¯æŒï¼Œè‹¥ä½ é¡¹ç›®åªéœ€è¦æ‰“åŒ…å‡ºä¸€ä¸ªç®€å•çš„`bundle`åŒ…ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ `Rollup` ï¼Œä¼šæœ‰ä»¥ä¸‹ä¸‰ç‚¹çš„æ”¶ç›Šã€‚

- **ç¬¬ä¸€ç‚¹æ˜¯æ„å»ºé€Ÿåº¦æ˜æ˜¾å¿«äº`Webpack` **
- **ç¬¬äºŒç‚¹æ˜¯å…¶ç”Ÿæˆçš„ä»£ç é‡å¾ˆå°**
- **ç¬¬ä¸‰ç‚¹æ˜¯å…¶é…ç½®æ–¹å¼å…¶å®éå¸¸ç®€å•ã€‚**

å…¶å® `Webpack` **ä¹Ÿæ”¯æŒ`Tree shaking`ï¼Œå¹¶ä¸”ä¹Ÿèƒ½å¤Ÿé€šè¿‡ `Babel-loader` æ¥æ‰“åŒ… `ES6` ä»£ç **ï¼Œ`Rollup` å·²ç»åœ¨æ¸æ¸åœ°å¤±å»äº†å½“åˆçš„ä¼˜åŠ¿äº†ã€‚

ä½†æ˜¯ `Rollup` ä»ç„¶ä¾é ç®€å•çš„ `API` å’Œä½¿ç”¨æ–¹å¼è¢«è®¸å¤šåº“å¼€å‘è€…é’çï¼Œå¦‚ `React`ã€`Vue` ç­‰ï¼Œéƒ½æ˜¯ä½¿ç”¨ `Rollup` ä½œä¸ºæ„å»ºå·¥å…·çš„ã€‚

è€Œåœ¨ä¸­å¤§å‹ `Web` åº”ç”¨å¼€å‘ä¸‹ï¼Œ`Webpack` ä¼šæ›´å—é’çï¼Œå¹¶ä¸”ä¼šæ›´åˆé€‚ä¸€äº›ã€‚

### `rollup`è¯ç”Ÿåœ¨`esm`æ ‡å‡†å‡ºæ¥å

- **å‡ºå‘ç‚¹å°±æ˜¯å¸Œæœ›å¼€å‘è€…å»å†™`esm`æ¨¡å—**ï¼Œè¿™æ ·é€‚åˆåšä»£ç é™æ€åˆ†æï¼Œå¯ä»¥åš`tree shaking`å‡å°‘ä»£ç ä½“ç§¯ï¼Œä¹Ÿæ˜¯æµè§ˆå™¨é™¤äº†`script`æ ‡ç­¾å¤–ï¼ŒçœŸæ­£è®©`JavaScript`æ‹¥æœ‰æ¨¡å—åŒ–èƒ½åŠ›ã€‚æ˜¯`js`è¯­è¨€çš„æœªæ¥

- `rollup`å®Œå…¨ä¾èµ–é«˜ç‰ˆæœ¬æµè§ˆå™¨åŸç”Ÿå»æ”¯æŒ`esm`æ¨¡å—ï¼Œæ‰€ä»¥æ— é¢å¤–ä»£ç æ³¨å…¥ï¼Œæ‰“åŒ…åçš„ä»£ç ç»“æ„ä¹Ÿæ˜¯æ¸…æ™°çš„

  ï¼ˆä¸ç”¨åƒ`webpack`é‚£æ ·`iife`ï¼‰

- ç›®å‰æµè§ˆå™¨æ”¯æŒæ¨¡å—åŒ–åªæœ‰3ç§æ–¹æ³•ï¼š
  - â‘ `script`æ ‡ç­¾ï¼ˆç¼ºç‚¹æ²¡æœ‰ä½œç”¨åŸŸçš„æ¦‚å¿µï¼‰
  - â‘¡`script`æ ‡ç­¾ + `iife`+ `window` + å‡½æ•°ä½œç”¨åŸŸï¼ˆå¯ä»¥è§£å†³ä½œç”¨åŸŸé—®é¢˜ã€‚`webpack`çš„æ‰“åŒ…çš„äº§ç‰©å°±è¿™æ ·ï¼‰
  - â‘¢`esm` ï¼ˆä»€ä¹ˆéƒ½å¥½ï¼Œå”¯ä¸€ç¼ºç‚¹ éœ€è¦é«˜ç‰ˆæœ¬æµè§ˆå™¨ï¼‰

### `webpack`è¯ç”Ÿåœ¨`esm`æ ‡å‡†å‡ºæ¥å‰ï¼Œ`commonjs`å‡ºæ¥å

- å½“æ—¶çš„æµè§ˆå™¨åªèƒ½é€šè¿‡`script`æ ‡ç­¾åŠ è½½æ¨¡å—ï¼Œ`script`æ ‡ç­¾åŠ è½½ä»£ç æ˜¯æ²¡æœ‰ä½œç”¨åŸŸçš„ï¼Œåªèƒ½åœ¨ä»£ç å†… ç”¨`iife`çš„æ–¹å¼ å®ç°ä½œç”¨åŸŸæ•ˆæœï¼Œ**è¿™å°±æ˜¯`webpack`æ‰“åŒ…å‡ºæ¥çš„ä»£ç  å¤§ç»“æ„éƒ½æ˜¯`iife`çš„åŸå› **ï¼Œå¹¶ä¸”**æ¯ä¸ªæ¨¡å—éƒ½è¦è£…åˆ°`function`é‡Œé¢**ï¼Œæ‰èƒ½ä¿è¯äº’ç›¸ä¹‹é—´ä½œç”¨åŸŸä¸å¹²æ‰°ã€‚**è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ `webpack`æ‰“åŒ…çš„ä»£ç ä¸ºä»€ä¹ˆä¹çœ‹ä¼šæ„Ÿè§‰ä¹±ï¼Œæ‰¾ä¸åˆ°è‡ªå·±å†™çš„ä»£ç çš„çœŸæ­£åŸå› **
- å…³äº`webpack`çš„ä»£ç æ³¨å…¥é—®é¢˜ï¼Œæ˜¯å› ä¸ºæµè§ˆå™¨ä¸æ”¯æŒ`cjs`ï¼Œæ‰€ä»¥`webpack`è¦å»è‡ªå·±å®ç°`require`å’Œ`module.exports`æ–¹æ³•ï¼ˆæ‰æœ‰å¾ˆå¤šæ³¨å…¥ï¼‰è¿™ä¹ˆå¤šå¹´äº†ï¼Œç”šè‡³åˆ°ç°åœ¨2022å¹´ï¼Œæµè§ˆå™¨ä¸ºä»€ä¹ˆä¸æ”¯æŒ`cjs`ï¼Ÿ
  - **`cjs`æ˜¯åŒæ­¥çš„ï¼Œè¿è¡Œæ—¶çš„ï¼Œ`node`ç¯å¢ƒç”¨`cjs`ï¼Œ`node`æœ¬èº«è¿è¡Œåœ¨æœåŠ¡å™¨ï¼Œæ— éœ€ç­‰å¾…ç½‘ç»œæ¡æ‰‹ï¼Œæ‰€ä»¥åŒæ­¥å¤„ç†æ˜¯å¾ˆå¿«çš„**
  - **æµè§ˆå™¨æ˜¯ å®¢æˆ·ç«¯ï¼Œè®¿é—®çš„æ˜¯æœåŠ¡ç«¯èµ„æºï¼Œä¸­é—´éœ€è¦ç­‰å¾…ç½‘ç»œæ¡æ‰‹ï¼Œå¯èƒ½ä¼šå¾ˆæ…¢ï¼Œæ‰€ä»¥ä¸èƒ½ åŒæ­¥çš„ å¡åœ¨é‚£é‡Œç­‰æœåŠ¡å™¨è¿”å›çš„ï¼Œä½“éªŒå¤ªå·®**
- **åç»­å‡ºæ¥esmåï¼Œ`webpack`ä¸ºäº†å…¼å®¹ä»¥å‰å‘åœ¨`npm`ä¸Šçš„è€åŒ…**ï¼ˆå¹¶ä¸”å½“æ—¶å¿ƒè¿˜ä¸å¤Ÿå†³ç»ï¼Œå¯¼è‡´è¿™ç§â€œä¸‘ç»“æ„çš„åŒ…â€è¶Šæ¥è¶Šå¤šï¼Œä»¥åå°±æ›´ä¸å¯èƒ½æ”¹è¿™ç§â€œä¸‘ç»“æ„äº†â€ï¼‰ï¼Œæ‰€ä»¥ä¿ç•™è¿™ä¸ª`iife`çš„ç»“æ„å’Œä»£ç æ³¨å…¥ï¼Œ**å¯¼è‡´ç°åœ¨çœ‹`webpack`æ‰“åŒ…çš„äº§ç‰©ï¼Œä¹çœ‹ç»“æ„æ¯”è¾ƒä¹±ä¸”æœ‰å¾ˆå¤šçš„ä»£ç æ³¨å…¥ï¼Œè‡ªå·±å†™çš„ä»£ç éƒ½æ‰¾ä¸åˆ°**

# å…«ã€æœ€ç»ˆä½¿ç”¨æ¨è

#### æ‰“åŒ…**å¼€æºåº“**ï¼š**ä¸ç”¨æ€è€ƒï¼Œ`rollup`ä¼šæ˜¯ä½ æ›´å¥½çš„é€‰æ‹©**

- `rollup`æœ¬èº«ä¹Ÿæ”¯æŒå¾ˆå¤šæ’ä»¶ï¼Œç”Ÿæ€ä¹Ÿæˆç†Ÿï¼Œå„ç§åœºæ™¯å‡ ä¹éƒ½èƒ½ç…§é¡¾åˆ°

#### æ‰“åŒ…**åº”ç”¨ç¨‹åº**ï¼šä¸ªäººæ¨èï¼Œçœ‹æ‚¨çš„ åº”ç”¨ç¨‹åº **éœ€ä¸éœ€è¦å…¼å®¹è€æµè§ˆå™¨**

å…¼å®¹è¡¨å¦‚ä¸‹ï¼ˆå…¶å®å°±æ˜¯ åŠ¨æ€`import`çš„å…¼å®¹è¡¨ ï¼‰ ä»¥`chorme`ä¸ºä¾‹ï¼Œéœ€è¦`chorme63`ä»¥ä¸Š

![webpack179](..\images\webpack179.png)

**å¦‚æœä¸è€ƒè™‘å…¼å®¹è€æµè§ˆå™¨ï¼Œå»ºè®®ç”¨ `vite` å¼€å‘åº”ç”¨ç¨‹åº**

- **`dev`å¼€å‘æ–¹é¢**ï¼š`vite`æä¾›`dev`æœåŠ¡å™¨ï¼Œä»¥åŠæ¯”`webpack`å¿«çš„å¤šçš„çƒ­æ›´æ–°ï¼Œ`dev`å¼€å‘çš„ä½“éªŒæ›´å¥½äº†
- `prd`ç”Ÿäº§æ–¹é¢ï¼š`vite`æ‰“ç”Ÿäº§åŒ…ï¼Œå®é™…ä¸Šç”¨çš„å°±æ˜¯`rollup`ï¼Œæ‰“çš„ç”Ÿäº§åŒ…æ¯”ç”¨`webpack`å°äº†å¾ˆå¤šï¼Œæœ‰ä¸é”™çš„æ€§èƒ½æå‡
- **ç†è®ºä¸Š `chorme63`ä»¥ä¸Š å¯ä»¥å¼€ç®±å³ç”¨ï¼Œ`chorme63`ä»¥ä¸‹ä¹Ÿä¸æ˜¯å®Œå…¨ä¸èƒ½ç”¨**ï¼Œéœ€è¦è‡ªå·±åŠ `polyfill`æˆ–`vite`æ’ä»¶