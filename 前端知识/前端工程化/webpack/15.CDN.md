# 一、`CDN`概念

`CDN`全称叫做“`Content Delivery Network`”，中文叫**内容分发网络**，和 `DNS` 结合，让用户访问延迟最小的节点，当用户请求资源时，就近返回节点上缓存的资源，而不需要每个用户的请求都到源站获取，避免网络拥塞、缓解源站压力，保证用户访问资源的速度和体验。

实际上`CDN`这个概念是在1996年由美国麻省理工学院的一个研究小组为**改善互联网的服务质量**而提出的。那么它到底是怎么改善互联网服务质量的呢？

# 二、`CDN`原理分析

## 原理理解

过去几十年，计算机网络把几乎全世界的计算机都连接了起来，我们只要把静态资源和动态的代码部署到服务器上，然后启动服务监听某个端口，这样世界各地的计算机就都能访问该网站。

但是这样有个问题，资源最终还是通过物理层网络线路和设备传输的，每经过一段线路、一个网络设备都有一些耗时，所以客户端和服务器相距越远，网站打开速度就越慢。

这就像你从海南买了一件东西，如果你人在广州的话，那可能很快就收到了，因为传输距离近，但如果你在北京的话，那可能就要多等几天了，因为中间经过的线路、节点都比较多。

但这样肯定不行的，用户体验会很差。怎么解决这个问题呢？

离得越远网站打开速度就越慢，很容易想到，如果部署到很多个地方，当用户访问网络的时候，访问最近的那个不就行了？

这就像快递都有一些中转的仓库，可以存放一些货物，如果你人在北京，要买一个海南的东西，恰好北京的仓库里有，那岂不是很快就可以收到了。

![webpack225](..\images\webpack225.png)

思路是没问题，但是怎么实现呢？

用户是通过域名访问网站的，那能不能通过 `DNS `服务器来实现这个功能呢？

客户端访问某个域名的时候，会先查找本地 `hosts` 文件，如果能查到` ip` 就直接访问。

否则会向本地 `DNS `服务器发请求，这个是联通、移动等运营商提供的每个城市都有的 `DNS `服务器。由它去域名服务器发送解析域名的请求，然后把结果返给客户端。

域名是分层解析的，有根域名服务器、顶级域名服务器、权威域名服务器三层，比如 `image.baidu.com` 会先向根域名服务器发请求查询 `com` 的顶级域名服务器的` ip`，然后再向 `com` 顶级域名服务器查询 `image.baidu.com` 的权威域名服务器的` ip`。查询到权威域名服务器之后，任意层级的域名都会在这里解析（所以叫权威域名服务器）。

看到这个权威域名服务器的时候，不知道大家是否就想到怎么实现 `CDN`网络了。

## 实现 `CDN`网络

**能不能在权威域名服务器这一层根据客户端的` ip` 做一下负载均衡呢？**比如北京来的 `DNS `请求就返回北京机房的服务器的` ip`，上海来的 `DNS `请求就返回上海机房的服务器的` ip`。

确实可以这样实现内容的就近分发，这样的负载均衡网络就叫做 `CDN`（`Content Delivery Network`）

但是实现这样一个 `CDN`网络需要在全国建立多个机房，成本太高了，所以只有像百度、阿里、腾讯这类大公司才会自建 `CDN`，一般情况下我们都会买第三方的 `CDN`服务来用。

这些公司建好了 `CDN`网络，实际上自己也是用不完的，也会对外提供 `CDN`加速服务。

第三方的 `CDN`服务自然也要提供一个 `DNS `服务器，也就是实现根据` ip` 返回不同城市的服务器的` ip` 的那个。

比如这是百度云 `CDN`的原理图：

![webpack226](..\images\webpack226.png)

用户向本地 `DNS` 服务器发请求之后，经历根域名、顶级域名的 `DNS`  解析，最终会转给权威 `DNS`  服务器。这时候只要权威 `DNS` 服务器再转给 `baidu` 的 `DNS` 服务器就可以了，这样就能接入 `CDN` 服务。

`baidu` 的 `DNS` 服务器实现了负载均衡，会根据请求 `ip`  所在的城市，返回不同城市的服务器的 `ip`  。也就实现了就近分发的网络加速功能。

**那这个从权威 `DNS`  到 `baidu` 的 `DNS`  的转发是怎么实现的呢？**

`DNS` 的记录有很多种类型，比如：

`A` 代表 **`address`**，记录域名对应的 `ip`  。

`CNAME` 代表域名还有一个别名，可以向那个域名来查 `ip`  。

`MX` 代表件名后缀对应的域名或者 `ip`  

看到这个 `CNAME` 类型，大家应该就想到怎么实现转发了。

只要自己在 `DNS` 服务器上配一条 `CNAME` 的记录，指向 `CDN` 服务器的域名就可以了。

比如你用某云的 `CDN`  的时候，第一步也是要配置下自己的 `DNS` 服务器的 `CNAME`  指向它：

![webpack227](..\images\webpack227.png)

这样，当你访问某个域名的时候，解析域名的权威服务器会返回 `CDN` 服务的 `DNS` 服务器的域名，然后再向这台 `CDN`  的 `DNS`  服务器发送解析域名的请求，这时候它就可以根据 ip 所在城市来返回一个就近城市的服务器给你。

当然，也可以再做一层 `CNAME`  转发，比如 `CDN` 的 `DNS` 服务器把域名解析转给城市的 `DNS` 服务器，然后城市的 `DNS` 服务器再根据不同机器的负载情况来返回一台离得近而且负载比较小的服务器的 ip 给客户端。

这样客户端就能从最近的服务器下载静态资源，从而更快地打开网站。

如果访问的资源没有的时候，会向源站服务器发请求来拿对应的资源并且缓存下来，之后再此访问就不用访问源站了

# 三、`CDN`的组成

前面我们说过，一个仓配网络是由多个仓库组成的，同理，内容分发网络（`CDN`）是由多个节点组成的。一般来讲，`CDN`网络主要由中心节点、边缘节点两部分构成。

![webpack228](..\images\webpack228.png)

## 中心节点

中心节点包括`CDN`网管中心和全局负载均衡`DNS`重定向解析系统，负责整个`CDN`网络的分发及管理。

## 边缘节点

`CDN`边缘节点主要指异地分发节点，由负载均衡设备、高速缓存服务器两部分组成。

负载均衡设备负责每个节点中各个`Cache`的负载均衡，保证节点的工作效率；同时还负责收集节点与周围环境的信息，保持与全局负载均衡`DNS`的通信，实现整个系统的负载均衡。

高速缓存服务器（`Cache`）负责存储客户网站的大量信息，就像一个靠近用户的网站服务器一样响应本地用户的访问请求。通过全局负载均衡`DNS`的控制，用户的请求被透明地指向离他最近的节点，节点中`Cache`服务器就像网站的原始服务器一样，响应终端用户的请求。因其距离用户更近，故其响应时间才更快。

**中心节点就像仓配网络中负责货物调配的总仓，而边缘节点就是负责存储货物的各个城市的本地仓库。**

目前，主要由很多提供`CDN`服务的云厂商在各地部署了很多个`CDN`节点，拿阿里云举例，我们可以在阿里云的官网上了解到：阿里云在全球拥有2500+节点。中国大陆拥有2000+节点，覆盖34个省级区域，大量节点位于省会等一线城市。海外和港澳台拥有500+节点，覆盖70多个国家和地区。

![webpack229](..\images\webpack229.png)

图：阿里云在中国大陆的`CDN`节点的分布情况

有了如上图的阿里云在中国大陆的`CDN`节点的分布之后（这是不是也和我们前面看到的那张菜鸟网络的全国仓网很像），一个在杭州的电信网络用户，访问某个部署在阿里云上面的网站时，获取到的一些资源，如页面上的某个图片、某段影片或者某些文字，可能就是该网站预先分发到浙江的某个移动`CDN`存储节点提供的，这样就可以大大的减少网站的响应时间。

# 四、`CDN`缓存

浏览器本地缓存失效后，浏览器会向 `CDN`边缘节点发起请求。类似浏览器缓存，`CDN`边缘节点也存在着一套缓存机制。

## `CDN`缓存的缺点

`CDN`的缓存不仅减少了用户的访问延时，也减少的源站的负载。但其缺点也很明显：当网站更新时，如果 `CDN`节点上数据没有及时更新，即便用户再浏览器使用 `Ctrl+F5` 的方式使浏览器端的缓存失效，也会因为 `CDN` 边缘节点没有同步最新数据而导致用户访问异常。

## `CDN`的缓存机制

`CDN`边缘节点缓存策略因服务商不同而不同，但一般都会遵循 http标准协议，通过 http响应头 中的`Cache-control: max-age` 的字段来设置 `CDN`边缘节点数据缓存时间。

当客户端向 `CDN`节点请求数据时，`CDN`节点会判断缓存数据是否过期，若缓存数据并没有过期，则直接将缓存数据返回给客户端；否则，`CDN`节点就会向源站发出回源请求，从源站拉取最新数据，更新本地缓存，并将最新数据返回给客户端。所以，如果我们修改了内容，最好加个版本号，来容 `CDN`重新获取资源，从而减少不必要的麻烦，比如 :

`app.js?v=20171114` 或者 `style.css?v=20171114`

## `CDN`缓存刷新

`CDN`边缘节点对开发者是透明的，相比于浏览器 `Ctrl+F5` 的强制刷新来使浏览器本地缓存失效，开发者可以通过 `CDN`服务商提供的 刷新缓存 接口来达到清理 `CDN`边缘节点缓存的目的。这样开发者在更新数据后，可以使用 刷新缓存 功能来强制 `CDN`节点上的数据缓存过期，保证客户端在访问时，拉取到最新的数据。