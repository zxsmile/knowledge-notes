# 一、`Tree Shaking` 是什么？

其实`Tree Shaking`的概念已经耳熟能详了，所谓的“摇树”就是说将我们代码中的没有用到的代码进行摇晃掉，从而减少包的体积。

其实简单来说这就是所谓的`Tree Shaking`: **基于 `ES Module` 规范的 `Dead Code Elimination` 技术，它会在运行过程中静态分析模块之间的导入导出，确定 `ESM` 模块中哪些导出值未曾其它模块使用，并将其删除，以此实现打包产物的优化。**

`**Tree Shaking` 是一种用于移除 `JavaScript` 中未使用代码的优化技术。可以减小打包文件的体积，提高加载性能。**

**它依赖于 `ES6` 模块的静态结构特性（`import` 和 `export`），使得构建工具能够在编译时确定哪些代码是未使用的，并将其移除。**

例子:

```
// index.js 入口文件
import { funcHao } from './math'

funcHao()
```

```
// math.js
const funcWang = () => {
  const obj = {};
  return obj;
};

const funcHao = () => {
  console.log('hao');
};

export { funcWang, funcHao };


export {
  funcWang,
  funcHao
}
```

```js
// webpack.config.js
const { resolve } = require('path');

module.exports = {
  mode: 'production',
  entry: resolve(__dirname, './src/index.js'),
  module: {
    rules: [
      {
        test: /\.js$/,
        use: [
          {
            loader: 'babel-loader',
            options: {
              presets: ['@babel/preset-env'],
            },
          },
        ],
      },
    ],
  },
  output: {
    filename: '[name].js',
  },
};
```

这里我们使用`webpack`新建了一个只有两个文件的项目。

- `src/index.js`: 入口文件，导入`math.js`中的`funcHao`方法。
- `src/math.js`: 导出两个方法`funcHao`和`funcWang`两个方法。

> tip:  这里我们配置`babel`的原因不单单是为了转译箭头函数，稍微我在后边会讲述为什么这里为配置了一个`babel-preset-env`。

让我们运行`webpack`命令打包我们的代码:

```js
// dist/main.js
(()=>{"use strict";console.log("hao")})();
```

我们会发现打包后的代码仅存在`console.log("hao")`，而`funcWang`这个函数的内容并没有被打包进入。

**简单来说`Tree Shaking`就是删除项目中没有使用到的代码从而达到优化代码的效果**。

# 二、Tree Shaking工作原理

需要额外注意的是:

- **`Tree Shaking`是基于`ESM`模块基础进行处理的。**

#### 至于为什么`Tree Shaking`需要`ESM`模块才能使用呢? 让我们来一起看一看这个问题。

简单来说一段`js`代码的执行过程，需要经历以下三个步骤:

- `V8`通过源码进行词法分析，语法分析生成`AST`和执行上下文。
- 根据`AST`生成计算机可执行的字节码。
- 执行生成的字节码。

在`JS`的执行过程中，**`ES Module`在第一步时就可以确认对应的依赖关系(编译阶段)**，并不需要执行就可以确认模块的导入、导出。

`ES Module`在`js`编译阶段就可以确定模块之间的依赖关系(`import`)以及模块的导出(`export`)，所以我们并不需要代码执行就可以根据`ESM`确定模块之间的规则从而实现`Tree Shaking`，我们称之为**静态分析特性**。

同理，对比`commonjs`模块，它依赖于代码的执行，需要在第三阶段执行完成代码之后才能确认模块的依赖关系。

自然也就不支持`Tree Shaking`。

> 关于`ES Module`中的动态引入`dynamic import`，因为它同样是动态需要`js`执行后才能确认的模块关系。自然也就无法支持`Tree Shaking`。