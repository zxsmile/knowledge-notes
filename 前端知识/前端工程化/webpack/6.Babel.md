# ä¸€ã€Babel çš„å‡ºèº«

babel æœ€å¼€å§‹å« 6to5ï¼Œé¡¾åæ€ä¹‰æ˜¯ es6 è½¬ es5ï¼Œä½†æ˜¯åæ¥éšç€ es æ ‡å‡†çš„æ¼”è¿›ï¼Œæœ‰äº† es7ã€es8 ç­‰ï¼Œ 6to5 çš„åå­—å·²ç»ä¸åˆé€‚äº†ï¼Œæ‰€ä»¥æ”¹åä¸ºäº† babelã€‚

babel æ˜¯å·´åˆ«å¡”çš„æ„æ€ï¼Œæ¥è‡ªåœ£ç»ä¸­çš„å…¸æ•…ï¼š

> å½“æ—¶äººç±»è”åˆèµ·æ¥å…´å»ºå¸Œæœ›èƒ½é€šå¾€å¤©å ‚çš„é«˜å¡”ï¼Œä¸ºäº†é˜»æ­¢äººç±»çš„è®¡åˆ’ï¼Œä¸Šå¸è®©äººç±»è¯´ä¸åŒçš„è¯­è¨€ï¼Œä½¿äººç±»ç›¸äº’ä¹‹é—´ä¸èƒ½æ²Ÿé€šï¼Œè®¡åˆ’å› æ­¤å¤±è´¥ï¼Œäººç±»è‡ªæ­¤å„æ•£ä¸œè¥¿ã€‚æ­¤äº‹ä»¶ï¼Œä¸ºä¸–ä¸Šå‡ºç°ä¸åŒè¯­è¨€å’Œç§æ—æä¾›è§£é‡Šã€‚è¿™åº§å¡”å°±æ˜¯å·´åˆ«å¡”ã€‚

è¿™å¾ˆç¬¦åˆ babel çš„è½¬è¯‘å™¨çš„å®šä½ã€‚æ‰€ä»¥å°±å‘½åä¸º Babelã€‚

# äºŒã€Babel æ˜¯ä»€ä¹ˆï¼Ÿ

**Babel æ˜¯ä¸€ä¸ª JavaScript ç¼–è¯‘å™¨ã€‚**

ä¸Šé¢è¿™å¥è¯å°±æ˜¯Babelçš„æœ¬è´¨ï¼Œæ›´ç®€å•çš„è¯´ï¼ŒBabelå¯ä»¥æŠŠä½¿ç”¨ES6/ES7ç­‰â€œé«˜çº§â€è¯­æ³•ç¼–å†™çš„Javascriptä»£ç è½¬æ¢ä¸ºES5/ES3çš„â€œé€šä¿—â€è¯­æ³•ï¼ˆä¹Ÿå¯ä»¥æŠŠJSXè¯­æ³•è½¬ä¸ºJavascriptï¼‰ã€‚

éšç€ECMAScript æ ‡å‡†è§„èŒƒå‘å±•è¶Šæ¥è¶Šå¿«ï¼Œæ–°è¯­æ³•å±‚å‡ºä¸ç©·ï¼Œç„¶è€Œæµè§ˆå™¨æ›´æ–°å´å­˜åœ¨ç€æ»åæ€§ï¼Œå¯¹ECMAScriptæ–°æ ‡å‡†æ”¯æŒç¨‹åº¦ä¸ä¸€ï¼ŒWebå‰ç«¯å¼€å‘è€…çœ¼å·´å·´çœ‹ç€å„ç§â€œé«˜å¤§ä¸Šâ€ã€â€œç®€æ´â€ã€â€œå®ç”¨â€çš„è¯­æ³•å’ŒAPIï¼Œå´ä¸æ•¢åœ¨å®é™…é¡¹ç›®ä¸­ç›´æ¥ä½¿ç”¨ï¼Œä»¥å…ç”±äºæµè§ˆå™¨ä¸å…¼å®¹å¯¼è‡´å„ç§é—®é¢˜ï¼Œäºæ˜¯Babelè¯ç”Ÿäº†ï¼

ä»æ­¤ä»¥åï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å°½æƒ…åœ°ä½¿ç”¨â€œé«˜å¤§ä¸Šâ€çš„ES6+é«˜çº§è¯­æ³•äº†ï¼Œåªè¦ç»è¿‡Babelè½¬æ¢ï¼Œæœ€ç»ˆè¾“å‡ºçš„ä»£ç æ˜¯å•¥æ ·çš„æˆ‘ä»¬ä¸å†é‚£ä¹ˆå…³å¿ƒï¼Œåªè¦æµè§ˆå™¨èƒ½è¯»æ‡‚å¹¶æ‰§è¡Œå°±è¡Œã€‚

ä¹Ÿè®¸ä½ ä¼šæ‹…å¿ƒç»è¿‡Babelè½¬æ¢åçš„ä»£ç å¤ªè¿‡éš¾ä»¥é˜…è¯»ï¼Œè°ƒè¯•èµ·æ¥ä¼šéå¸¸å›°éš¾ã€‚å¹¸å¥½Babelæ”¯æŒäº†ä¸€ä¸ªå«åšSource mapçš„ç‰¹æ€§ï¼Œä½¿æˆ‘ä»¬è°ƒè¯•èµ·æ¥ä¹Ÿå’Œç›´æ¥å†™ES5/ES3ä»£ç çš„è°ƒè¯•æ–¹å¼ä¸€æ ·ç®€å•ï¼Œè€Œè¿™å¯¹æˆ‘ä»¬æ¥è¯´ï¼Œåªéœ€è¦å¯ç”¨ä¸€ä¸ªé…ç½®é¡¹å°±å¯ä»¥åšåˆ°ã€‚

# ä¸‰ã€Babelåœ¨å‰ç«¯å·¥ç¨‹æµä¸­çš„è§’è‰²å®šä½

æˆ‘ä»¬çŸ¥é“ï¼Œå¦‚ä»Šå‰ç«¯å·¥ç¨‹æµä¸­æœ€è€³ç†Ÿèƒ½è¯¦çš„ä¸€ä¸ªè¯æ˜¯ï¼š`Webpack`. ç°åœ¨å¾ˆå¤šå‰ç«¯é¡¹ç›®è„šæ‰‹æ¶éƒ½å†…ç½®ä¾èµ–äº†webpackï¼Œä¸”æä¾›äº†ä¸€å¥—é»˜è®¤é…ç½®ï¼Œåšåˆ°å¼€ç®±å³ç”¨ã€‚æˆ‘ä»¬åªéœ€è¦æŒ‰ç…§å®˜ç½‘æ–‡æ¡£ç»™å‡ºçš„æ­¥éª¤ï¼Œä¸€ä¸ªå‘½ä»¤ä¸€ä¸ªå‘½ä»¤å»æ‰§è¡Œï¼Œå¦‚`npm run serve`ã€`npm run build`...ï¼Œå³å¯å®ç°å¤§éƒ¨åˆ†å¼€å‘åœºæ™¯éœ€æ±‚ï¼Œåœ¨éœ€è¦å®šåˆ¶åŒ–çš„æƒ…å†µä¸‹ï¼Œç”šè‡³è‡ªå·±å»ºä¸€ä¸ª`vue.config.js`æ–‡ä»¶å»æŒ‰ç…§æ–‡æ¡£è¯´æ˜æ‰©å±•é…ç½®å³å¯ï¼Œä¸å†éœ€è¦äº†è§£webpackçš„å…·ä½“ç”¨æ³•å°±èƒ½â€œå±å’¤Vueç•Œâ€ã€‚

è¿™æ˜¯å‰ç«¯å·¥ç¨‹åŒ–å‘å±•çš„å¿…ç„¶ï¼Œæœ‰å¥è¯è¯´å¾—å¥½ï¼Œâ€œæ‡’äººæ”¹å˜ä¸–ç•Œâ€ï¼ŒæŠ€æœ¯çš„å‘å±•é€ ç¦äº†æ›´å¤šçš„æ‡’äººã€‚åœ¨è¿™æ ·çš„å¤§èƒŒæ™¯ä¸‹ï¼ŒWebpackçš„ç»†èŠ‚è¢«éšè—å’Œå¼±åŒ–ï¼Œæ›´åˆ«æBabeläº†ã€‚æˆ‘ä»¬å¯ä»¥åœ¨é¡¹ç›®çœ‹åˆ°ä¸€ä¸ª`.babelrc`æ–‡ä»¶ï¼Œå´å¤§éƒ¨åˆ†æ—¶é—´éƒ½ä¸ä¼šæ³¨æ„åˆ°å®ƒï¼Œæ›´åˆ«è¯´æ‰“å¼€å®ƒå’Œç¼–è¾‘å®ƒäº†ã€‚

ä½†å°±æ˜¯è¿™ä¹ˆä¸€ä¸ªä½å­˜åœ¨æ„Ÿçš„å°é€æ˜ï¼Œå´æ‰¿æ‹…èµ·äº†å·¨å¤§çš„è´£ä»»ï¼Œåœ¨èƒŒåé»˜é»˜å·¥ä½œï¼Œè¾›è‹¦åœ°æŠŠä½ æ–°ç¼–å†™çš„ES6 `class`è½¬æ¢æˆäº†å¹³å‡¡çš„æ„é€ å‡½æ•°ï¼Œåœ¨ä½ `Ctrl + S`ä¹‹åçœ‹åˆ°æµè§ˆå™¨é¡µé¢ç„•ç„¶ä¸€æ–°çš„ç¬é—´ï¼Œä½ å¯ä¼šæƒ³åˆ°è¿™ä¸ªå°é€æ˜åšçš„äº‹æƒ…æœ‰å¤šä¹ˆä¼Ÿå¤§ï¼Ÿå½“ç„¶ï¼Œè¿™ä¸€åˆ‡ä¹Ÿç¦»ä¸å¼€è€å¤§å“¥Webpackçš„ææºï¼Œåœ¨Webpackçš„Loaderæœºåˆ¶ä¸‹ï¼ŒBabelåœ¨è¿™é‡Œä½œä¸º**Webpack loaderè§’è‰²**çš„ä¸€å‘˜å‹¤å‹¤æ³æ³å·¥ä½œç€ã€‚

é™¤äº†ä½œä¸ºWebpack loaderï¼ŒBabelå½“ç„¶ä¹Ÿèƒ½å­¤å†›å¥‹æˆ˜ï¼Œç‹¬å½“ä¸€é¢ã€‚

# å››ã€Babelçš„ç¼–è¯‘æµç¨‹

## 1ã€ç¼–è¯‘è¿‡ç¨‹è§£æ

ä¸€èˆ¬ç¼–è¯‘å™¨ï¼ˆCompilerï¼‰ æ˜¯æŒ‡é«˜çº§è¯­è¨€åˆ°ä½çº§è¯­è¨€çš„è½¬æ¢å·¥å…·ï¼Œç‰¹æ®Šçš„ï¼Œé«˜çº§è¯­è¨€åˆ°é«˜çº§è¯­è¨€çš„è½¬æ¢å·¥å…·ï¼Œè¢«å«åšè½¬æ¢ç¼–è¯‘å™¨ï¼Œç®€ç§°è½¬è¯‘å™¨ (Transpiler)ã€‚

**é«˜çº§è¯­è¨€**ï¼šæœ‰å¾ˆå¤šç”¨äºæè¿°é€»è¾‘çš„è¯­è¨€ç‰¹æ€§ï¼Œæ¯”å¦‚åˆ†æ”¯ã€å¾ªç¯ã€å‡½æ•°ã€é¢å‘å¯¹è±¡ç­‰ï¼Œæ¥è¿‘äººçš„æ€ç»´ï¼Œå¯ä»¥è®©å¼€å‘è€…å¿«é€Ÿçš„é€šè¿‡å®ƒæ¥è¡¨è¾¾å„ç§é€»è¾‘ã€‚æ¯”å¦‚ c++ã€javascriptã€‚

**ä½çº§è¯­è¨€**ï¼šä¸ç¡¬ä»¶å’Œæ‰§è¡Œç»†èŠ‚æœ‰å…³ï¼Œä¼šæ“ä½œå¯„å­˜å™¨ã€å†…å­˜ï¼Œå…·ä½“åšå†…å­˜ä¸å¯„å­˜å™¨ä¹‹é—´çš„å¤åˆ¶ï¼Œéœ€è¦å¼€å‘è€…ç†è§£ç†Ÿæ‚‰è®¡ç®—æœºçš„å·¥ä½œåŸç†ï¼Œç†Ÿæ‚‰å…·ä½“çš„æ‰§è¡Œç»†èŠ‚ã€‚æ¯”å¦‚æ±‡ç¼–è¯­è¨€ã€æœºå™¨è¯­è¨€ã€‚

**babel å°±æ˜¯ä¸€ä¸ª Javascript Transpilerã€‚**

![webpack87](..\images\webpack87.png)

ç”±æ­¤å¯ä»¥çœ‹åˆ°babelçš„æ ¸å¿ƒå°±æ˜¯ **parseï¼ˆè§£æï¼‰**ã€**transformï¼ˆè½¬åŒ–ï¼‰** å’Œ **generatorï¼ˆç”Ÿæˆï¼‰** ä¸‰ä¸ªéƒ¨åˆ†

#### parse

`babylon`ï¼ˆbabel å†…éƒ¨ä½¿ç”¨çš„è§£æç±»åº“å«åš `babylon`ï¼Œç°åœ¨æ”¹åå«`@babel/parser`ï¼‰ è´Ÿè´£å°†es6ä»£ç è¿›è¡Œè¯­æ³•åˆ†æå’Œè¯æ³•åˆ†æåè½¬æ¢æˆæŠ½è±¡è¯­æ³•æ ‘AST

#### transform

å…¶ä¸­ç¬¬äºŒæ­¥çš„è½¬åŒ–æ˜¯é‡ä¸­ä¹‹é‡ï¼Œbabelçš„æ’ä»¶æœºåˆ¶ä¹Ÿæ˜¯åœ¨è¿™ä¸€æ­¥å‘æŒ¥ä½œç”¨çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ`babel`æ˜¯ä¾èµ–äº`babelæ’ä»¶`è¿›è¡Œä»£ç è½¬æ¢çš„ï¼Œé»˜è®¤`babel`æ˜¯æ²¡æœ‰æ’ä»¶çš„ï¼Œ**æ²¡æœ‰å®‰è£…æ’ä»¶çš„`babel`åªæ˜¯ä¼šå°†æºç ç”Ÿæˆ`AST`æ ‘ï¼Œç„¶ååœ¨é€šè¿‡ç”Ÿæˆå™¨ç”Ÿæˆå’ŒåŸæ¥çš„æºç ä¸€æ‘¸ä¸€æ ·çš„ä»£ç **ï¼Œè¿™æ ·`babel`æ²¡æœ‰èµ·åˆ°ä»£ç è½¬æ¢çš„æ•ˆæœï¼æ‰€ä»¥å¦‚æœæ²¡æœ‰è¿™äº›pluginsè¿›é©»å¹³å°ï¼Œé‚£ä¹ˆbabelè¿™ä¸ªâ€œå¹³å°â€æ˜¯ä¸å…·å¤‡ä»»ä½•èƒ½åŠ›çš„ã€‚

`babel`æ’ä»¶å‘æŒ¥ä½œç”¨çš„åœ°æ–¹åŸºæœ¬éƒ½æ˜¯åœ¨tranfromè¿™ä¸ªé˜¶æ®µï¼Œåªè¦å®‰è£…å¥½`babel`è½¬æ¢ç±»æ’ä»¶å°±å¯ä»¥è½¬æ¢å‡ºæƒ³è¦çš„ä»£ç ã€‚ pluginæ’ä»¶ä½¿ç”¨ `@babel/traverse` æ¥éå† AST å¹¶è¿›è¡ŒèŠ‚ç‚¹çš„æ“ä½œï¼Œç”¨å®ƒæä¾›çš„ APIï¼ˆè°ƒç”¨ visitor å‡½æ•°ä¿®ï¼‰ æ¥ç¼–å†™å¯¹ AST çš„éå†å’Œä¿®æ”¹é€»è¾‘ï¼Œä¿®æ”¹ AST è‡ªç„¶æ¶‰åŠåˆ° AST çš„åˆ¤æ–­ã€åˆ›å»ºã€ä¿®æ”¹ç­‰ï¼Œè¿™æ—¶å€™å°±éœ€è¦ @babel/types äº†ï¼Œå½“éœ€è¦æ‰¹é‡åˆ›å»º AST çš„æ—¶å€™å¯ä»¥ä½¿ç”¨ @babel/template æ¥ç®€åŒ– AST åˆ›å»ºé€»è¾‘ï¼Œç”±æ­¤æ¥å°†ä¸€ç§ASTè½¬æ¢ä¸ºå¦ä¸€ç§ASTï¼Œå†äº¤ç»™ç¬¬ä¸‰æ­¥çš„`@babel/generator`ã€‚ 

**åœ¨ transform é˜¶æ®µï¼Œä¼šåº”ç”¨å„ç§å†…ç½®çš„æ’ä»¶æ¥å®Œæˆ AST çš„è½¬æ¢ã€‚å†…ç½®æ’ä»¶åšçš„è½¬æ¢åŒ…æ‹¬ä¸¤éƒ¨åˆ†ï¼Œä¸€æ˜¯æŠŠä¸æ”¯æŒçš„è¯­æ³•è½¬æˆç›®æ ‡ç¯å¢ƒæ”¯æŒçš„è¯­æ³•æ¥å®ç°ç›¸åŒåŠŸèƒ½ï¼ŒäºŒæ˜¯ä¸æ”¯æŒçš„ api è‡ªåŠ¨å¼•å…¥å¯¹åº”çš„ polyfillã€‚**

#### generator

`@babel/generator`è´Ÿè´£é€šè¿‡ASTæ ‘ç”ŸæˆES5ä»£ç ï¼ŒåŒæ—¶ç”Ÿæˆ sourcemapã€‚

è€Œè¿™æ•´ä¸ªè¿‡ç¨‹ï¼Œç”±`@babel/core` è´Ÿè´£ç¼–è¯‘è¿‡ç¨‹çš„æ§åˆ¶å’Œç®¡ç†ã€‚åŸºäºä¸Šé¢çš„åŒ…å®Œæˆ babel æ•´ä½“çš„ç¼–è¯‘æµç¨‹ï¼Œå¹¶å®ç°æ’ä»¶åŠŸèƒ½ã€‚

## 2ã€è®¿é—®è€…æ¨¡å¼

è½¬æ¢å™¨ä¼šéå† AST æ ‘ï¼Œæ‰¾å‡ºè‡ªå·±æ„Ÿå…´è¶£çš„èŠ‚ç‚¹ç±»å‹, å†è¿›è¡Œè½¬æ¢æ“ä½œ. è¿™ä¸ªè¿‡ç¨‹å’Œæˆ‘ä»¬æ“ä½œ`DOM`æ ‘å·®ä¸å¤šï¼Œåªä¸è¿‡ç›®çš„ä¸å¤ªä¸€æ ·ã€‚AST éå†å’Œè½¬æ¢ä¸€èˆ¬ä¼šä½¿ç”¨[`è®¿é—®è€…æ¨¡å¼`](https://link.juejin.cn?target=https%3A%2F%2Fwww.jianshu.com%2Fp%2F1f1049d0a0f4)ã€‚

æƒ³è±¡ä¸€ä¸‹ï¼ŒBabel æœ‰é‚£ä¹ˆå¤šæ’ä»¶ï¼Œå¦‚æœæ¯ä¸ªæ’ä»¶è‡ªå·±å»éå†ASTï¼Œå¯¹ä¸åŒçš„èŠ‚ç‚¹è¿›è¡Œä¸åŒçš„æ“ä½œï¼Œç»´æŠ¤è‡ªå·±çš„çŠ¶æ€ã€‚è¿™æ ·å­ä¸ä»…ä½æ•ˆï¼Œå®ƒä»¬çš„é€»è¾‘åˆ†æ•£åœ¨å„å¤„ï¼Œä¼šè®©æ•´ä¸ªç³»ç»Ÿå˜å¾—éš¾ä»¥ç†è§£å’Œè°ƒè¯•ï¼Œ æœ€åæ’ä»¶ä¹‹é—´å…³ç³»å°±çº ç¼ ä¸æ¸…ï¼Œä¹±æˆä¸€é”…ç²¥ã€‚

**æ‰€ä»¥è½¬æ¢å™¨æ“ä½œ AST ä¸€èˆ¬éƒ½æ˜¯ä½¿ç”¨`è®¿é—®å™¨æ¨¡å¼`ï¼Œç”±è¿™ä¸ª`è®¿é—®è€…(Visitor)`æ¥ â‘  è¿›è¡Œç»Ÿä¸€çš„éå†æ“ä½œï¼Œâ‘¡ æä¾›èŠ‚ç‚¹çš„æ“ä½œæ–¹æ³•ï¼Œâ‘¢ å“åº”å¼ç»´æŠ¤èŠ‚ç‚¹ä¹‹é—´çš„å…³ç³»ï¼›è€Œæ’ä»¶(è®¾è®¡æ¨¡å¼ä¸­ç§°ä¸ºâ€˜å…·ä½“è®¿é—®è€…â€™)åªéœ€è¦å®šä¹‰è‡ªå·±æ„Ÿå…´è¶£çš„èŠ‚ç‚¹ç±»å‹ï¼Œå½“è®¿é—®è€…è®¿é—®åˆ°å¯¹åº”èŠ‚ç‚¹æ—¶ï¼Œå°±è°ƒç”¨æ’ä»¶çš„è®¿é—®(visit)æ–¹æ³•**ã€‚

### 2.1ã€èŠ‚ç‚¹çš„éå†

å‡è®¾æˆ‘ä»¬çš„ä»£ç å¦‚ä¸‹:

```
 ç function hello(v) {
  console.log('hello' + v + '!')
}
```



è§£æåçš„ AST ç»“æ„å¦‚ä¸‹:

```
 File
  Program (program)
    FunctionDeclaration (body)
      Identifier (id)  #hello
      Identifier (params[0]) #v
      BlockStatement (body)
        ExpressionStatement ([0])
          CallExpression (expression)
            MemberExpression (callee)  #console.log
              Identifier (object)  #console
              Identifier (property)  #log
            BinaryExpression (arguments[0])
              BinaryExpression (left)
                StringLiteral (left)  #'hello'
                Identifier (right)  #v
              StringLiteral (right)  #'!'
```

è®¿é—®è€…ä¼šä»¥`æ·±åº¦ä¼˜å…ˆ`çš„é¡ºåº, æˆ–è€…è¯´é€’å½’åœ°å¯¹ AST è¿›è¡Œéå†ï¼Œå…¶è°ƒç”¨é¡ºåºå¦‚ä¸‹å›¾æ‰€ç¤º:

![webpack107](..\images\webpack107.png)

ä¸Šå›¾ä¸­`ç»¿çº¿`è¡¨ç¤ºè¿›å…¥è¯¥èŠ‚ç‚¹ï¼Œ`çº¢çº¿`è¡¨ç¤ºç¦»å¼€è¯¥èŠ‚ç‚¹ã€‚ä¸‹é¢å†™ä¸€ä¸ªè¶…ç®€å•çš„'å…·ä½“è®¿é—®è€…'æ¥è¿˜åŸä¸Šé¢çš„éå†è¿‡ç¨‹:

```
const babel = require('@babel/core')
const traverse = require('@babel/traverse').default

const ast = babel.parseSync(code)

let depth = 0
traverse(ast, {
  enter(path) {
    console.log(`enter ${path.type}(${path.key})`)
    depth++
  },
  exit(path) {
    depth--
    console.log(`  exit ${path.type}(${path.key})`)
  }
})
```

ä»£ç æ‰§è¡Œç»“æœ

```
 enter Program(program)
   enter FunctionDeclaration(0)
     enter Identifier(id)
     exit Identifier(id)
     enter Identifier(0)
     exit Identifier(0)
     enter BlockStatement(body)
       enter ExpressionStatement(0)
         enter CallExpression(expression)
           enter MemberExpression(callee)
             enter Identifier(object)
             exit Identifier(object)
             enter Identifier(property)
             exit Identifier(property)
           exit MemberExpression(callee)
           enter BinaryExpression(0)
             enter BinaryExpression(left)
               enter StringLiteral(left)
               exit StringLiteral(left)
               enter Identifier(right)
               exit Identifier(right)
             exit BinaryExpression(left)
             enter StringLiteral(right)
             exit StringLiteral(right)
           exit BinaryExpression(0)
         exit CallExpression(expression)
       exit ExpressionStatement(0)
     exit BlockStatement(body)
   exit FunctionDeclaration(0)
 exit Program(program)

```



å½“è®¿é—®è€…è¿›å…¥ä¸€ä¸ªèŠ‚ç‚¹æ—¶å°±ä¼šè°ƒç”¨ `enter(è¿›å…¥)` æ–¹æ³•ï¼Œåä¹‹ç¦»å¼€è¯¥èŠ‚ç‚¹æ—¶ä¼šè°ƒç”¨ `exit(ç¦»å¼€)` æ–¹æ³•ã€‚ ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ’ä»¶ä¸ä¼šç›´æ¥ä½¿ç”¨`enter`æ–¹æ³•ï¼Œåªä¼šå…³æ³¨å°‘æ•°å‡ ä¸ªèŠ‚ç‚¹ç±»å‹ï¼Œæ‰€ä»¥å…·ä½“è®¿é—®è€…ä¹Ÿå¯ä»¥è¿™æ ·å£°æ˜è®¿é—®æ–¹æ³•:

```
traverse(ast, {
  // è®¿é—®æ ‡è¯†ç¬¦
  Identifier(path) {
    console.log(`enter Identifier`)
  },
  // è®¿é—®è°ƒç”¨è¡¨è¾¾å¼
  CallExpression(path) {
    console.log(`enter CallExpression`)
  },
  // ä¸Šé¢æ˜¯enterçš„ç®€å†™ï¼Œå¦‚æœè¦å¤„ç†exitï¼Œä¹Ÿå¯ä»¥è¿™æ ·
  // äºŒå…ƒæ“ä½œç¬¦
  BinaryExpression: {
    enter(path) {},
    exit(path) {},
  },
  // æ›´é«˜çº§çš„, ä½¿ç”¨åŒä¸€ä¸ªæ–¹æ³•è®¿é—®å¤šç§ç±»å‹çš„èŠ‚ç‚¹
  "ExportNamedDeclaration|Flow"(path) {}
})
```



**é‚£ä¹ˆ Babel æ’ä»¶æ˜¯æ€ä¹ˆè¢«åº”ç”¨çš„å‘¢ï¼Ÿ**

Babel ä¼šæŒ‰ç…§æ’ä»¶å®šä¹‰çš„é¡ºåºæ¥åº”ç”¨è®¿é—®æ–¹æ³•ï¼Œæ¯”å¦‚ä½ æ³¨å†Œäº†å¤šä¸ªæ’ä»¶ï¼Œbabel-core æœ€åä¼ é€’ç»™è®¿é—®å™¨çš„æ•°æ®ç»“æ„å¤§æ¦‚é•¿è¿™æ ·ï¼š

```
{
  Identifier: {
    enter: [plugin-xx, plugin-yy,] // æ•°ç»„å½¢å¼
  }
}
```



å½“è¿›å…¥ä¸€ä¸ªèŠ‚ç‚¹æ—¶ï¼Œè¿™äº›æ’ä»¶ä¼šæŒ‰ç…§æ³¨å†Œçš„é¡ºåºè¢«æ‰§è¡Œã€‚å¤§éƒ¨åˆ†æ’ä»¶æ˜¯ä¸éœ€è¦å¼€å‘è€…å…³å¿ƒå®šä¹‰çš„é¡ºåºçš„ï¼Œæœ‰å°‘æ•°çš„æƒ…å†µéœ€è¦ç¨å¾®æ³¨æ„ä»¥ä¸‹ï¼Œä¾‹å¦‚`plugin-proposal-decorators`:

```
{
  "plugins": [
    "@babel/plugin-proposal-decorators",     // å¿…é¡»åœ¨plugin-proposal-class-propertiesä¹‹å‰
    "@babel/plugin-proposal-class-properties"
  ]
}
```



æ‰€æœ‰æ’ä»¶å®šä¹‰çš„é¡ºåºï¼ŒæŒ‰ç…§æƒ¯ä¾‹ï¼Œåº”è¯¥æ˜¯æ–°çš„æˆ–è€…è¯´å®éªŒæ€§çš„æ’ä»¶åœ¨å‰é¢ï¼Œè€çš„æ’ä»¶å®šä¹‰åœ¨åé¢ã€‚å› ä¸ºå¯èƒ½éœ€è¦æ–°çš„æ’ä»¶å°† AST è½¬æ¢åï¼Œè€çš„æ’ä»¶æ‰èƒ½è¯†åˆ«è¯­æ³•ï¼ˆå‘åå…¼å®¹ï¼‰ã€‚ä¸‹é¢æ˜¯å®˜æ–¹é…ç½®ä¾‹å­, ä¸ºäº†ç¡®ä¿å…ˆåå…¼å®¹ï¼Œ`stage-*`é˜¶æ®µçš„æ’ä»¶å…ˆæ‰§è¡Œ:

```
 {
  "presets": ["es2015", "react", "stage-2"]
}
```

> æ³¨æ„Presetçš„æ‰§è¡Œé¡ºåºç›¸åï¼Œè¯¦è§å®˜æ–¹[æ–‡æ¡£](https://link.juejin.cn?target=https%3A%2F%2Fbabeljs.io%2Fdocs%2Fen%2Fnext%2Fplugins%23plugin-ordering)



### 2.2ã€èŠ‚ç‚¹çš„ä¸Šä¸‹æ–‡

è®¿é—®è€…åœ¨è®¿é—®ä¸€ä¸ªèŠ‚ç‚¹æ—¶, ä¼šæ— å·®åˆ«åœ°è°ƒç”¨ `enter` æ–¹æ³•ï¼Œæˆ‘ä»¬æ€ä¹ˆçŸ¥é“è¿™ä¸ªèŠ‚ç‚¹åœ¨ä»€ä¹ˆä½ç½®ä»¥åŠå’Œå…¶ä»–èŠ‚ç‚¹çš„å…³è”å…³ç³»å‘¢ï¼Ÿ

é€šè¿‡ä¸Šé¢çš„ä»£ç ï¼Œè¯»è€…åº”è¯¥å¯ä»¥çŒœå‡ºå‡ åˆ†ï¼Œæ¯ä¸ª`visit`æ–¹æ³•éƒ½æ¥æ”¶ä¸€ä¸ª `Path` å¯¹è±¡, ä½ å¯ä»¥å°†å®ƒå½“åšä¸€ä¸ªâ€˜ä¸Šä¸‹æ–‡â€™å¯¹è±¡ï¼Œç±»ä¼¼äº`JQuery`çš„ `JQuery`(`const $el = $('.el')`) å¯¹è±¡ï¼Œè¿™é‡Œé¢åŒ…å«äº†å¾ˆå¤šä¿¡æ¯ï¼š

- å½“å‰èŠ‚ç‚¹ä¿¡æ¯
- èŠ‚ç‚¹çš„å…³è”ä¿¡æ¯ã€‚çˆ¶èŠ‚ç‚¹ã€å­èŠ‚ç‚¹ã€å…„å¼ŸèŠ‚ç‚¹ç­‰ç­‰
- ä½œç”¨åŸŸä¿¡æ¯
- ä¸Šä¸‹æ–‡ä¿¡æ¯
- èŠ‚ç‚¹æ“ä½œæ–¹æ³•ã€‚èŠ‚ç‚¹å¢åˆ æŸ¥æ”¹
- æ–­è¨€æ–¹æ³•ã€‚isXXX, assertXXX

ä¸‹é¢æ˜¯å®ƒçš„ä¸»è¦ç»“æ„:

```
export class NodePath<T = Node> {
    constructor(hub: Hub, parent: Node);
    parent: Node;
    hub: Hub;
    contexts: TraversalContext[];
    data: object;
    shouldSkip: boolean;
    shouldStop: boolean;
    removed: boolean;
    state: any;
    opts: object;
    skipKeys: object;
    parentPath: NodePath;
    context: TraversalContext;
    container: object | object[];
    listKey: string; // å¦‚æœèŠ‚ç‚¹åœ¨ä¸€ä¸ªæ•°ç»„ä¸­ï¼Œè¿™ä¸ªå°±æ˜¯èŠ‚ç‚¹æ•°ç»„çš„é”®
    inList: boolean;
    parentKey: string;
    key: string | number; // èŠ‚ç‚¹æ‰€åœ¨çš„é”®æˆ–ç´¢å¼•
    node: T;  // ğŸ”´ å½“å‰èŠ‚ç‚¹
    scope: Scope; // ğŸ”´å½“å‰èŠ‚ç‚¹æ‰€åœ¨çš„ä½œç”¨åŸŸ
    type: T extends undefined | null ? string | null : string; // ğŸ”´èŠ‚ç‚¹ç±»å‹
    typeAnnotation: object;
    // ... è¿˜æœ‰å¾ˆå¤šæ–¹æ³•ï¼Œå®ç°å¢åˆ æŸ¥æ”¹
}
```

ä½ å¯ä»¥é€šè¿‡è¿™ä¸ª[æ‰‹å†Œ](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fjamiebuilds%2Fbabel-handbook%2Fblob%2Fmaster%2Ftranslations%2Fzh-Hans%2Fplugin-handbook.md%23toc-visitors)æ¥å­¦ä¹ æ€ä¹ˆé€šè¿‡ Path æ¥è½¬æ¢ AST. åé¢ä¹Ÿä¼šæœ‰ä»£ç ç¤ºä¾‹ï¼Œè¿™é‡Œå°±ä¸å±•å¼€ç»†èŠ‚äº†



### 2.3ã€å‰¯ä½œç”¨çš„å¤„ç†

å®é™…ä¸Šè®¿é—®è€…çš„å·¥ä½œæ¯”æˆ‘ä»¬æƒ³è±¡çš„è¦å¤æ‚çš„å¤šï¼Œä¸Šé¢ç¤ºèŒƒçš„æ˜¯é™æ€ AST çš„éå†è¿‡ç¨‹ã€‚è€Œ AST è½¬æ¢æœ¬èº«æ˜¯æœ‰å‰¯ä½œç”¨çš„ï¼Œæ¯”å¦‚æ’ä»¶å°†æ—§çš„èŠ‚ç‚¹æ›¿æ¢äº†ï¼Œé‚£ä¹ˆè®¿é—®è€…å°±æ²¡æœ‰å¿…è¦å†å‘ä¸‹è®¿é—®æ—§èŠ‚ç‚¹äº†ï¼Œè€Œæ˜¯ç»§ç»­è®¿é—®æ–°çš„èŠ‚ç‚¹, ä»£ç å¦‚ä¸‹ã€‚

```
traverse(ast, {
  ExpressionStatement(path) {
    // å°† `console.log('hello' + v + '!')` æ›¿æ¢ä¸º `return â€˜helloâ€™ + v`
    const rtn = t.returnStatement(t.binaryExpression('+', t.stringLiteral('hello'), t.identifier('v')))
    path.replaceWith(rtn)
  },
}
```



ä¸Šé¢çš„ä»£ç , å°†`console.log('hello' + v + '!')`è¯­å¥æ›¿æ¢ä¸º`return "hello" + v;`, ä¸‹å›¾æ˜¯éå†çš„è¿‡ç¨‹ï¼š

![webpack108](..\images\webpack108.png)

æˆ‘ä»¬å¯ä»¥å¯¹ AST è¿›è¡Œä»»æ„çš„æ“ä½œï¼Œæ¯”å¦‚åˆ é™¤çˆ¶èŠ‚ç‚¹çš„å…„å¼ŸèŠ‚ç‚¹ã€åˆ é™¤ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹ã€æ–°å¢å…„å¼ŸèŠ‚ç‚¹... **å½“è¿™äº›æ“ä½œ'æ±¡æŸ“'äº† AST æ ‘åï¼Œè®¿é—®è€…éœ€è¦è®°å½•è¿™äº›çŠ¶æ€ï¼Œå“åº”å¼(Reactive)æ›´æ–° Path å¯¹è±¡çš„å…³è”å…³ç³», ä¿è¯æ­£ç¡®çš„éå†é¡ºåºï¼Œä»è€Œè·å¾—æ­£ç¡®çš„è½¬è¯‘ç»“æœ**ã€‚



### 2.4ã€ä½œç”¨åŸŸçš„å¤„ç†

è®¿é—®è€…å¯ä»¥ç¡®ä¿æ­£ç¡®åœ°éå†å’Œä¿®æ”¹èŠ‚ç‚¹ï¼Œä½†æ˜¯å¯¹äºè½¬æ¢å™¨æ¥è¯´ï¼Œå¦ä¸€ä¸ªæ¯”è¾ƒæ£˜æ‰‹çš„æ˜¯å¯¹ä½œç”¨åŸŸçš„å¤„ç†ï¼Œè¿™ä¸ªè´£ä»»è½åœ¨äº†æ’ä»¶å¼€å‘è€…çš„å¤´ä¸Šã€‚æ’ä»¶å¼€å‘è€…å¿…é¡»éå¸¸è°¨æ…åœ°å¤„ç†ä½œç”¨åŸŸï¼Œä¸èƒ½ç ´åç°æœ‰ä»£ç çš„æ‰§è¡Œé€»è¾‘ã€‚

```
const a = 1, b = 2
function add(foo, bar) {
  console.log(a, b)
  return foo + bar
}
```

æ¯”å¦‚ä½ è¦å°† `add` å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•° `foo` æ ‡è¯†ç¬¦ä¿®æ”¹ä¸º`a`, ä½ å°±éœ€è¦**é€’å½’**éå†å­æ ‘ï¼ŒæŸ¥å‡º`foo`æ ‡è¯†ç¬¦çš„æ‰€æœ‰`å¼•ç”¨`, ç„¶åæ›¿æ¢å®ƒ:

```
traverse(ast, {
  // å°†ç¬¬ä¸€ä¸ªå‚æ•°åè½¬æ¢ä¸ºa
  FunctionDeclaration(path) {
    const firstParams = path.get('params.0')
    if (firstParams == null) {
      return
    }

    const name = firstParams.node.name
    // é€’å½’éå†ï¼Œè¿™æ˜¯æ’ä»¶å¸¸ç”¨çš„æ¨¡å¼ã€‚è¿™æ ·å¯ä»¥é¿å…å½±å“åˆ°å¤–éƒ¨ä½œç”¨åŸŸ
    path.traverse({
      Identifier(path) {
        if (path.node.name === name) {
          path.replaceWith(t.identifier('a'))
        }
      }
    })
  },
})

console.log(generate(ast).code)
// function add(a, bar) {
//   console.log(a, b);
//   return a + bar;
// }
```



ğŸ¤¯æ…¢ç€ï¼Œå¥½åƒæ²¡é‚£ä¹ˆç®€å•ï¼Œæ›¿æ¢æˆ `a` ä¹‹å, `console.log(a, b)` çš„è¡Œä¸ºå°±è¢«ç ´åäº†ã€‚æ‰€ä»¥è¿™é‡Œä¸èƒ½ç”¨ `a`ï¼Œå¾—æ¢ä¸ªæ ‡è¯†ç¬¦, è­¬å¦‚`c`.



è¿™å°±æ˜¯è½¬æ¢å™¨éœ€è¦è€ƒè™‘çš„ä½œç”¨åŸŸé—®é¢˜ï¼Œ**AST è½¬æ¢çš„å‰ææ˜¯ä¿è¯ç¨‹åºçš„æ­£ç¡®æ€§**ã€‚ æˆ‘ä»¬åœ¨æ·»åŠ å’Œä¿®æ”¹`å¼•ç”¨`æ—¶ï¼Œéœ€è¦ç¡®ä¿ä¸ç°æœ‰çš„æ‰€æœ‰å¼•ç”¨ä¸å†²çªã€‚Babelæœ¬èº«ä¸èƒ½æ£€æµ‹è¿™ç±»å¼‚å¸¸ï¼Œåªèƒ½ä¾é æ’ä»¶å¼€å‘è€…è°¨æ…å¤„ç†ã€‚



Javascripté‡‡ç”¨çš„æ˜¯è¯æ³•ä½œç”¨åŸŸ, ä¹Ÿå°±æ˜¯æ ¹æ®æºä»£ç çš„è¯æ³•ç»“æ„æ¥ç¡®å®šä½œç”¨åŸŸï¼š

![webpack109](..\images\webpack109.png)

åœ¨**è¯æ³•åŒºå—(block)\ä¸­ï¼Œç”±äºæ–°å»ºå˜é‡ã€å‡½æ•°ã€ç±»ã€å‡½æ•°å‚æ•°ç­‰åˆ›å»ºçš„æ ‡è¯†ç¬¦ï¼Œéƒ½å±äºè¿™ä¸ªåŒºå—ä½œç”¨åŸŸ. è¿™äº›æ ‡è¯†ç¬¦ä¹Ÿç§°ä¸º\**ç»‘å®š(Binding)**ï¼Œè€Œå¯¹è¿™äº›ç»‘å®šçš„ä½¿ç”¨ç§°ä¸º**å¼•ç”¨(Reference)**

åœ¨Babelä¸­ï¼Œä½¿ç”¨`Scope`å¯¹è±¡æ¥è¡¨ç¤ºä½œç”¨åŸŸã€‚ æˆ‘ä»¬å¯ä»¥é€šè¿‡Pathå¯¹è±¡çš„`scope`å­—æ®µæ¥è·å–å½“å‰èŠ‚ç‚¹çš„`Scope`å¯¹è±¡ã€‚å®ƒçš„ç»“æ„å¦‚ä¸‹:

```
{
  path: NodePath;
  block: Node;         // æ‰€å±çš„è¯æ³•åŒºå—èŠ‚ç‚¹, ä¾‹å¦‚å‡½æ•°èŠ‚ç‚¹ã€æ¡ä»¶è¯­å¥èŠ‚ç‚¹
  parentBlock: Node;   // æ‰€å±çš„çˆ¶çº§è¯æ³•åŒºå—èŠ‚ç‚¹
  parent: Scope;       // âš›ï¸æŒ‡å‘çˆ¶ä½œç”¨åŸŸ
  bindings: { [name: string]: Binding; }; // âš›ï¸ è¯¥ä½œç”¨åŸŸä¸‹é¢çš„æ‰€æœ‰ç»‘å®š(å³è¯¥ä½œç”¨åŸŸåˆ›å»ºçš„æ ‡è¯†ç¬¦)
}
```



`Scope` å¯¹è±¡å’Œ `Path` å¯¹è±¡å·®ä¸å¤šï¼Œ**å®ƒåŒ…å«äº†ä½œç”¨åŸŸä¹‹é—´çš„å…³è”å…³ç³»(é€šè¿‡parentæŒ‡å‘çˆ¶ä½œç”¨åŸŸ)ï¼Œæ”¶é›†äº†ä½œç”¨åŸŸä¸‹é¢çš„æ‰€æœ‰ç»‘å®š(bindings), å¦å¤–è¿˜æä¾›äº†ä¸°å¯Œçš„æ–¹æ³•æ¥å¯¹ä½œç”¨åŸŸä»…é™æ“ä½œ**ã€‚

æˆ‘ä»¬å¯ä»¥é€šè¿‡`bindings`å±æ€§è·å–å½“å‰ä½œç”¨åŸŸä¸‹çš„æ‰€æœ‰ç»‘å®š(å³æ ‡è¯†ç¬¦)ï¼Œæ¯ä¸ªç»‘å®šç”±`Binding`ç±»æ¥è¡¨ç¤ºï¼š

```
export class Binding {
  identifier: t.Identifier;
  scope: Scope;
  path: NodePath;
  kind: "var" | "let" | "const" | "module";
  referenced: boolean;
  references: number;              // è¢«å¼•ç”¨çš„æ•°é‡
  referencePaths: NodePath[];      // âš›ï¸è·å–æ‰€æœ‰åº”ç”¨è¯¥æ ‡è¯†ç¬¦çš„èŠ‚ç‚¹è·¯å¾„
  constant: boolean;               // æ˜¯å¦æ˜¯å¸¸é‡
  constantViolations: NodePath[];
}
```

**é€šè¿‡`Binding`å¯¹è±¡æˆ‘ä»¬å¯ä»¥ç¡®å®šæ ‡è¯†ç¬¦è¢«å¼•ç”¨çš„æƒ…å†µ**ã€‚

Okï¼Œæœ‰äº† `Scope` å’Œ `Binding`, ç°åœ¨æœ‰èƒ½åŠ›å®ç°å®‰å…¨çš„å˜é‡é‡å‘½åè½¬æ¢äº†ã€‚ ä¸ºäº†æ›´å¥½åœ°å±•ç¤ºä½œç”¨åŸŸäº¤äº’ï¼Œåœ¨ä¸Šé¢ä»£ç çš„åŸºç¡€ä¸Šï¼Œæˆ‘ä»¬å†å¢åŠ ä¸€ä¸‹éš¾åº¦ï¼š

```
const a = 1, b = 2
function add(foo, bar) {
  console.log(a, b)
  return () => {
    const a = '1' // æ–°å¢äº†ä¸€ä¸ªå˜é‡å£°æ˜
    return a + (foo + bar)
  }
}
```

ç°åœ¨ä½ è¦é‡å‘½åå‡½æ•°å‚æ•° `foo`, ä¸ä»…è¦è€ƒè™‘`å¤–éƒ¨çš„ä½œç”¨åŸŸ`, ä¹Ÿè¦è€ƒè™‘`ä¸‹çº§ä½œç”¨åŸŸ`çš„ç»‘å®šæƒ…å†µï¼Œç¡®ä¿è¿™ä¸¤è€…éƒ½ä¸å†²çªã€‚

ä¸Šé¢çš„ä»£ç ä½œç”¨åŸŸå’Œæ ‡è¯†ç¬¦å¼•ç”¨æƒ…å†µå¦‚ä¸‹å›¾æ‰€ç¤º:

![webpack110](..\images\webpack110.png)

æ¥å§ï¼Œæ¥å—æŒ‘æˆ˜ï¼Œè¯•ç€å°†å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°é‡æ–°å‘½åä¸ºæ›´çŸ­çš„æ ‡è¯†ç¬¦:

```
// ç”¨äºè·å–å”¯ä¸€çš„æ ‡è¯†ç¬¦
const getUid = () => {
  let uid = 0
  return () => `_${(uid++) || ''}`
}

const ast = babel.parseSync(code)
traverse(ast, {
  FunctionDeclaration(path) {
    // è·å–ç¬¬ä¸€ä¸ªå‚æ•°
    const firstParam = path.get('params.0')
    if (firstParam == null) {
      return
    }

    const currentName = firstParam.node.name
    const currentBinding = path.scope.getBinding(currentName)
    const gid = getUid()
    let sname

    // å¾ªç¯æ‰¾å‡ºæ²¡æœ‰è¢«å ç”¨çš„å˜é‡å
    while(true) {
      sname = gid()

      // 1ï¸âƒ£é¦–å…ˆçœ‹ä¸€ä¸‹çˆ¶ä½œç”¨åŸŸæ˜¯å¦å·²å®šä¹‰äº†è¯¥å˜é‡
      if (path.scope.parentHasBinding(sname)) {
        continue
      }

      // 2ï¸âƒ£ æ£€æŸ¥å½“å‰ä½œç”¨åŸŸæ˜¯å¦å®šä¹‰äº†å˜é‡
      if (path.scope.hasOwnBinding(sname)) {
        // å·²å ç”¨
        continue
      }

      //  å†æ£€æŸ¥ç¬¬ä¸€ä¸ªå‚æ•°çš„å½“å‰çš„å¼•ç”¨æƒ…å†µ,
      // å¦‚æœå®ƒæ‰€åœ¨çš„ä½œç”¨åŸŸå®šä¹‰äº†åŒåçš„å˜é‡ï¼Œæˆ‘ä»¬ä¹Ÿå¾—æ”¾å¼ƒ
      if (currentBinding.references > 0) {
        let findIt = false
        for (const refNode of currentBinding.referencePaths) {
          if (refNode.scope !== path.scope && refNode.scope.hasBinding(sname)) {
            findIt = true
            break
          }
        }
        if (findIt) {
          continue
        }
      }
      break
    }

    // å¼€å§‹æ›¿æ¢æ‰
    const i = t.identifier(sname)
    currentBinding.referencePaths.forEach(p => p.replaceWith(i))
    firstParam.replaceWith(i)
  },
})

console.log(generate(ast).code)
// const a = 1,
//       b = 2;

// function add(_, bar) {
//   console.log(a, b);
//   return () => {
//     const a = '1'; // æ–°å¢äº†ä¸€ä¸ªå˜é‡å£°æ˜

//     return a + (_ + bar);
//   };
// }
```



ä¸Šé¢çš„ä¾‹å­è™½ç„¶æ²¡æœ‰ä»€ä¹ˆå®ç”¨æ€§ï¼Œè€Œä¸”è¿˜æœ‰Bug(æ²¡è€ƒè™‘`label`)ï¼Œä½†æ˜¯æ­£å¥½å¯ä»¥æ­ç¤ºäº†ä½œç”¨åŸŸå¤„ç†çš„å¤æ‚æ€§ã€‚



Babelçš„ `Scope` å¯¹è±¡å…¶å®æä¾›äº†ä¸€ä¸ª`generateUid`æ–¹æ³•æ¥ç”Ÿæˆå”¯ä¸€çš„ã€ä¸å†²çªçš„æ ‡è¯†ç¬¦ã€‚æˆ‘ä»¬åˆ©ç”¨è¿™ä¸ªæ–¹æ³•å†ç®€åŒ–ä¸€ä¸‹æˆ‘ä»¬çš„ä»£ç :

```
traverse(ast, {
  FunctionDeclaration(path) {
    const firstParam = path.get('params.0')
    if (firstParam == null) {
      return
    }
    let i = path.scope.generateUidIdentifier('_') // ä¹Ÿå¯ä»¥ä½¿ç”¨generateUid
    const currentBinding = path.scope.getBinding(firstParam.node.name)
    currentBinding.referencePaths.forEach(p => p.replaceWith(i))
    firstParam.replaceWith(i)
  },
})
```



èƒ½ä¸èƒ½å†çŸ­ç‚¹!

```
traverse(ast, {
  FunctionDeclaration(path) {
    const firstParam = path.get('params.0')
    if (firstParam == null) {
      return
    }
    let i = path.scope.generateUid('_') // ä¹Ÿå¯ä»¥ä½¿ç”¨generateUid
    path.scope.rename(firstParam.node.name, i)
  },
})
```

æŸ¥çœ‹generateUidçš„å®ç°ä»£ç 

```
generateUid(name: string = "temp") {
  name = t
    .toIdentifier(name)
    .replace(/^_+/, "")
    .replace(/[0-9]+$/g, "");

  let uid;
  let i = 0;
  do {
    uid = this._generateUid(name, i);
    i++;
  } while (
    this.hasLabel(uid) ||
    this.hasBinding(uid) ||
    this.hasGlobal(uid) ||
    this.hasReference(uid)
  );

  const program = this.getProgramParent();
  program.references[uid] = true;
  program.uids[uid] = true;

  return uid;
}

```



éå¸¸ç®€æ´å“ˆï¼Ÿä½œç”¨åŸŸæ“ä½œæœ€å…¸å‹çš„åœºæ™¯æ˜¯ä»£ç å‹ç¼©ï¼Œä»£ç å‹ç¼©ä¼šå¯¹å˜é‡åã€å‡½æ•°åç­‰è¿›è¡Œå‹ç¼©... ç„¶è€Œå®é™…ä¸Šå¾ˆå°‘çš„æ’ä»¶åœºæ™¯éœ€è¦è·Ÿä½œç”¨åŸŸè¿›è¡Œå¤æ‚çš„äº¤äº’ï¼Œæ‰€ä»¥å…³äºä½œç”¨åŸŸè¿™ä¸€å—å°±å…ˆè®²åˆ°è¿™é‡Œã€‚

### 2.5ã€å†™æ’ä»¶

æ¨¡ä»¿[babel-plugin-import](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fant-design%2Fbabel-plugin-import), å†™ä¸€ä¸ªæç®€ç‰ˆæ’ä»¶ï¼Œæ¥å®ç°æ¨¡å—çš„æŒ‰éœ€å¯¼å…¥. åœ¨è¿™ä¸ªæ’ä»¶ä¸­ï¼Œæˆ‘ä»¬ä¼šå°†ç±»ä¼¼è¿™æ ·çš„å¯¼å…¥è¯­å¥:

```
import {A, B, C as D} from 'foo'
```

è½¬æ¢ä¸º:

```
import A from 'foo/A'
import 'foo/A/style.css'
import B from 'foo/B'
import 'foo/B/style.css'
import D from 'foo/C'
import 'foo/C/style.css'
```

é¦–å…ˆé€šè¿‡ [AST Explorer](https://link.juejin.cn?target=https%3A%2F%2Fastexplorer.net) çœ‹ä¸€ä¸‹å¯¼å…¥è¯­å¥çš„ AST èŠ‚ç‚¹ç»“æ„:

![webpack111](..\images\webpack111.png)

é€šè¿‡ä¸Šé¢å±•ç¤ºçš„ç»“æœï¼Œæˆ‘ä»¬éœ€è¦å¤„ç† `ImportDeclaration` èŠ‚ç‚¹ç±»å‹ï¼Œå°†å®ƒçš„`specifiers`æ‹¿å‡ºæ¥éå†å¤„ç†ä¸€ä¸‹ã€‚å¦å¤–å¦‚æœç”¨æˆ·ä½¿ç”¨äº†`é»˜è®¤å¯¼å…¥`è¯­å¥ï¼Œæˆ‘ä»¬å°†æŠ›å‡ºé”™è¯¯ï¼Œæé†’ç”¨æˆ·ä¸èƒ½ä½¿ç”¨é»˜è®¤å¯¼å…¥.

åŸºæœ¬å®ç°å¦‚ä¸‹:

```
// è¦è¯†åˆ«çš„æ¨¡å—
const MODULE = 'foo'
traverse(ast, {
  // è®¿é—®å¯¼å…¥è¯­å¥
  ImportDeclaration(path) {
    if (path.node.source.value !== MODULE) {
      return
    }

    // å¦‚æœæ˜¯ç©ºå¯¼å…¥åˆ™ç›´æ¥åˆ é™¤æ‰
    const specs = path.node.specifiers
    if (specs.length === 0) {
      path.remove()
      return
    }

    // åˆ¤æ–­æ˜¯å¦åŒ…å«äº†é»˜è®¤å¯¼å…¥å’Œå‘½åç©ºé—´å¯¼å…¥
    if (specs.some(i => t.isImportDefaultSpecifier(i) || t.isImportNamespaceSpecifier(i))) {
      // æŠ›å‡ºé”™è¯¯ï¼ŒBabelä¼šå±•ç¤ºå‡ºé”™çš„ä»£ç å¸§
      throw path.buildCodeFrameError("ä¸èƒ½ä½¿ç”¨é»˜è®¤å¯¼å…¥æˆ–å‘½åç©ºé—´å¯¼å…¥")
    }

    // è½¬æ¢å‘½åå¯¼å…¥
    const imports = []
    for (const spec of specs) {
      const named = MODULE + '/' + spec.imported.name
      const local = spec.local
      imports.push(t.importDeclaration([t.importDefaultSpecifier(local)], t.stringLiteral(named)))
      imports.push(t.importDeclaration([], t.stringLiteral(`${named}/style.css`)))
    }

    // æ›¿æ¢åŸæœ‰çš„å¯¼å…¥è¯­å¥
    path.replaceWithMultiple(imports)
  }
})
```



é€»è¾‘è¿˜ç®—ç®€å•ï¼Œ`babel-plugin-import`å¯æ¯”è¿™å¤æ‚å¾—å¤šã€‚



æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†å®ƒå°è£…æˆæ ‡å‡†çš„ Babel æ’ä»¶ã€‚ æŒ‰ç…§è§„èŒƒï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ª`babel-plugin-*`å‰ç¼€çš„åŒ…åï¼š

```
mkdir babel-plugin-toy-import
cd babel-plugin-toy-import
yarn init -y
touch index.js
```



> ä½ ä¹Ÿå¯ä»¥é€šè¿‡ [generator-babel-plugin](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbabel%2Fgenerator-babel-plugin%2Ftree%2Fmaster%2Fgenerators%2Fapp%2Ftemplates) æ¥ç”Ÿæˆé¡¹ç›®æ¨¡æ¿.



åœ¨ `index.js` æ–‡ä»¶ä¸­å¡«å…¥æˆ‘ä»¬çš„ä»£ç ã€‚`index.js`é»˜è®¤å¯¼å‡ºä¸€ä¸ªå‡½æ•°ï¼Œå‡½æ•°ç»“æ„å¦‚ä¸‹:

```
// æ¥å—ä¸€ä¸ª babel-core å¯¹è±¡
export default function(babel) {
  const {types: t} = babel
  return {
    pre(state) {
      // å‰ç½®æ“ä½œï¼Œå¯é€‰ï¼Œå¯ä»¥ç”¨äºå‡†å¤‡ä¸€äº›èµ„æº
    },
    visitor: {
      // æˆ‘ä»¬çš„è®¿é—®è€…ä»£ç å°†æ”¾åœ¨è¿™é‡Œ
      ImportDeclaration(path, state) {
        // ...
      }
    },
    post(state) {
      // åç½®æ“ä½œï¼Œå¯é€‰
    }
  }
}
```



**æˆ‘ä»¬å¯ä»¥ä»è®¿é—®å™¨æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°`state`ä¸­è·å–ç”¨æˆ·ä¼ å…¥çš„å‚æ•°**ã€‚å‡è®¾ç”¨æˆ·é…ç½®ä¸º:

```
{
  plugins: [['toy-plugin', {name: 'foo'}]]
}
```

æˆ‘ä»¬å¯ä»¥è¿™æ ·è·å–ç”¨æˆ·ä¼ å…¥çš„å‚æ•°:

```
export default function(babel) {
  const {types: t} = babel
  return {
    visitor: {
      ImportDeclaration(path, state) {
        const mod = state.opts && state.opts.name
        if (mod == null) {
          return
        }
        // ...
      }
    },
  }
}
```

å‘å¸ƒ!

```
 yarn publish # good luck
```

## 3ã€babelçš„Apiä»‹ç»

### 3.1ã€@babel/parser

babel parser å« babylonï¼Œæ˜¯åŸºäº acorn å®ç°çš„ï¼Œæ‰©å±•äº†å¾ˆå¤šè¯­æ³•ï¼Œå¯ä»¥æ”¯æŒ esnextã€jsxã€flowã€typescript ç­‰è¯­æ³•çš„è§£æï¼Œå…¶ä¸­ jsxã€flowã€typescript è¿™äº›éæ ‡å‡†çš„è¯­æ³•çš„è§£æéœ€è¦æŒ‡å®šè¯­æ³•æ’ä»¶ã€‚

```js
require("@babel/parser").parse("code", {
    sourceType: â€œmoduleâ€,
    plugins: [
        "jsx",
        "typescript"
    ]
});
```

### 3.2ã€@babel/traverse

éå† ASTï¼Œå¹¶åœ¨éå†è¿‡ç¨‹ä¸­è°ƒç”¨ visitor å‡½æ•°è¿›è¡Œ AST çš„å¢åˆ æ”¹ï¼Œæä¾›äº† path çš„ api

```js
traverse(ast, {
    visitor: {
        Identifier (path, state) {},
        StringLiteral: {
            enter (path, state) {},
            exit (path, state) {}
        }
    }
})
```

![webpack105](..\images\webpack105.png)

```js
// è¿›å…¥ FunctionDeclaration èŠ‚ç‚¹æ—¶è°ƒç”¨
traverse(ast, {
    FunctionDeclaration: {
        enter(path, state) {}
    }
})

// é»˜è®¤æ˜¯è¿›å…¥èŠ‚ç‚¹æ—¶è°ƒç”¨ï¼Œå’Œä¸Šé¢ç­‰ä»·
traverse(ast, {
    FunctionDeclaration(path, state) {}
})

// è¿›å…¥ FunctionDeclaration å’Œ VariableDeclaration èŠ‚ç‚¹æ—¶è°ƒç”¨
traverse(ast, {
    'FunctionDeclaration|VariableDeclaration'(path, state) {}
    })

// é€šè¿‡åˆ«åæŒ‡å®šç¦»å¼€å„ç§ Declaration èŠ‚ç‚¹æ—¶è°ƒç”¨
traverse(ast, {
    Declaration: {
        exit(path, state) {}
    }
})
```

!![webpack106](..\images\webpack106.png)

**path** æ˜¯éå†è¿‡ç¨‹ä¸­çš„è·¯å¾„ï¼Œä¼šä¿ç•™ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œæœ‰å¾ˆå¤šå±æ€§å’Œæ–¹æ³•ï¼Œæ¯”å¦‚:

- path.node æŒ‡å‘å½“å‰ AST èŠ‚ç‚¹
- path.parent æŒ‡å‘çˆ¶çº§ AST èŠ‚ç‚¹
- path.getSiblingã€path.getNextSiblingã€path.getPrevSibling è·å–å…„å¼ŸèŠ‚ç‚¹
- path.getã€path.set è·å–å’Œè®¾ç½®å½“å‰èŠ‚ç‚¹å±æ€§çš„ path

ä¸Šè¿°å±æ€§å’Œæ–¹æ³•æ˜¯è·å–å½“å‰èŠ‚ç‚¹ä»¥åŠå®ƒçš„å…³è”èŠ‚ç‚¹çš„ã€‚

- path.scope è·å–å½“å‰èŠ‚ç‚¹çš„ä½œç”¨åŸŸä¿¡æ¯

ä¸Šè¿°å±æ€§å¯ä»¥è·å–ä½œç”¨åŸŸçš„ä¿¡æ¯ã€‚

- path.isXxx åˆ¤æ–­å½“å‰èŠ‚ç‚¹æ˜¯ä¸æ˜¯ Xxx ç±»å‹
- path.assertXxx åˆ¤æ–­å½“å‰èŠ‚ç‚¹æ˜¯ä¸æ˜¯ Xxx ç±»å‹ï¼Œä¸æ˜¯åˆ™æŠ›å‡ºå¼‚å¸¸

ä¸Šè¿° isXxxã€assertXxx ç³»åˆ—æ–¹æ³•å¯ä»¥ç”¨äºåˆ¤æ–­ AST ç±»å‹ã€‚

- path.insertBeforeã€path.insertAfter æ’å…¥èŠ‚ç‚¹
- path.replaceWithã€path.replaceWithMultipleã€replaceWithSourceString æ›¿æ¢èŠ‚ç‚¹
- path.remove åˆ é™¤èŠ‚ç‚¹

ä¸Šè¿°æ–¹æ³•å¯ä»¥å¯¹ AST è¿›è¡Œå¢åˆ æ”¹ã€‚

- path.skip è·³è¿‡å½“å‰èŠ‚ç‚¹çš„å­èŠ‚ç‚¹çš„éå†
- path.stop ç»“æŸåç»­éå†

ä¸Šè¿°æ–¹æ³•å¯ä»¥è·³è¿‡ä¸€äº›éå†ã€‚

### 3.3ã€@babel/types

éå† AST çš„è¿‡ç¨‹ä¸­éœ€è¦åˆ›å»ºä¸€äº› AST å’Œåˆ¤æ–­ AST çš„ç±»å‹ï¼Œè¿™æ—¶å€™å°±éœ€è¦ @babel/types åŒ…ã€‚

```js
t.ifStatement(test, consequent, alternate);
t.isIfStatement(node, opts);
t.assertIfStatement(node, opts);
t.isIdentifier(node, { name: "paths" }
```

### 3.4ã€@babel/template

é€šè¿‡ @babel/types åˆ›å»º AST è¿˜æ˜¯æ¯”è¾ƒéº»çƒ¦çš„ï¼Œè¦ä¸€ä¸ªä¸ªçš„åˆ›å»ºç„¶åç»„è£…ï¼Œå¦‚æœ AST èŠ‚ç‚¹æ¯”è¾ƒå¤šçš„è¯éœ€è¦å†™å¾ˆå¤šä»£ç ï¼Œè¿™æ—¶å€™å°±å¯ä»¥ä½¿ç”¨ @babel/template åŒ…æ¥æ‰¹é‡åˆ›å»ºã€‚

```js
const ast = template(code, [opts])(args);
const ast = template.ast(code, [opts]);
const ast = template.program(code, [opts]);
const ast = template.expression(code, [opts]);
const ast = template.statement(code, [opts]);

const fn = template(`console.log(NAME)`);

const astArr = template.statements(code, [opts]);
const ast = fn({
    NAME: t.stringLiteral("guang"),
});
```

### 3.5ã€@babel/generator

AST è½¬æ¢å®Œä¹‹åå°±è¦æ‰“å°æˆç›®æ ‡ä»£ç å­—ç¬¦ä¸²ï¼Œé€šè¿‡ @babel/generator åŒ…çš„ apiã€‚

```js
const { code, map } = generate(ast, { sourceMaps: true })
```

### 3.6ã€@babel/code-frame

å½“æœ‰é”™è¯¯ä¿¡æ¯è¦æ‰“å°çš„æ—¶å€™ï¼Œéœ€è¦æ‰“å°é”™è¯¯ä½ç½®çš„ä»£ç ï¼Œå¯ä»¥ä½¿ç”¨ @babel/code-frameã€‚

```js
const { codeFrameColumns } = require("@babel/code-frame");

try {
    throw new Error("xxx é”™è¯¯");
} catch (err) {
    console.error(codeFrameColumns(`const name = guang`, {
        start: { line: 1, column: 14 }
    }, {
        highlightCode: true,
        message: err.message
    }));
}
```

### 3.7ã€@babel/core

@babel/core åŒ…åˆ™æ˜¯åŸºäºå‰é¢çš„åŒ…å®Œæˆæ•´ä¸ªç¼–è¯‘æµç¨‹ï¼Œä»æºç åˆ°ç›®æ ‡ä»£ç ï¼Œç”Ÿæˆ sourcemap

```js
transformSync(code, options); // => { code, map, ast }
transformFileSync(filename, options); // => { code, map, ast }
transformFromAstSync(
    parsedAst,
    sourceCode,
    options
); // => { code, map, ast }

transformAsync("code();", options).then(result => {})
transformFileAsync("filename.js", options).then(result => {})
transformFromAstAsync(parsedAst, sourceCode, options).then(result => {})
```

### 3.8ã€@babel/cli

```
babel`ä¸`webpack`ç±»ä¼¼ï¼Œéƒ½æŠŠ **CLIå‘½ä»¤è¡Œå·¥å…·** å•ç‹¬æ‹†åˆ†å‡ºæ¥ï¼Œä¾¿äºç»´æŠ¤å’ŒæŒ‰éœ€å¯¼å…¥ï¼Œwebpackå‘½ä»¤è¡Œå·¥å…·åŒ…æ˜¯`webpack-cli
```

#### ä»‹ç»

`babel`å®˜æ–¹æä¾›çš„CLIå‘½ä»¤è¡Œå·¥å…·ï¼Œä¸»è¦æ˜¯æä¾›`babel`è¿™ä¸ªå‘½ä»¤

#### ä½œç”¨

æä¾›äº†ä¸€ç§é€šè¿‡å‘½ä»¤æ¥ä½¿ç”¨`babel`çš„æ–¹å¼ï¼Œç®€ç§°å‘½ä»¤æ–¹å¼ï¼Œå…¶å®ç°åœ¨å¾ˆå¤šå·¥å…·ä¹Ÿæä¾›è¿™ç±»æ–¹å¼ï¼Œä¾‹å¦‚ï¼š`webpack`æä¾›çš„`webpack-cli`ç­‰

> `æ³¨æ„`ï¼š è™½ç„¶æä¾›äº†è¿™ç§å‘½ä»¤æ–¹å¼æ¥ä½¿ç”¨babelï¼Œä½†ç”±äº**å‘½ä»¤æ–¹å¼é€‰é¡¹è¿‡äºç¹å¤šï¼Œç¼–å†™èµ·æ¥ä¸æ–¹ä¾¿**ï¼Œæ‰€ä»¥ä¸é€‚åˆå¼€å‘å’Œç”Ÿäº§ä½¿ç”¨ï¼Œä¸€èˆ¬åªæ˜¯å­¦ä¹ æ—¶ä½¿ç”¨ï¼Œå¼€å‘å’Œç”Ÿäº§ä¸€èˆ¬ä½¿ç”¨**é›†æˆæ–¹å¼**ï¼Œåé¢ä¼šè®²

#### å®‰è£…

```css
// å¿…é¡»ä½œä¸ºå¼€å‘ä¾èµ–
npm i @babel/cli -D 
```

## 4ã€`polyfill`

å…³äº`polyfill`ï¼Œæˆ‘ä»¬å…ˆæ¥è§£é‡Šä¸‹ä½•è°“`polyfill`ã€‚

é¦–å…ˆæˆ‘ä»¬æ¥ç†æ¸…æ¥šè¿™ä¸‰ä¸ªæ¦‚å¿µ:

- æœ€æ–°`ES`è¯­æ³•ï¼Œæ¯”å¦‚ï¼šç®­å¤´å‡½æ•°ï¼Œ`let/const`ã€‚
- æœ€æ–°`ES Api`ï¼Œæ¯”å¦‚`Promise`
- æœ€æ–°`ES`å®ä¾‹/é™æ€æ–¹æ³•ï¼Œæ¯”å¦‚`String.prototype.include`

`babel-prest-env`ä»…ä»…åªä¼šè½¬åŒ–æœ€æ–°çš„`es`è¯­æ³•ï¼Œå¹¶ä¸ä¼šè½¬åŒ–å¯¹åº”çš„`Api`å’Œå®ä¾‹æ–¹æ³•ï¼Œæ¯”å¦‚è¯´`ES 6`ä¸­çš„`Array.from`é™æ€æ–¹æ³•ã€‚`babel`æ˜¯ä¸ä¼šè½¬è¯‘è¿™ä¸ªæ–¹æ³•çš„ï¼Œå¦‚æœæƒ³åœ¨ä½ç‰ˆæœ¬æµè§ˆå™¨ä¸­è¯†åˆ«å¹¶ä¸”è¿è¡Œ`Array.from`æ–¹æ³•è¾¾åˆ°æˆ‘ä»¬çš„é¢„æœŸå°±éœ€è¦é¢å¤–å¼•å…¥`polyfill`è¿›è¡Œåœ¨`Array`ä¸Šæ·»åŠ å®ç°è¿™ä¸ªæ–¹æ³•ã€‚

å…¶å®å¯ä»¥ç¨å¾®ç®€å•æ€»ç»“ä¸€ä¸‹ï¼Œ**è¯­æ³•å±‚é¢çš„è½¬åŒ–`preset-env`å®Œå…¨å¯ä»¥èƒœä»»ã€‚ä½†æ˜¯ä¸€äº›å†…ç½®æ–¹æ³•æ¨¡å—ï¼Œä»…ä»…é€šè¿‡`preset-env`çš„è¯­æ³•è½¬åŒ–æ˜¯æ— æ³•è¿›è¡Œè¯†åˆ«è½¬åŒ–çš„ï¼Œæ‰€ä»¥å°±éœ€è¦ä¸€ç³»åˆ—ç±»ä¼¼â€å«ç‰‡â€œçš„å·¥å…·è¿›è¡Œè¡¥å……å®ç°è¿™éƒ¨åˆ†å†…å®¹çš„ä½ç‰ˆæœ¬ä»£ç å®ç°ã€‚è¿™å°±æ˜¯æ‰€è°“çš„`polyfill`çš„ä½œç”¨**

> polyfillåœ¨è‹±æ–‡ä¸­æœ‰å«ç‰‡çš„æ„æ€ï¼Œæ„ä¸ºå…œåº•çš„ä¸œè¥¿ã€‚

é’ˆå¯¹äº`polyfill`æ–¹æ³•çš„å†…å®¹ï¼Œ`babel`ä¸­æ¶‰åŠä¸¤ä¸ªæ–¹é¢æ¥è§£å†³ï¼š

- `@babel/polyfill`
- `@babel/runtime`
- `@babel/plugin-transform-runtime`

æˆ‘ä»¬ç†æ¸…äº†ä½•è°“`polyfill`ä»¥åŠ`polyfill`çš„ä½œç”¨å’Œå«ä¹‰åï¼Œè®©æˆ‘ä»¬æ¥é€ä¸ªå‡»ç ´è¿™ä¸¤ä¸ª`babel`åŒ…å¯¹åº”çš„ä½¿ç”¨æ–¹å¼å’ŒåŒºåˆ«å§ã€‚æˆ‘ä»¬ç†æ¸…äº†ä½•è°“`polyfill`ä»¥åŠ`polyfill`çš„ä½œç”¨å’Œå«ä¹‰åï¼Œè®©æˆ‘ä»¬æ¥é€ä¸ªå‡»ç ´è¿™ä¸¤ä¸ª`babel`åŒ…å¯¹åº”çš„ä½¿ç”¨æ–¹å¼å’ŒåŒºåˆ«å§ã€‚

### 4.1ã€`@babel/polyfill`

é¦–å…ˆæˆ‘ä»¬æ¥çœ‹çœ‹ç¬¬ä¸€ç§å®ç°`polyfill`çš„æ–¹å¼ï¼š

#### `@babel/polyfill`ä»‹ç»

é€šè¿‡[babelPolyfill](https://link.juejin.cn?target=https%3A%2F%2Fbabeljs.io%2Fdocs%2Fen%2Fbabel-polyfill)é€šè¿‡å¾€å…¨å±€å¯¹è±¡ä¸Šæ·»åŠ å±æ€§ä»¥åŠç›´æ¥ä¿®æ”¹å†…ç½®å¯¹è±¡çš„`Prototype`ä¸Šæ·»åŠ æ–¹æ³•å®ç°`polyfill`ã€‚

æ¯”å¦‚è¯´æˆ‘ä»¬éœ€è¦æ”¯æŒ`String.prototype.include`ï¼Œåœ¨å¼•å…¥`babelPolyfill`è¿™ä¸ªåŒ…ä¹‹åï¼Œå®ƒä¼šåœ¨å…¨å±€`String`çš„åŸå‹å¯¹è±¡ä¸Šæ·»åŠ `include`æ–¹æ³•ä»è€Œæ”¯æŒæˆ‘ä»¬çš„`Js Api`ã€‚

æˆ‘ä»¬è¯´åˆ°è¿™ç§æ–¹å¼æœ¬è´¨ä¸Šæ˜¯å¾€å…¨å±€å¯¹è±¡/å†…ç½®å¯¹è±¡ä¸ŠæŒ‚è½½å±æ€§ï¼Œæ‰€ä»¥è¿™ç§æ–¹å¼éš¾å…ä¼šé€ æˆå…¨å±€æ±¡æŸ“ã€‚

#### åº”ç”¨`@babel/polyfill`

åœ¨`babel-preset-env`ä¸­å­˜åœ¨ä¸€ä¸ª`useBuiltIns`å‚æ•°ï¼Œè¿™ä¸ªå‚æ•°å†³å®šäº†å¦‚ä½•åœ¨`preset-env`ä¸­ä½¿ç”¨`@babel/polyfill`ã€‚

```json
{
    "presets": [
        ["@babel/preset-env", {
            "useBuiltIns": false
        }]
    ]
}
```

- `useBuiltIns`--`"usage"`| `"entry"`| `false`

##### `false`

å½“æˆ‘ä»¬ä½¿ç”¨`preset-env`ä¼ å…¥`useBuiltIns`å‚æ•°æ—¶å€™ï¼Œé»˜è®¤ä¸º`false`ã€‚å®ƒè¡¨ç¤ºä»…ä»…ä¼šè½¬åŒ–æœ€æ–°çš„`ES`è¯­æ³•ï¼Œå¹¶ä¸ä¼šè½¬åŒ–ä»»ä½•`Api`å’Œæ–¹æ³•ã€‚

##### `entry`

å½“ä¼ å…¥`entry`æ—¶ï¼Œéœ€è¦æˆ‘ä»¬åœ¨é¡¹ç›®å…¥å£æ–‡ä»¶ä¸­**æ‰‹åŠ¨å¼•å…¥ä¸€æ¬¡`core-js`ï¼Œ**å®ƒä¼šæ ¹æ®æˆ‘ä»¬é…ç½®çš„æµè§ˆå™¨å…¼å®¹æ€§åˆ—è¡¨(`browserList`)ç„¶å**å…¨é‡**å¼•å…¥ä¸å…¼å®¹çš„`polyfill`ã€‚

> Tips:  åœ¨`Babel 7.4ã€‚0`ä¹‹åï¼Œ`@babel/polyfill`è¢«åºŸå¼ƒå®ƒå˜æˆå¦å¤–ä¸¤ä¸ªåŒ…çš„é›†æˆã€‚`"core-js/stable"; "regenerator-runtime/runtime";`ã€‚ä½ å¯ä»¥åœ¨è¿™é‡Œçœ‹åˆ°[å˜åŒ–](https://link.juejin.cn?target=https%3A%2F%2Fbabeljs.io%2Fdocs%2Fen%2Fbabel-polyfill)ï¼Œä½†æ˜¯ä»–ä»¬çš„ä½¿ç”¨æ–¹å¼æ˜¯ä¸€è‡´çš„ï¼Œåªæ˜¯åœ¨å…¥å£æ–‡ä»¶ä¸­å¼•å…¥çš„åŒ…ä¸åŒäº†ã€‚

> [æµè§ˆå™¨å…¼å®¹æ€§åˆ—è¡¨é…ç½®æ–¹å¼ç®€ä»‹ä½ å¯ä»¥åœ¨è¿™é‡Œçœ‹åˆ°](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbrowserslist%2Fbrowserslist)ã€‚

```javascript
// é¡¹ç›®å…¥å£æ–‡ä»¶ä¸­éœ€è¦é¢å¤–å¼•å…¥polyfill
// core-js 2.0ä¸­æ˜¯ä½¿ç”¨"@babel/polyfill" core-js3.0ç‰ˆæœ¬ä¸­å˜åŒ–æˆä¸ºäº†ä¸Šè¾¹ä¸¤ä¸ªåŒ…
import "@babel/polyfill"

// babel
{
    "presets": [
        ["@babel/preset-env", {
            "useBuiltIns": "entry"
        }]
    ]
}
```

> åŒæ—¶éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨æˆ‘ä»¬ä½¿ç”¨`useBuiltIns:entry/usage`æ—¶ï¼Œéœ€è¦é¢å¤–æŒ‡å®š`core-js`è¿™ä¸ªå‚æ•°ã€‚é»˜è®¤ä¸ºä½¿ç”¨`core-js 2.0`ï¼Œæ‰€è°“çš„`core-js`å°±æ˜¯æˆ‘ä»¬ä¸Šæ–‡è®²åˆ°çš„â€œå«ç‰‡â€çš„å®ç°ã€‚å®ƒä¼šå®ç°ä¸€ç³»åˆ—å†…ç½®æ–¹æ³•æˆ–è€…`Promise`ç­‰`Api`ã€‚

> `core-js 2.0`ç‰ˆæœ¬æ˜¯è·Ÿéš`preset-env`ä¸€èµ·å®‰è£…çš„ï¼Œä¸éœ€è¦å•ç‹¬å®‰è£…å“¦ï½

##### `usage`

ä¸Šè¾¹æˆ‘ä»¬è¯´åˆ°é…ç½®ä¸º`entry`æ—¶ï¼Œ`perset-env`ä¼šåŸºäºæˆ‘ä»¬çš„æµè§ˆå™¨å…¼å®¹åˆ—è¡¨è¿›è¡Œå…¨é‡å¼•å…¥`polyfill`ã€‚æ‰€è°“çš„å…¨é‡å¼•å…¥æ¯”å¦‚è¯´æˆ‘ä»¬ä»£ç ä¸­ä»…ä»…ä½¿ç”¨äº†`Array.from`è¿™ä¸ªæ–¹æ³•ã€‚ä½†æ˜¯`polyfill`å¹¶ä¸ä»…ä»…ä¼šå¼•å…¥`Array.from`ï¼ŒåŒæ—¶ä¹Ÿä¼šå¼•å…¥`Promise`ã€`Array.prototype.include`ç­‰å…¶ä»–å¹¶æœªä½¿ç”¨åˆ°çš„æ–¹æ³•ã€‚è¿™å°±ä¼šé€ æˆåŒ…ä¸­å¼•å…¥çš„ä½“ç§¯å¤ªå¤§äº†ã€‚

æ­¤æ—¶å°±å¼•å…¥å‡ºäº†æˆ‘ä»¬çš„`useBuintIns:usage`é…ç½®ã€‚

å½“æˆ‘ä»¬é…ç½®`useBuintIns:usage`æ—¶ï¼Œä¼šæ ¹æ®é…ç½®çš„æµè§ˆå™¨å…¼å®¹ï¼Œä»¥åŠä»£ç ä¸­ **ä½¿ç”¨åˆ°çš„`Api` è¿›è¡Œå¼•å…¥`polyfill`æŒ‰éœ€æ·»åŠ ã€‚**

å½“ä½¿ç”¨`usage`æ—¶ï¼Œ**æˆ‘ä»¬ä¸éœ€è¦é¢å¤–åœ¨é¡¹ç›®å…¥å£ä¸­å¼•å…¥`polyfill`äº†**ï¼Œå®ƒä¼šæ ¹æ®æˆ‘ä»¬é¡¹ç›®ä¸­ä½¿ç”¨åˆ°çš„è¿›è¡ŒæŒ‰éœ€å¼•å…¥ã€‚

```json
{
    "presets": [
        ["@babel/preset-env", {
            "useBuiltIns": "usage",
            "core-js": 3
        }]
    ]
}
```

###### **å…³äº`usage`å’Œ`entry`å­˜åœ¨ä¸€ä¸ªéœ€è¦æ³¨æ„çš„æœ¬è´¨ä¸Šçš„åŒºåˆ«ã€‚**

æˆ‘ä»¬ä»¥é¡¹ç›®ä¸­å¼•å…¥`Promise`ä¸ºä¾‹ã€‚

å½“æˆ‘ä»¬é…ç½®`useBuintInts:entry`æ—¶ï¼Œä»…ä»…ä¼šåœ¨å…¥å£æ–‡ä»¶å…¨é‡å¼•å…¥ä¸€æ¬¡`polyfill`ã€‚ä½ å¯ä»¥è¿™æ ·ç†è§£:

```js
// å½“ä½¿ç”¨entryé…ç½®æ—¶
...
// ä¸€ç³»åˆ—å®ç°polyfillçš„æ–¹æ³•
global.Promise = promise

// å…¶ä»–æ–‡ä»¶ä½¿ç”¨æ—¶
const a = new Promise()
```

è€Œå½“æˆ‘ä»¬ä½¿ç”¨`useBuintIns:usage`æ—¶ï¼Œ`preset-env`åªèƒ½åŸºäºå„ä¸ªæ¨¡å—å»åˆ†æå®ƒä»¬ä½¿ç”¨åˆ°çš„`polyfill`ä»è€Œè¿›å…¥å¼•å…¥ã€‚

`preset-env`ä¼šå¸®åŠ©æˆ‘ä»¬æ™ºèƒ½åŒ–çš„åœ¨éœ€è¦çš„åœ°æ–¹å¼•å…¥ï¼Œæ¯”å¦‚:

```js
// a. js ä¸­
import "core-js/modules/es.promise";

...
```

```
// b.jsä¸­

import "core-js/modules/es.promise";
...
```



- åœ¨`usage`æƒ…å†µä¸‹ï¼Œå¦‚æœæˆ‘ä»¬å­˜åœ¨å¾ˆå¤šä¸ªæ¨¡å—ï¼Œé‚£ä¹ˆæ— ç–‘ä¼šå¤šå‡ºå¾ˆå¤šå†—ä½™ä»£ç (`import`è¯­æ³•)ã€‚
- åŒæ ·åœ¨ä½¿ç”¨`usage`æ—¶å› ä¸ºæ˜¯æ¨¡å—å†…éƒ¨å±€éƒ¨å¼•å…¥`polyfill`æ‰€ä»¥æŒ‰éœ€åœ¨æ¨¡å—å†…è¿›è¡Œå¼•å…¥ï¼Œè€Œ`entry`åˆ™ä¼šåœ¨ä»£ç å…¥å£ä¸­ä¸€æ¬¡æ€§å¼•å…¥ã€‚

`usageBuintIns`ä¸åŒå‚æ•°åˆ†åˆ«æœ‰ä¸åŒåœºæ™¯çš„é€‚åº”åº¦ï¼Œå…·ä½“å‚æ•°ä½¿ç”¨åœºæ™¯è¿˜éœ€è¦å¤§å®¶ç»“åˆè‡ªå·±çš„é¡¹ç›®å®é™…æƒ…å†µæ‰¾åˆ°æœ€ä½³æ–¹å¼ã€‚

### 4.2ã€`@babel/runtime`

ä¸Šè¾¹æˆ‘ä»¬è®²åˆ°`@babel/polyfill`æ˜¯å­˜åœ¨æ±¡æŸ“å…¨å±€å˜é‡çš„å‰¯ä½œç”¨ï¼Œåœ¨å®ç°`polyfill`æ—¶`Babel`è¿˜æä¾›äº†å¦å¤–ä¸€ç§æ–¹å¼å»è®©æˆ‘ä»¬å®ç°è¿™åŠŸèƒ½ï¼Œé‚£å°±æ˜¯`@babel/runtime`ã€‚

ç®€å•æ¥è®²ï¼Œ`@babel/runtime`æ›´åƒæ˜¯ä¸€ç§**æŒ‰éœ€åŠ è½½çš„è§£å†³æ–¹æ¡ˆ**ï¼Œæ¯”å¦‚å“ªé‡Œéœ€è¦ä½¿ç”¨åˆ°`Promise`ï¼Œ`@babel/runtime`å°±ä¼šåœ¨ä»–çš„æ–‡ä»¶é¡¶éƒ¨æ·»åŠ `import promise from 'babel-runtime/core-js/promise'`ã€‚

åŒæ—¶ä¸Šè¾¹æˆ‘ä»¬è®²åˆ°å¯¹äº`preset-env`çš„`useBuintIns`é…ç½®é¡¹ï¼Œæˆ‘ä»¬çš„`polyfill`æ˜¯`preset-env`å¸®æˆ‘ä»¬æ™ºèƒ½å¼•å…¥ã€‚

è€Œ`babel-runtime`åˆ™ä¼šå°†å¼•å…¥æ–¹å¼ç”±æ™ºèƒ½å®Œå…¨äº¤ç”±æˆ‘ä»¬è‡ªå·±ï¼Œæˆ‘ä»¬éœ€è¦ä»€ä¹ˆè‡ªå·±å¼•å…¥ä»€ä¹ˆã€‚

å®ƒçš„ç”¨æ³•å¾ˆç®€å•ï¼Œåªè¦æˆ‘ä»¬å»å®‰è£…`npm install --save @babel/runtime`åï¼Œåœ¨éœ€è¦ä½¿ç”¨å¯¹åº”çš„`polyfill`çš„åœ°æ–¹å»å•ç‹¬å¼•å…¥å°±å¯ä»¥äº†ã€‚æ¯”å¦‚ï¼š

```js
// a.js ä¸­éœ€è¦ä½¿ç”¨Promise æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨å¼•å…¥å¯¹åº”çš„è¿è¡Œæ—¶polyfill
import Promise from 'babel-runtime/core-js/promise'

const promsies = new Promise()
```

æ€»è€Œè¨€ä¹‹ï¼Œ`babel/runtime`ä½ å¯ä»¥ç†è§£ç§°ä¸ºå°±æ˜¯ä¸€ä¸ªè¿è¡Œæ—¶â€œå“ªé‡Œéœ€è¦å¼•å“ªé‡Œâ€çš„å·¥å…·åº“ã€‚

> é’ˆå¯¹`babel/runtime`ç»å¤§å¤šæ•°æƒ…å†µä¸‹æˆ‘ä»¬éƒ½ä¼šé…åˆ`@babel/plugin-transfrom-runtime`è¿›è¡Œä½¿ç”¨è¾¾åˆ°æ™ºèƒ½åŒ–`runtime`çš„`polyfill`å¼•å…¥ã€‚

### 4.3ã€`@babel/plugin-transform-runtime`

#### `babel-runtime`å­˜åœ¨çš„é—®é¢˜

`babel-runtime`åœ¨æˆ‘ä»¬æ‰‹åŠ¨å¼•å…¥ä¸€äº›`polyfill`çš„æ—¶å€™ï¼Œå®ƒä¼šç»™æˆ‘ä»¬çš„ä»£ç ä¸­æ³¨å…¥ä¸€äº›ç±»ä¼¼`_extend()ï¼Œ classCallCheck()`ä¹‹ç±»çš„å·¥å…·å‡½æ•°ï¼Œè¿™äº›å·¥å…·å‡½æ•°çš„ä»£ç ä¼šåŒ…å«åœ¨ç¼–è¯‘åçš„æ¯ä¸ªæ–‡ä»¶ä¸­ï¼Œæ¯”å¦‚ï¼š

```js
class Circle {}
// babel-runtime ç¼–è¯‘Classéœ€è¦å€ŸåŠ©_classCallCheckè¿™ä¸ªå·¥å…·å‡½æ•°
function _classCallCheck(instance, Constructor) { //... } 
var Circle = function Circle() { _classCallCheck(this, Circle); };
```

å¦‚æœæˆ‘ä»¬é¡¹ç›®ä¸­å­˜åœ¨å¤šä¸ªæ–‡ä»¶ä½¿ç”¨äº†`class`ï¼Œé‚£ä¹ˆæ— ç–‘åœ¨æ¯ä¸ªæ–‡ä»¶ä¸­æ³¨å…¥è¿™æ ·ä¸€æ®µå†—ä½™é‡å¤çš„å·¥å…·å‡½æ•°å°†æ˜¯ä¸€ç§ç¾éš¾ã€‚

æ‰€ä»¥é’ˆå¯¹ä¸Šè¿°æåˆ°çš„ä¸¤ä¸ªé—®é¢˜:

- `babel-runtime`æ— æ³•åšåˆ°æ™ºèƒ½åŒ–åˆ†æï¼Œéœ€è¦æˆ‘ä»¬æ‰‹åŠ¨å¼•å…¥ã€‚
- `babel-runtime`ç¼–è¯‘è¿‡ç¨‹ä¸­ä¼šé‡å¤ç”Ÿæˆå†—ä½™ä»£ç ã€‚

æˆ‘ä»¬å°±è¦å¼•å…¥æˆ‘ä»¬çš„ä¸»è§’`@babel/plugin-transform-runtime`ã€‚

#### `@babel/plugin-transform-runtime`ä½œç”¨

`@babel/plugin-transform-runtime`æ’ä»¶çš„ä½œç”¨æ°æ°å°±æ˜¯ä¸ºäº†è§£å†³ä¸Šè¿°æˆ‘ä»¬æåˆ°çš„`babel-runtime`å­˜åœ¨çš„é—®é¢˜è€Œæå‡ºçš„æ’ä»¶ã€‚

- `babel-runtime`æ— æ³•åšåˆ°æ™ºèƒ½åŒ–åˆ†æï¼Œéœ€è¦æˆ‘ä»¬æ‰‹åŠ¨å¼•å…¥ã€‚

`@babel/plugin-transform-runtime`æ’ä»¶ä¼šæ™ºèƒ½åŒ–çš„åˆ†ææˆ‘ä»¬çš„é¡¹ç›®ä¸­æ‰€ä½¿ç”¨åˆ°éœ€è¦è½¬è¯‘çš„`js`ä»£ç ï¼Œä»è€Œå®ç°æ¨¡å—åŒ–ä»`babel-runtime`ä¸­å¼•å…¥æ‰€éœ€çš„`polyfill`å®ç°ã€‚

- `babel-runtime`ç¼–è¯‘è¿‡ç¨‹ä¸­ä¼šé‡å¤ç”Ÿæˆå†—ä½™ä»£ç ã€‚

`@babel/plugin-transform-runtime`æ’ä»¶æä¾›äº†ä¸€ä¸ª`helpers`å‚æ•°ã€‚å…·ä½“ä½ å¯ä»¥åœ¨[è¿™é‡ŒæŸ¥é˜…å®ƒçš„æ‰€æœ‰é…ç½®å‚æ•°](https://link.juejin.cn?target=https%3A%2F%2Fbabeljs.io%2Fdocs%2Fen%2Fbabel-plugin-transform-runtime%23helpers)ã€‚

è¿™ä¸ª`helpers`å‚æ•°å¼€å¯åå¯ä»¥å°†ä¸Šè¾¹æåˆ°ç¼–è¯‘é˜¶æ®µé‡å¤çš„å·¥å…·å‡½æ•°ï¼Œæ¯”å¦‚`classCallCheck, extends`ç­‰ä»£ç è½¬åŒ–ç§°ä¸º`require`è¯­å¥ã€‚æ­¤æ—¶ï¼Œè¿™äº›å·¥å…·å‡½æ•°å°±ä¸ä¼šé‡å¤çš„å‡ºç°åœ¨ä½¿ç”¨ä¸­çš„æ¨¡å—ä¸­äº†ã€‚æ¯”å¦‚è¿™æ ·ï¼š

```js
// @babel/plugin-transform-runtimeä¼šå°†å·¥å…·å‡½æ•°è½¬åŒ–ä¸ºrequireè¯­å¥è¿›è¡Œå¼•å…¥
// è€Œéruntimeé‚£æ ·ç›´æ¥å°†å·¥å…·æ¨¡å—ä»£ç æ³¨å…¥åˆ°æ¨¡å—ä¸­
var _classCallCheck = require("@babel/runtime/helpers/classCallCheck"); 
var Circle = function Circle() { _classCallCheck(this, Circle); };
```

#### é…ç½®`@babel/plugin-transform-runtime`

å…¶å®ç”¨æ³•åŸç†éƒ¨åˆ†å·²ç»åœ¨ä¸Šè¾¹åˆ†æçš„æ¯”è¾ƒé€å½»äº†ï¼Œé…ç½®è¿™é‡Œè¿˜æœ‰ç–‘é—®çš„åŒå­¦å¯ä»¥è¯„è®ºåŒºç»™æˆ‘ç•™è¨€æˆ–è€…ç§»æ­¥`babel`[å®˜ç½‘æŸ¥çœ‹](https://link.juejin.cn?target=https%3A%2F%2Fbabeljs.io%2Fdocs%2Fen%2Fbabel-plugin-transform-runtime)ã€‚

è¿™é‡Œä¸ºåˆ—ä¸€ä»½ç›®å‰å®ƒçš„é»˜è®¤é…ç½®:

```json
{
  "plugins": [
    [
      "@babel/plugin-transform-runtime",
      {
        "absoluteRuntime": false,
        "corejs": false,
        "helpers": true,
        "regenerator": true,
        "version": "7.0.0-beta.0"
      }
    ]
  ]
}
```

**è¿™ç§æ–¹å¼ç›®å‰ä¸æ”¯æŒè®¾ç½® targetsï¼Œæ‰€ä»¥ä¸ä¼šè€ƒè™‘ç›®æ ‡ç¯å¢ƒæ˜¯å¦å·²ç»æ”¯æŒï¼Œå®ƒæ˜¯é€šè¿‡å±€éƒ¨å˜é‡çš„æ–¹å¼å®ç°äº†æ‰€æœ‰è¢«ç”¨åˆ°çš„ built-in ç±»å‹è¯­æ³•ï¼Œä¸ä¼šæ±¡æŸ“å…¨å±€ã€‚**

### 4.4ã€æ€»ç»“`polyfill`

åœ¨`babel`ä¸­å®ç°`polyfill`ä¸»è¦æœ‰ä¸¤ç§æ–¹å¼ï¼š

- ä¸€ç§æ˜¯é€šè¿‡`@babel/polyfill`é…åˆ`preset-env`å»ä½¿ç”¨ï¼Œè¿™ç§æ–¹å¼å¯èƒ½ä¼šå­˜åœ¨æ±¡æŸ“å…¨å±€ä½œç”¨åŸŸã€‚
- ä¸€ç§æ˜¯é€šè¿‡`@babel/runtime`é…åˆ`@babel/plugin-transform-runtime`å»ä½¿ç”¨ï¼Œè¿™ç§æ–¹å¼å¹¶ä¸ä¼šæ±¡æŸ“ä½œç”¨åŸŸã€‚
- å…¨å±€å¼•å…¥ä¼šæ±¡æŸ“å…¨å±€ä½œç”¨åŸŸï¼Œä½†æ˜¯ç›¸å¯¹äºå±€éƒ¨å¼•å…¥æ¥è¯´ã€‚å®ƒä¼šå¢åŠ å¾ˆå¤šé¢å¤–çš„å¼•å…¥è¯­å¥ï¼Œå¢åŠ åŒ…ä½“ç§¯ã€‚

åœ¨`useBuintIns:usage`æƒ…å†µä¸‹å…¶å®å’Œ`@babel/plugin-transform-runtime`æƒ…å†µä¸‹æ˜¯ç±»ä¼¼çš„ä½œç”¨ï¼Œ

ä¸¤è€…çš„é€‰æ‹©ï¼š

- å¦‚æœé¡¹ç›®å¯¹æ‰“åŒ…**ä½“ç§¯è¦æ±‚å¾ˆé«˜ï¼Œæˆ–è€…æƒ³è¦é¿å…å…¨å±€æ±¡æŸ“**ï¼Œæ¨èä½¿ç”¨ @babel/plugin-transform-runtime + @babel/runtimeã€‚

- å¦‚æœæƒ³è¦**å¿«é€Ÿæ–¹ä¾¿åœ°å¯ç”¨æ‰€æœ‰å¯èƒ½éœ€è¦çš„ polyfillsï¼Œå¹¶ä¸”ä¸éœ€è¦æ‹…å¿ƒæ‰“åŒ…ä½“ç§¯**ï¼Œå¯ä»¥ä½¿ç”¨ useBuiltIns + @babel/polyfillã€‚

  

## 5ã€æ’ä»¶ï¼ˆPluginï¼‰

`babel`é»˜è®¤ä¸å†…ç½®ä»£ç è½¬æ¢åŠŸèƒ½ï¼Œä»£ç è½¬æ¢å…¨ä¾èµ–`babel`æ’ä»¶ï¼ˆè½¬åŒ–ç±»ï¼‰å®ç°ï¼Œæ‰€ä»¥æ’ä»¶å¯¹äº`babel`éå¸¸é‡è¦ã€‚ æˆ‘ä»¬ä¸€èˆ¬ä¸ä¼šè‡ªå·±å¼€å‘`babel`è½¬æ¢ç±»æ’ä»¶ï¼Œå®é™…é¡¹ç›®ä¸­å¾€å¾€éƒ½æ˜¯ç›´æ¥ä½¿ç”¨ç°æˆæ’ä»¶ï¼ˆå®˜æ–¹æˆ–ç¬¬ä¸‰æ–¹ï¼‰ã€‚ä»[å®˜ç½‘æ’ä»¶åˆ—è¡¨](https://link.juejin.cn?target=https%3A%2F%2Fbabeljs.io%2Fdocs%2Fen%2Fplugins-list)ä¸­ï¼Œæˆ‘ä»¬å‘ç°æ’ä»¶æ˜¯éå¸¸ä¸°å¯Œçš„

PSï¼šä¸‹é¢æ‰€è®²çš„ ***æ’ä»¶*** éƒ½æ˜¯æŒ‡ ***è½¬æ¢ç±»æ’ä»¶***

### 5.1ã€å®‰è£…ä¸ä½¿ç”¨

å®‰è£…å¾ˆç®€å•ï¼Œåœ¨å®˜æ–¹æ’ä»¶åˆ—è¡¨ä¸­æ‰¾åˆ°éœ€è¦çš„æ’ä»¶ï¼Œä½¿ç”¨ä¸‹é¢å‘½ä»¤å°±å¯ä»¥äº†

```java
// éœ€è¦æŠŠç®­å¤´å‡½æ•°è½¬è¯‘æˆES5çš„æ™®é€šå‡½æ•°ï¼Œéœ€è¦å®‰è£…
npm i @babel/plugin-transform-arrow-functions --save-dev

// éœ€è¦æŠŠES6çš„å‡½æ•°å‚æ•°è½¬è¯‘æˆES5çš„å‡½æ•°å‚æ•°ï¼Œéœ€è¦å®‰è£…
npm i @babel/plugin-transform-parameters -D
```

å®‰è£…å®Œï¼Œé©¬ä¸Šä½¿ç”¨ï¼Œä½¿ç”¨æœ‰2é’Ÿæ–¹å¼

**1ã€å‘½ä»¤æ–¹å¼** 
 **2ã€é…ç½®æ–¹å¼**ï¼ˆæ¨èï¼‰

```java
/* å‘½ä»¤æ–¹å¼ */
npx babel src -d lib --plugins=@babel/plugin-transform-arrow-functions

// ä¸¤ä¸ªä»¥ä¸Šæ’ä»¶ä¸€èµ·ç”¨çš„è¯ï¼Œç”¨","éš”å¼€
npx babel src -d lib --plugins=@babel/plugin-transform-arrow-functions,
@babel/plugin-transform-parameters

/* é…ç½®æ–¹å¼ */

// åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹ï¼Œæ–°å»ºbabel.config.jsoné…ç½®æ–‡ä»¶
{
    "plugins": [
        "@babel/plugin-transform-arrow-functions",
        "@babel/plugin-transform-parameters"
    ]
}
```

### 5.2ã€çœç•¥å‰ç¼€å†™æ³•

æ¯ä¸ªæ’ä»¶éƒ½æ˜¯ä»¥`plugin-`ä½œä¸ºå‰ç¼€ï¼Œæ¯æ¬¡ä½¿ç”¨æ’ä»¶æ—¶ï¼Œéƒ½è¦é‡å¤ç¼–å†™æŒºéº»çƒ¦çš„ï¼Œæ‰€ä»¥`babel`å®˜æ–¹æä¾›äº†**çœç•¥`plugin-`å‰ç¼€**çš„ç®€æ˜“å†™æ³•

ä¸Šé¢2é’Ÿæ–¹å¼çš„çœç•¥å†™æ³•å¦‚ä¸‹ï¼š

```java
/* å‘½ä»¤æ–¹å¼ */
npx babel src -d lib --plugins=@babel/transform-arrow-functions

// ä¸¤ä¸ªä»¥ä¸Šæ’ä»¶ä¸€èµ·ç”¨çš„è¯ï¼Œç”¨","éš”å¼€
npx babel src -d lib --plugins=@babel/transform-arrow-functions,@babel/transform-parameters

/* é…ç½®æ–¹å¼ */

// åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹ï¼Œæ–°å»ºbabel.config.jsoné…ç½®æ–‡ä»¶
{
    "plugins": [
        "@babel/transform-arrow-functions",
        "@babel/transform-parameters"
    ]
}
```

### 5.3ã€æ‰§è¡Œé¡ºåº

å½“é…ç½®å¤šä¸ªæ’ä»¶æ—¶ï¼ˆå‘½ä»¤æ–¹å¼ä¸€æ ·ï¼‰ï¼ŒæŒ‰ä¹¦å†™ä»å‰åˆ°åçš„é¡ºåºæ‰§è¡Œï¼Œä¾‹å¦‚ï¼š

```perl
// babel.config.jsoné…ç½®æ–‡ä»¶
{
    "plugins": [
        "@babel/transform-arrow-functions",
        "@babel/transform-parameters"
    ]
}
```

æ‰§è¡Œé¡ºåºä¸ºï¼šå…ˆæ‰§è¡Œ`@babel/transform-arrow-functions`ï¼Œç„¶åæ‰§è¡Œ`@babel/transform-parameters`

### 5.4ã€é…ç½®é€‰é¡¹

åœ¨`Babel`é…ç½®æ–‡ä»¶ä¸­ï¼Œé™¤äº†å£°æ˜æ‰€ç”¨åˆ°çš„`Babel`æ’ä»¶å¤–ï¼Œè¿˜å¯ä»¥å¯¹ç”¨åˆ°çš„`Babel`æ’ä»¶è¿›è¡Œé…ç½®ï¼ˆå‰ææ¡ä»¶æ˜¯è¯¥æ’ä»¶æä¾›å¯é…ç½®é¡¹å•¦ï¼Œå¦åˆ™é…ç½®ä¸ªå¯‚å¯ï¼Ÿï¼‰ï¼Œå†™æ³•å¦‚ä¸‹ï¼š

```json
// åœ¨babel.config.jsonä¸­
{
    "plugins": [ 
        [ 
            "transform-async-to-module-method", 
            { 
                "module": "bluebird", 
                "method": "coroutine" 
            }
        ] 
    ]
}
```

### 5.5ã€é—®é¢˜

æˆ‘ä»¬å·²ç»å­¦ä¼šå®‰è£…ä½¿ç”¨æ’ä»¶ï¼Œ`babel`å¯¹`ES6+`è¯­æ³•è½¬æ¢ï¼Œéƒ½æ˜¯é ä¸€ä¸ªä¸ªpluginså®Œæˆçš„ã€‚å†çœ‹ä¸€çœ¼æ’ä»¶åˆ—è¡¨ï¼Œ~ ~çªç„¶æ‡µé€¼äº†ï¼Œ**è¿™ä¹ˆå¤šæ’ä»¶éš¾é“è¦æˆ‘ä¸€ä¸ªä¸€ä¸ªå®‰è£…ä½¿ç”¨å—ï¼Ÿ**

ç­”æ¡ˆï¼šå½“ç„¶ä¸ä¼šå•¦ï¼Œå¦‚æœè¦ä¸€ä¸ªä¸ªå®‰è£…ä½¿ç”¨ï¼Œä¼°è®¡æ²¡äººä¼šä½¿ç”¨`babel`æ¥ä»£ç è½¬æ¢ï¼Œ`babel`å®˜æ–¹ç»™å‡ºäº†ä¸€ä¸ªè§£å†³æ–¹æ¡ˆ â€”â€” é¢„è®¾ï¼ˆ`preset`ï¼‰ï¼Œåé¢ä¼šè®²è§£

### 5.6ã€æ³¨æ„äº‹é¡¹

**è½¬æ¢ç±»æ’ä»¶** æŒ‰ *åŠŸèƒ½* è¿›è¡Œåˆ†ç±»ï¼Œå¤§æ¦‚åˆ†ä¸ºä¸‰ç±»ï¼š

**1ã€ES6+è¯­æ³•è½¬æ¢æ’ä»¶** 

è¿™ç§æ’ä»¶æ˜¯æœ€å¸¸ç”¨çš„ 
 **ä¸»è¦å¯¹ES6+æœ€æ–°çš„è¯­æ³•ç³–è¿›è¡Œè½¬æ¢ï¼Œå¹¶ä¸è´Ÿè´£è½¬æ¢ES6+æ–°å¢çš„apiå’Œå…¨å±€å¯¹è±¡ã€‚** ä¾‹å¦‚ï¼š`let/const`å°±å¯ä»¥è¢«è½¬æ¢ï¼Œè€Œ`includes/Object.assign`ç­‰æ–°APIå¹¶ä¸èƒ½è¢«è½¬æ¢ï¼Œå¸¸ç”¨çš„ES6+è¯­æ³•è½¬æ¢æ’ä»¶æœ‰ï¼š`@babel/plugin-transform-arrow-functions`ã€`@babel/plugin-transform-parameters`ç­‰

**2ã€è¡¥å……è½¬æ¢æ’ä»¶** 

å¯¹ä¸Šé¢ES6+è¯­æ³•è½¬æ¢æ’ä»¶çš„ä¸€ç§è¡¥å……ï¼Œè§£å†³å®ƒä¸èƒ½è§£å†³çš„é—®é¢˜ 
 **ä¸»è¦å¯¹ES6+æ–°å¢çš„apiå’Œå…¨å±€å¯¹è±¡è¿›è¡Œè½¬æ¢** ä¾‹å¦‚ï¼š`babel-plugin-transform-runtime`è¿™ä¸ªæ’ä»¶èƒ½å¤Ÿè½¬æ¢`Object.assign`ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥å¼•å…¥`@babel/polyfill`ï¼Œè¿›ä¸€æ­¥å¯¹`includes`è¿™ç±»æ–°APIä¿è¯åœ¨æµè§ˆå™¨çš„å…¼å®¹æ€§ã€‚

> ä¸€èˆ¬é¡¹ç›®ä½¿ç”¨ `@babel/polyfill` è¡¥å……åŒ…ï¼Œè€Œ å·¥å…·/åº“ æ‰ä½¿ç”¨ `babel-plugin-transform-runtime` æ’ä»¶

**3ã€å…¶ä»–è½¬æ¢æ’ä»¶**

TSã€Flowã€React(JSX)è½¬æ¢æ’ä»¶ï¼Œè½¬è¯‘`JSXè¯­æ³•`å’Œ`TSè¯­æ³•`ï¼Œç§»é™¤ç±»å‹å£°æ˜



## 6ã€é¢„è®¾ï¼ˆPresetï¼‰

`bel`æ’ä»¶å°½å¯èƒ½æ‹†æˆå°çš„ç²’åº¦ï¼Œå¼€å‘è€…å¯ä»¥æŒ‰éœ€å¼•å…¥ã€‚æ¯”å¦‚å¯¹ES6è½¬ES5çš„åŠŸèƒ½ï¼ŒBabelå®˜æ–¹æ‹†æˆäº†20+ä¸ªæ’ä»¶ã€‚ä½†åœ¨å®é™…å¼€å‘ä¸­ï¼Œé€ä¸ªæ’ä»¶å¼•å…¥ä¸ä»…æ•ˆç‡ä½ä¸‹ï¼Œè€Œä¸”å¾ˆå®¹æ˜“å‡ºé”™ã€‚ä¸ºæ­¤ï¼Œ`Babel`å®˜æ–¹æä¾›äº†ä¸€ä¸ª`Babel`æ’ä»¶é›†åˆ â€”â€” é¢„è®¾ï¼ˆPresetï¼‰ï¼Œåªè¦å®‰è£…å¯¼å…¥ä¸€ä¸ªé¢„è®¾ï¼Œå°±ç›¸å½“äºæŠŠå¤šä¸ª`Babel`æ’ä»¶å®‰è£…å¯¼å…¥äº†

### 6.1ã€å®‰è£…ä¸ä½¿ç”¨

å®‰è£…å¾ˆç®€å•ï¼Œåœ¨å®˜æ–¹æ‰¾åˆ°éœ€è¦çš„é¢„è®¾ï¼Œä½¿ç”¨ä¸‹é¢å‘½ä»¤å®‰è£…

```css
// å®‰è£…æŠŠES6+è¯­æ³•è½¬æˆES5çš„é¢„è®¾
npm i @babel/preset-env -D
```

> å·²è¢«çº³å…¥è§„èŒƒçš„è¯­æ³•ï¼ˆES2015, ES2016, ...., ES2021, Modulesï¼‰æ‰€éœ€è¦ä½¿ç”¨çš„`plugins`éƒ½åŒ…å«åœ¨`@babel/preset-env`ä¸­

å®‰è£…å®Œï¼Œé©¬ä¸Šä½¿ç”¨ï¼Œä½¿ç”¨æœ‰2é’Ÿæ–¹å¼

**1ã€å‘½ä»¤æ–¹å¼** 
 **2ã€é…ç½®æ–¹å¼**ï¼ˆæ¨èï¼‰

```css
/* å‘½ä»¤æ–¹å¼ */
npx babel src -d lib --presets=@babel/preset-env

// ä½¿ç”¨ä¸¤ä¸ªä»¥ä¸Šé¢„è®¾çš„è¯ï¼Œç”¨","éš”å¼€
npx babel src -d lib --presets=@babel/preset-envï¼Œ@babel/preset-typescript

/* é…ç½®æ–¹å¼ */

// åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹ï¼Œæ–°å»ºbabel.config.jsoné…ç½®æ–‡ä»¶
{
    "presets": [
       [ 
       "@babel/preset-env", 
           { 
               targets: { 
                   edge: "17", 
                   chrome: "64",
                   firefox: "60", 
                   safari: "11.1",
                   ie: "10"
               } 
           } 
        ]
    ]
}
```

### 6.2ã€çœç•¥å‰ç¼€å†™æ³•

æ¯ä¸ªé¢„è®¾éƒ½æ˜¯ä»¥`preset-`ä½œä¸ºå‰ç¼€ï¼Œæ¯æ¬¡ä½¿ç”¨é¢„è®¾æ—¶ï¼Œéƒ½è¦é‡å¤ç¼–å†™æŒºéº»çƒ¦çš„ï¼Œæ‰€ä»¥`babel`å®˜æ–¹æä¾›äº†**çœç•¥`preset-`å‰ç¼€**çš„ç®€æ˜“å†™æ³•

ä¸Šé¢2é’Ÿæ–¹å¼çš„çœç•¥å†™æ³•å¦‚ä¸‹ï¼š

```css
/* å‘½ä»¤æ–¹å¼ */
npx babel src -d lib --presets=@babel/env

// ä¸¤ä¸ªä»¥ä¸Šé¢„è®¾ä¸€èµ·ç”¨çš„è¯ï¼Œç”¨","éš”å¼€
npx babel src -d lib --presets=@babel/envï¼Œ@babel/typescript

/* é…ç½®æ–¹å¼ */

// åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹ï¼Œæ–°å»ºbabel.config.jsoné…ç½®æ–‡ä»¶
{
    "presets": [
       [ 
       "@babel/env", 
           { 
               targets: { 
                   edge: "17", 
                   chrome: "64",
                   firefox: "60", 
                   safari: "11.1",
                   ie: "10"
               } 
           } 
        ]
    ]
}
```

### 6.3ã€é…ç½®é€‰é¡¹

åœ¨`Babel`é…ç½®æ–‡ä»¶ä¸­ï¼Œé™¤äº†å£°æ˜æ‰€ç”¨åˆ°çš„`Babel`é¢„è®¾å¤–ï¼Œè¿˜å¯ä»¥å¯¹ç”¨åˆ°çš„`Babel`é¢„è®¾è¿›è¡Œé…ç½®ï¼ˆå‰ææ¡ä»¶æ˜¯è¯¥é¢„è®¾æä¾›å¯é…ç½®é¡¹å•¦ï¼Œå¦åˆ™é…ç½®ä¸ªå¯‚å¯ï¼Ÿï¼‰ï¼Œå†™æ³•ä¸æ’ä»¶çš„é…ç½®é€‰é¡¹ä¸€æ ·ï¼

- **targets**

ç”¨äºæŒ‡å®šç¼–è¯‘åèƒ½è¿è¡Œåœ¨çš„ç›®æ ‡æµè§ˆå™¨ï¼ˆæœ€ä½ç‰ˆæœ¬ï¼‰ï¼Œä»¥ä¾¿å¯ä»¥æŒ‰éœ€å¼•å…¥ `plugin` å’Œ `ployfill`

```css
{
    "presets": [
       [ 
       "@babel/env", 
           { 
               targets: { 
                   edge: "17", 
                   chrome: "64",
                   firefox: "60", 
                   safari: "11.1",
                   ie: "10"
               } 
           } 
        ]
    ]
}
```

> targets å’Œ browerslist åˆå¹¶å–æœ€ä½ç‰ˆæœ¬

- **modules**

ç”¨äºæŒ‡å®šä»£ç è½¬æ¢åçš„æ¨¡å—åŒ–ç±»å‹ï¼ˆESæ¨¡å—åŒ–è½¬æˆä»€ä¹ˆç±»å‹ï¼‰ï¼Œé»˜è®¤å€¼æ˜¯`auto`ï¼Œæœ€ç»ˆè½¬æˆCommonJSæ¨¡å—åŒ–

å¦‚æœæƒ³è½¬æˆï¼ˆä¿ç•™ï¼‰ESæ¨¡å—åŒ–ï¼Œå¯è®¾ç½®ä¸º`false`

- **useBuiltIns**

ç”¨äºæŒ‡å®šåŠ è½½`ployfill`çš„æ–¹å¼ï¼Œé»˜è®¤æ˜¯`false`

å¯é€‰å€¼æœ‰3ç§ï¼š`"usage"` | `"entry"` | `false`

1ã€`"entry"`ï¼šå»æ‰ç›®æ ‡æµè§ˆå™¨å·²æ”¯æŒçš„`ployfill`æ¨¡å—ï¼Œå°†æµè§ˆå™¨ä¸æ”¯æŒçš„éƒ½å¼•å…¥å¯¹åº”çš„`ployfill`æ¨¡å—ã€‚
 2ã€`"usage"`ï¼šæ‰“åŒ…æ—¶ä¼šè‡ªåŠ¨æ ¹æ®å®é™…ä»£ç çš„ä½¿ç”¨æƒ…å†µï¼Œç»“åˆ`targets`æŒ‰éœ€å¼•å…¥ä»£ç é‡Œå®é™…ç”¨åˆ°éƒ¨åˆ†`polyfill`æ¨¡å—ã€‚
 3ã€`false`ï¼šä¸åŠ è½½ä»»ä½•`ployfill`

æ¨èä½¿ç”¨`"usage"`

```arduino
arduino ä½“éªŒAIä»£ç åŠ©æ‰‹ ä»£ç è§£è¯»å¤åˆ¶ä»£ç // ä½¿ç”¨entryæ—¶ï¼Œåœ¨å…¥å£main.jsä¸­å¼•å…¥

ï¼ˆbabel v7.0ç‰ˆä¹‹å‰ï¼Œæ¨èä½¿ç”¨ï¼‰ 
//import '@babel/polyfill'; 

ï¼ˆbabel v7.4ç‰ˆä¹‹å‰ï¼Œæ¨èä½¿ç”¨ï¼‰ 
import "core-js/stable"; 
import "regenerator-runtime/runtime";

ï¼ˆbabel v7.4ç‰ˆä¹‹åï¼Œæ¨èä½¿ç”¨ï¼‰ 
import "core-js";
```

### 6.4ã€æ‰§è¡Œé¡ºåº

å’Œæ’ä»¶æ‰§è¡Œé¡ºåºåˆšå¥½ç›¸åï¼Œå¤šä¸ª`Preset`æŒ‰ç…§å£°æ˜æ¬¡åºé€†åºæ‰§è¡Œã€‚

ä¾‹å¦‚ï¼šéœ€è¦å°†reactä¸­çš„jsxè½¬ä¸ºjsï¼Œç„¶åå°†jsåœ¨è½¬æ¢ä¸ºes5ï¼Œæ‰€ä»¥éœ€è¦å°†reactçš„æ’ä»¶æ”¾åœ¨åé¢ï¼Œè®©ä»–å…ˆæ‰§è¡Œã€‚

```perl
// åœ¨babel.config.jsonä¸­é…ç½®
{
    presets: ["@babel/env", "@babel/react"]
}
```

> *å¦‚æœæ—¢æœ‰`Babel`æ’ä»¶ï¼Œåˆæœ‰`Babel`é¢„è®¾ï¼Œé‚£ä¹ˆæ‰§è¡Œé¡ºåºå¦‚ä½•å‘¢ï¼Ÿ* 
>
> **ç­”æ¡ˆï¼š** **æ’ä»¶** çš„ä¼˜å…ˆçº§é«˜äº **é¢„è®¾**ï¼Œå…ˆæ‰§è¡Œæ’ä»¶ï¼ˆæŒ‰ç…§å£°æ˜çš„æ’ä»¶é¡ºåºæ‰§è¡Œï¼‰ï¼Œå†æ‰§è¡Œé¢„è®¾ï¼ˆæŒ‰ç…§å£°æ˜çš„é¢„è®¾é€†åºæ‰§è¡Œï¼‰

### 6.5ã€æŒ‰éœ€åŠ è½½æ’ä»¶

`@babel/preset-env`åŒ…å« `ES2015`ã€`ES2016`ã€....... ç­‰æœ€æ–°ES6+ç‰¹æ€§è½¬æ¢æ’ä»¶ï¼Œä½†ç°åœ¨å¾ˆå¤šæœ€æ–°æµè§ˆå™¨ä¹Ÿæ”¯æŒES6+éƒ¨åˆ†æ–°ç‰¹æ€§ï¼Œå¦‚æœä½ çš„ä»£ç åªéœ€è¿è¡Œåœ¨è¿™äº›é«˜çº§ï¼ˆæ–°ï¼‰æµè§ˆå™¨ä¸Šï¼Œé‚£å·²æ”¯æŒçš„ES6+æ–°ç‰¹æ€§å°±æ— éœ€å¯¹åº”çš„`Babel`æ’ä»¶è½¬æ¢ï¼Œ**å¤§å¤§æé«˜ä»£ç è½¬è¯‘æ€§èƒ½**

`@babel/preset-env`å·²æ”¯æŒæŒ‰éœ€åŠ è½½åŠŸèƒ½ï¼Œåªè¦æˆ‘ä»¬æŒ‡å®šç›®æ ‡æµè§ˆå™¨åŠå…¶ç‰ˆæœ¬ï¼Œ`@babel/preset-env`å°±ä¼šæ ¹æ®ç›®æ ‡æµè§ˆå™¨çš„ç‰¹æ€§ï¼ˆæœªæ”¯æŒES6+ç‰¹æ€§ï¼‰åŠ è½½å¯¹åº”`Babel`æ’ä»¶è¿›è¡Œä»£ç è½¬æ¢

> ç›®æ ‡æµè§ˆå™¨æŒ‡å®šæœ‰2ç§æ–¹å¼: 
>  1ã€åœ¨`Babel`é…ç½®æ–‡ä»¶ä¸­é€šè¿‡targetså±æ€§æŒ‡å®š 
>  2ã€ä½¿ç”¨`.browserslistrc`æ–‡ä»¶æ¥æŒ‡å®š ï¼ˆæ¨èï¼‰
>
> PSï¼šæŒ‡å®šç›®æ ‡æµè§ˆå™¨ï¼Œé™¤äº†ç”¨äº`@babel/preset-env`æŒ‰éœ€åŠ è½½å¯¹åº”è½¬æ¢æ’ä»¶å¤–ï¼Œè¿˜ç”¨äº`autoprefixer`æ ¹æ®ç›®æ ‡æµè§ˆå™¨æ·»åŠ çš„ CSS æµè§ˆå™¨å‰ç¼€ï¼ˆ**CSS3å…¼å®¹å¤„ç†**ï¼‰

[æŸ¥çœ‹ browserslist çš„æ›´å¤šé…ç½®](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbrowserslist%2Fbrowserslist)

```arduino
arduino ä½“éªŒAIä»£ç åŠ©æ‰‹ ä»£ç è§£è¯»å¤åˆ¶ä»£ç // .browserslistrc é…ç½®æ¡ˆä¾‹
ie >= 8
Firefox >= 3.5
chrome  >= 35
opera >= 11.5
```

### 6.6ã€æ³¨æ„äº‹é¡¹

1ã€`@babel/preset-env`**å®Œå…¨æ›¿ä»£**`babel-preset-es2015/es2016/es2017/......`ï¼ˆä»¥å‰ä½¿ç”¨çš„ES6+è½¬æ¢æ’ä»¶ï¼‰ï¼Œè¯´ç™½äº†å°±æ˜¯æŠŠ`babel-preset-es2015/es2016/es2017/......`åºŸå¼ƒæ‰ã€‚å¦å¤–`@babel/preset-env`é»˜è®¤ä¸æ”¯æŒ`stage-x`é¢„è®¾ï¼ˆå·²åºŸå¼ƒï¼‰

2ã€ä»`Babel7`å¼€å§‹ï¼Œå®˜æ–¹å°±æŠŠ`stage-x`(é¢„è®¾`babel-preset-stage-0/1/2/3/4`)åºŸå¼ƒæ‰ï¼Œ[è¯·çœ‹](https://link.juejin.cn?target=https%3A%2F%2Fwww.babeljs.cn%2Fblog%2F2018%2F07%2F27%2Fremoving-babels-stage-presets)

3ã€é¢„è®¾åªæ˜¯æ’ä»¶çš„ä¸€ä¸ªé›†åˆï¼Œé»˜è®¤`@babel/preset-env`åªä¼šå¯¹ES6+æ–°è¯­æ³•è¿›è¡Œè½¬æ¢ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬çœ‹åˆ°çš„ç®­å¤´å‡½æ•°ã€const/letè¿™ç±»ã€‚å¦‚æœè¿›ä¸€æ­¥éœ€è¦è½¬æ¢å†…ç½®å¯¹è±¡ã€å®ä¾‹æ–¹æ³•ï¼ˆapiï¼‰ï¼Œé‚£å°±éœ€è¦æ¥ä¸‹æ¥ä»‹ç»çš„`polyfill`è¡¥å……ã€‚

*PS*ï¼šä¸ºä½•å¼€å¤´æ˜¯è¯´ â€œ**é»˜è®¤**â€ ä¸¤å­—å‘¢ï¼Ÿå› ä¸º`polyfill`ä¸`@babel/preset-env`æœ‰å…³è”çš„ï¼Œæ‰€ä»¥åªè¦åœ¨`@babel/preset-env`å†…é…ç½®`useBuiltIns`é€‰é¡¹å°±å¯ä»¥å¯ç”¨`polyfill`ï¼Œé»˜è®¤æ˜¯ç¦ç”¨`polyfill`ï¼Œè¯¦ç»†çš„å†…å®¹ä¸‹é¢ä¼šè®²



## 7ã€è¡¥å……ï¼ˆpolyfillï¼‰

> å®˜æ–¹çš„'polypill'æ˜¯`@babel/polyfill`ï¼Œ**Babel 7.4.0 å¼€å§‹**ï¼Œ`@babel/polyfill`è¿™ä¸ªåŒ…å·²ç»åºŸå¼ƒ

ä¸Šæ–‡ä¹Ÿæåˆ°äº†ï¼Œæ¯”å¦‚åƒ`Promise`ã€`Generator`ã€`Symbol`è¿™ç§æ–°å†…ç½®å¯¹è±¡ã€æ•°ç»„`includes()`æ–°APIï¼Œå’±ä»¬çš„ **babel** å¹¶æ²¡æœ‰ç»™è½¬è¯‘ï¼Œé‚£æ˜¯å› ä¸º **babelæ’ä»¶** é»˜è®¤æ˜¯åªä¼šå»è½¬è¯‘`ES6+`è¯­æ³•çš„ã€‚è¿™ä¸ªæ—¶å€™å°±è¦å‡ºåŠ¨`@babel/polyfill`è¡¥å……åŒ…æ¥æ¨¡æ‹Ÿ`ES6+`ç¯å¢ƒ:

### 7.1ã€å®‰è£…ä¸ä½¿ç”¨

å®‰è£…å‘½ä»¤å¦‚ä¸‹ï¼š

```css
npm i @babel/polyfill -S   // è¦ç”Ÿäº§å®‰è£… -S
```

> ä¸ºä½•è¦ç”¨`-S`è€Œä¸æ˜¯`-D`å®‰è£… ï¼Ÿ çœ‹ä¸‹ä½¿ç”¨`polyfill`è½¬æ¢åçš„ä»£ç ï¼Œä½ å°±èƒ½æ˜ç™½åŸå› äº†

```scss
// åŸæ¥çš„ä»£ç  
var hasTwo = [1, 2, 3].includes(2); 

// è½¬åçš„ä»£ç  
require("core-js/modules/es7.array.includes"); 
require("core-js/modules/es6.string.includes"); 
var hasTwo = [1, 2, 3].includes(2);
```

ä½¿ç”¨éå¸¸ç®€å•ï¼Œåªè¦ç»™`@babel/preset-env`é…ç½®ä¸€ä¸ª`useBuiltIns`é€‰é¡¹å°±å¯ä»¥äº†ï¼Œå…¶ä¸­`useBuiltIns`é€‰é¡¹å¯é€‰å€¼æœ‰3ç§ï¼š`"usage"`ã€`"entry"` ã€ `false`ï¼Œé»˜è®¤æ˜¯`false`

ä¸€èˆ¬æˆ‘ä»¬æŠŠ`useBuiltIns`è®¾ä¸º`"usage"`ï¼Œé‚£ä¹ˆ`babel`è½¬æ¢ä»£ç æ—¶ï¼Œå°±ä¼šæ ¹æ®ä»¥ä¸‹2ä¸ªæ¡ä»¶è¿›è¡Œ **æŒ‰éœ€å¯¼å…¥** è¡¥å……

1. ç›®æ ‡æµè§ˆå™¨ 
2. ä»£ç ï¼ˆå«ES6+çš„æ–°APIå’Œå†…ç½®æ–°å¯¹è±¡ç­‰ï¼‰

```css
// babel.config.jsoné…ç½®
{
    "presets": [
       [ 
       "@babel/env", 
           { 
               targets: { 
                   edge: "17", 
                   chrome: "64",
                   firefox: "60", 
                   safari: "11.1",
                   ie: "10"
               },
               useBuiltIns: "usage"
           } 
        ]
    ]
}
```

### 7.2ã€å·²åºŸå¼ƒ

ç”±äº **Babel 7.4.0 å¼€å§‹** ï¼Œ`@babel/polyfill`è¿™ä¸ªåŒ…å·²ç»åºŸå¼ƒï¼Œé€šè¿‡ core-js æ›¿ä»£ã€‚ä¸Šé¢ä»‹ç»çš„å†…å®¹ä»…é€‚åˆ **Babel 7.4.0 ä¹‹å‰ç‰ˆæœ¬**ï¼Œä½†å³ä½¿æ˜¯`7.4.0`ä¹‹å‰çš„ç‰ˆæœ¬ï¼Œä¹Ÿå»ºè®®ä½ ä¸è¦ç”¨`@babel/polyfill`ï¼Œå› ä¸º`@babel/polyfill`ä¸€å¹´æ²¡æ›´æ–°äº†ï¼Œä½†ES6+æ–°è¯­æ³•æ¯å¹´éƒ½åœ¨æ–°å¢ï¼Œæ¢å¥è¯è¯´ï¼Œå°±æ˜¯ä»Šå¹´æœ€æ–°çš„JSè¯­æ³•`@babel/polyfill`å·²ä¸æ”¯æŒäº†

#### å‰ç½®çŸ¥è¯†

`@babel/polyfill`æ˜¯ç”±`core-js2`å’Œ`regenerator-runtime`ç»„æˆçš„ä¸€ä¸ªé›†æˆåŒ… 
 (å³`@babel/polyfill` = `core-js@2` + `regenerator-runtime`)

> regenerator-runtimeï¼šç”¨äºå¯¹`generator`ã€`async`æ–°ç‰¹æ€§æä¾›è¡¥å…… ï¼ˆes6 å¼‚æ­¥å…³é”®è¯çš„å®ç°ï¼‰
>  core-jsï¼šç”¨äºå¯¹`ES6+`æ–°ç‰¹æ€§ï¼ˆä¾‹å¦‚ï¼š`includes()`ã€`Array.from`ç­‰ï¼‰æä¾›è¡¥å……ï¼ˆes6 çš„å¯¹è±¡å’Œæ–¹æ³•å®ç°ï¼‰

#### è§£å†³æ–¹æ¡ˆ

**å®˜æ–¹æ¨èå•ç‹¬ä½¿ç”¨`core-js`å’Œ`regenerator-runtime`åŒ…ï¼Œç„¶åè®¾ç½®`@babel/preset-env`çš„`corejs`é€‰é¡¹ä¸º`3`**

> å¦‚æœä½ å®‰è£…äº†`@babel/polyfill`åŒ…ï¼Œä½ å¯ä»¥å…ˆå¸è½½ï¼š`npm uninstall @babel/polyfill`

å®‰è£…`core-js`å’Œ`regenerator-runtime`è¡¥å……åŒ…ï¼Œå½“å‰æœ€æ–°ç‰ˆæœ¬æ˜¯**3.17.3**

```css
npm i core-js regenerator-runtime --save  // è®°ä½å¿…é¡»ç”¨ --save å®‰è£…
```

è€Œ`regenerator-runtime`åŒ…å¯ä»¥ä¸æŒ‰è£…ï¼Œå› ä¸º`@babel/preset-env`å·²ç»å†…ç½®äº†ï¼Œæ‰‹åŠ¨å®‰è£…åªæ˜¯æ›´æ–°ä¸‹åŒ…ç‰ˆæœ¬ï¼Œä¸‡äº‹ä¿±å¤‡åªå‰©ä¸‹é…ç½®äº†

```css
// babel.config.jsoné…ç½®
{
    "presets": [
       [ 
           "@babel/env", 
           { 
               targets: { 
                   edge: "17", 
                   chrome: "64",
                   firefox: "60", 
                   safari: "11.1",
                   ie: "10"
               },
               useBuiltIns: "usage",
               corejs: 3
           } 
        ]
    ]
}
```

åˆ°æ­¤ï¼Œå°±å®Œç¾è§£å†³`@babel/polyfill`åºŸå¼ƒé—®é¢˜

#### ä¸ºä½•ä½¿ç”¨core-js@3ï¼Œè€Œä¸æ˜¯core-js@2 ?

> `@babel/polyfill`å†…ç½®`core-js`åŒ…ç‰ˆæœ¬é»˜è®¤æ˜¯ **2**

è¯´ä¸€ä¸‹ä½¿ç”¨ `core-js@3` çš„åŸå› ï¼Œ`core-js@2` åˆ†æ”¯ä¸­å·²ç»ä¸ä¼šå†æ·»åŠ æ–°ç‰¹æ€§ï¼Œæ–°ç‰¹æ€§éƒ½ä¼šæ·»åŠ åˆ° `core-js@3`ã€‚ä¾‹å¦‚ä½ ä½¿ç”¨äº† `Array.prototype.flat()`ï¼Œå¦‚æœä½ ä½¿ç”¨çš„æ˜¯ `core-js@2`ï¼Œé‚£ä¹ˆå…¶ä¸åŒ…å«æ­¤æ–°ç‰¹æ€§ã€‚ä¸ºäº†å¯ä»¥ä½¿ç”¨æ›´å¤šçš„æ–°ç‰¹æ€§ï¼Œå»ºè®®å¤§å®¶ä½¿ç”¨ `core-js@3`ã€‚

> ä¸ºä½•ä¸å†æ¨èä½¿ç”¨`@babel/polyfill`å‘¢ï¼Ÿ

1ã€`@babel/polyfill`å·²ç»ä¸€å¹´å¤šæ²¡æ›´æ–°äº†ï¼Œè€Œ`core-js@3`ä¸æ–­åœ¨æ›´æ–°ï¼Œ`core-js@3`å–ä»£äº†`@babel/polyfill`

2ã€å› ä¸º`@babel/polyfill`ä¸æ”¯æŒä»`core-js@2`å¹³æ»‘çš„è¿‡æ¸¡åˆ°`core-js@3`ã€‚æ‰€ä»¥`core-js`å®˜æ–¹ç°åœ¨æ¨èæˆ‘ä»¬ä½¿ç”¨`polyfill`çš„æ—¶å€™ç›´æ¥å¼•å…¥`core-js`å’Œ`regenerator-runtime/runtime`è¿™ä¸¤ä¸ªåŒ…å®Œå…¨å–ä»£ **@babel/polyfil** æ¥ä¸ºäº†é˜²æ­¢é‡å¤§æ›´æ”¹

### æ³¨æ„äº‹é¡¹

å¯¹äº**åº“/å·¥å…·**, å¦‚æœä¸éœ€è¦ç”¨åˆ°åƒ`Array.prototype.includes`è¿™æ ·çš„å®ä¾‹æ–¹æ³•, å¯ä»¥ä½¿ç”¨`transform runtime`æ’ä»¶, è€Œä¸æ˜¯ä½¿ç”¨æ±¡æŸ“å…¨å±€çš„`@babel/polyfill`

å¯¹äº**åº”ç”¨ç¨‹åº**, æˆ‘ä»¬å»ºè®®å®‰è£…ä½¿ç”¨`@babel/polyfill`ï¼ˆ**Babel 7.4.0+** ä¹‹åç‰ˆæœ¬ç”¨ä¸Šé¢çš„æ–¹å¼ï¼‰

## 8ã€å¼€å‘å·¥å…·åº“/ç»„ä»¶åº“

å¦‚æœéœ€è¦å¼€å‘å·¥å…·åº“æˆ–è€…ç»„ä»¶åº“ï¼Œå°±ä¸èƒ½ä½¿ç”¨`@babel/polyfill`ï¼Œå› ä¸º`@babel/polyfill`ä¼šå¯¼è‡´å…¨å±€æ±¡æŸ“ï¼Œ è¿™æ—¶éœ€è¦ç”¨åˆ°`@babel/runtime-corejs3`å’Œ`@babel/plugin-transform-runtime`ã€‚

åªéœ€è¦é…ç½® `@babel/plugin-transform-runtime` çš„å‚æ•° `corejs`ã€‚è¯¥å‚æ•°é»˜è®¤ä¸º `false`ï¼Œå¯ä»¥è®¾ç½®ä¸º 2 æˆ–è€… 3ï¼Œåˆ†åˆ«å¯¹åº” `@babel/runtime-corejs2` å’Œ `@babel/runtime-corejs3`ã€‚

**`corejs: 2`ä»…æ”¯æŒå…¨å±€å˜é‡ï¼ˆä¾‹å¦‚`Promise`ï¼‰å’Œé™æ€å±æ€§ï¼ˆä¾‹å¦‚`Array.from`ï¼‰ï¼Œ`corejs: 3`è¿˜æ”¯æŒå®ä¾‹å±æ€§ï¼ˆä¾‹å¦‚`[].includes`ï¼‰ã€‚**

### 8.1ã€@babel/runtime-corejs3

è¿™ä¸ªåŒ…ä¸»è¦æä¾›æ‰€æœ‰è¯­æ³•è½¬æ¢ä¼šç”¨åˆ°çš„è¾…åŠ©å‡½æ•°ï¼Œå®‰è£…å¦‚ä¸‹

```css
npm i --save @babel/runtime-corejs3
```

> ```
> @babel/runtime`æœ€å¤§çš„é—®é¢˜å°±æ˜¯æ— æ³•æ¨¡æ‹Ÿå®ä¾‹ä¸Šçš„æ–¹æ³•ï¼Œæ¯”å¦‚æ•°ç»„çš„`includes`æ–¹æ³•ï¼Œä½†ä½¿ç”¨æ–°å¢çš„`@babel/runtime-corejs3`ä¹‹åæ”¯æŒäº†ï¼Œæ‰€ä»¥ç›´æ¥å®‰è£…`@babel/runtime-corejs3`å–ä»£`@babel/runtime
> ```

è¿™æ ·å°±è§£å†³äº†ä»£ç å¤ç”¨å’Œæœ€ç»ˆæ–‡ä»¶ä½“ç§¯å¤§çš„é—®é¢˜ã€‚ä¸è¿‡ï¼Œè¿™ä¹ˆå¤šè¾…åŠ©å‡½æ•°è¦ä¸€ä¸ªä¸ªè®°ä½å¹¶æ‰‹åŠ¨å¼•å…¥ï¼Œå¹³å¸¸äººæ˜¯åšä¸åˆ°çš„ã€‚è¿™ä¸ªæ—¶å€™ï¼Œ`Babel`æ’ä»¶`@babel/plugin-transform-runtime`å°±æ¥å¸®æˆ‘ä»¬è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

### 8.2ã€@babel/plugin-transform-runtime

è¿™ä¸ªåŒ…ä¸»è¦è§£å†³2ä¸ªé—®é¢˜ 1ã€è¾…åŠ©å‡½æ•°æŒ‰éœ€å¼•å…¥é—®é¢˜ 2ã€è§£å†³å…¨å±€æ±¡æŸ“é—®é¢˜

å®‰è£…å¦‚ä¸‹ï¼š

```css
npm i @babel/plugin-transform-runtime -D
```

ä¼˜åŒ–é…ç½®å¦‚ä¸‹ï¼š

```css
// babel.config.jsoné…ç½®
{
    "presets": [
       [ 
           "@babel/env", 
           { 
               targets: { 
                   edge: "17", 
                   chrome: "64",
                   firefox: "60", 
                   safari: "11.1",
                   ie: "10"
               }
           } 
        ]
    ],
    "plugins": [
        ["@babel/plugin-transform-runtime", {
            "corejs": 3
        }]
    ]
}
```

PSï¼š 
 é»˜è®¤corejsä¸ºfalseï¼Œæ„æ€æ˜¯æŒ‰éœ€åŠ è½½`@babel/runtime`åŒ…ä¸­è¾…åŠ©å‡½æ•° 
 corejsä¸º2ï¼Œæ„æ€æ˜¯æŒ‰éœ€åŠ è½½`@babel/runtime-corejs2`åŒ…ä¸­è¾…åŠ©å‡½æ•° 
 corejsä¸º3ï¼Œæ„æ€æ˜¯æŒ‰éœ€åŠ è½½`@babel/runtime-corejs3`åŒ…ä¸­è¾…åŠ©å‡½æ•° 



# äº”ã€babelç‰ˆæœ¬

babel çš„ç¼–è¯‘æµç¨‹å’Œç›®çš„ä»æ²¡æœ‰å˜è¿‡ï¼Œä½†æ˜¯å®Œæˆè¿™ä¸ªç›®çš„çš„æ–¹å¼å´å˜åŒ–å¾ˆå¤§ï¼Œæˆ‘ä»¬æ¥å›é¡¾ä¸€ä¸‹ `babel 6`ï¼Œ`babel 7` éƒ½æ˜¯æ€ä¹ˆè®¾è®¡çš„ï¼Œ`babel 8` åˆä¼šæ€ä¹ˆåšï¼Œæˆ–è®¸èƒ½å¸®ä½ çœŸæ­£ç†è§£ babelã€‚

## 1ã€babel 6

es çš„æ ‡å‡†ä¸€å¹´ä¸€ä¸ªç‰ˆæœ¬ï¼Œä¹Ÿå°±æ„å‘³ç€ babel æ’ä»¶è¦å®æ—¶çš„å»è·Ÿè¿›ï¼Œä¸€å¹´å®ç°ä¸€ç³»åˆ—æ’ä»¶ã€‚

ECMAScriptï¼ˆç®€ç§° ESï¼‰æ˜¯ JavaScript çš„æ ‡å‡†åŒ–ç‰ˆæœ¬ï¼Œå®ƒçš„æ–°ç‰¹æ€§é€šå¸¸ä¼šç»è¿‡ä¸€ä¸ªç”± TC39ï¼ˆECMA æŠ€æœ¯å§”å‘˜ä¼šï¼‰ç®¡ç†çš„ææ¡ˆè¿‡ç¨‹ï¼Œåˆ†ä¸ºäº”ä¸ªé˜¶æ®µï¼Œåˆ†åˆ«æ˜¯ Stage 0 åˆ° Stage 4ã€‚è¿™äº›é˜¶æ®µä»£è¡¨äº†æ–°ç‰¹æ€§ä»æœ€åˆçš„æè®®åˆ°æœ€ç»ˆæˆä¸ºæ ‡å‡†çš„è¿‡ç¨‹ã€‚ å…·ä½“å„ä¸ªé˜¶æ®µçš„å«ä¹‰å¦‚ä¸‹ï¼š

1. Stage 0 - Strawmanï¼ˆè‰æ¡ˆï¼‰ï¼šæ­¤é˜¶æ®µæ˜¯ä¸ºäº†æå‡ºåˆæ­¥æƒ³æ³•è€Œè®¾ç«‹çš„ï¼Œé€šå¸¸ç”±ä¸ªäººæˆ–å°ç»„æå‡ºï¼Œè€Œä¸æ˜¯ç”± TC39 å§”å‘˜ä¼šæ‰¹å‡†çš„ææ¡ˆã€‚è¿™äº›ææ¡ˆå¯èƒ½åªæ˜¯ä¸€ä¸ªæƒ³æ³•çš„è‰å›¾ï¼Œå¹¶ä¸å…·æœ‰å®é™…åº”ç”¨æ€§ã€‚
2. Stage 1 - Proposalï¼ˆææ¡ˆï¼‰ï¼šåœ¨è¿™ä¸ªé˜¶æ®µï¼Œææ¡ˆå·²ç»è¯¦ç»†è¯´æ˜äº†è®¾è®¡ã€è¯­æ³•å’Œè¯­ä¹‰ï¼Œå¹¶ä¸”ç»è¿‡äº†åˆæ­¥è®¨è®ºã€‚è¯¥é˜¶æ®µè¦æ±‚æä¾›è¯¦ç»†çš„è¯´æ˜æ–‡æ¡£ï¼Œä»¥åŠå®ç°å’Œç”¨æˆ·åé¦ˆç­‰ã€‚
3. Stage 2 - Draftï¼ˆè‰æ¡ˆï¼‰ï¼šåœ¨è¿™ä¸ªé˜¶æ®µï¼Œææ¡ˆå·²ç»å®Œæ•´åœ°æè¿°äº†å…¶è¯­æ³•å’Œè¯­ä¹‰ï¼Œå¹¶ä¸”æœ‰äº†åˆæ­¥çš„å®ç°ã€‚è¿™æ„å‘³ç€ææ¡ˆå·²ç»æˆä¸ºä¸€ä¸ªå¯ä¾›å®é™…ä½¿ç”¨çš„è‰æ¡ˆã€‚
4. Stage 3 - Candidateï¼ˆå€™é€‰ï¼‰ï¼šåœ¨è¿™ä¸ªé˜¶æ®µï¼Œææ¡ˆå·²ç»åŸºæœ¬å®Œæˆï¼Œæ‰€æœ‰æ–¹é¢éƒ½å·²ç»å¾—åˆ°äº†å……åˆ†çš„è®¨è®ºå’Œè¯„å®¡ï¼Œå¹¶ä¸”å·²ç»æœ‰äº†è‡³å°‘ä¸€ä¸ªå®ç°ã€‚è¿™æ„å‘³ç€ææ¡ˆå·²ç»è¶³å¤Ÿæˆç†Ÿï¼Œå¯ä»¥ä¾›å¼€å‘è€…ä½¿ç”¨å’Œæä¾›åé¦ˆã€‚
5. Stage 4 - Finishedï¼ˆå®Œæˆï¼‰ï¼šåœ¨è¿™ä¸ªé˜¶æ®µï¼Œææ¡ˆå·²ç»é€šè¿‡äº†æ‰€æœ‰çš„è¯„å®¡æµç¨‹ï¼Œå¹¶ä¸”å·²ç»è¢«åŠ å…¥åˆ°äº† ECMAScript çš„æ ‡å‡†ä¸­ã€‚è¿™æ„å‘³ç€è¯¥ç‰¹æ€§å·²ç»æˆä¸ºäº† JavaScript çš„ä¸€éƒ¨åˆ†ï¼Œå¹¶ä¸”å¯ä»¥åœ¨ä»»ä½•æ”¯æŒè¯¥ç‰ˆæœ¬æ ‡å‡†çš„ç¯å¢ƒä¸­ä½¿ç”¨ã€‚

å› æ­¤ï¼Œå½“è¯´ä¸€ä¸ªç‰¹æ€§å¤„äº Stage 3 æ—¶ï¼Œæ„å‘³ç€å®ƒå·²ç»ç›¸å¯¹æˆç†Ÿï¼Œå…·æœ‰å¯ç”¨æ€§ï¼Œå¹¶ä¸”å¾ˆå¯èƒ½ä¼šæœ€ç»ˆæˆä¸º ECMAScript æ ‡å‡†çš„ä¸€éƒ¨åˆ†ã€‚

æœ‰è¿™ä¹ˆå¤šç‰¹æ€§è¦ babel å»è½¬æ¢ï¼Œæ¯ä¸ªç‰¹æ€§ç”¨ä¸€ä¸ª babel æ’ä»¶æ¥åšã€‚ä½†æ˜¯ç‰¹æ€§å¤šå•Šï¼Œä¹Ÿå°±æ˜¯è¯´æ’ä»¶å¤šï¼Œæ€»ä¸èƒ½è®©ç”¨æˆ·è‡ªå·±å»é…ä¸€ä¸ªä¸ªæ’ä»¶å§ï¼Œæ‰€ä»¥ babel 6 å¼•å…¥äº† preset çš„æ¦‚å¿µï¼Œå°±æ˜¯ plugin çš„é›†åˆã€‚

å¦‚æœæˆ‘ä»¬æƒ³ç”¨ es6 è¯­æ³•å°±ç”¨ babel-preset-es2015ï¼Œes7 å°±åœ¨å¼•å…¥ babel-preset-es2016 ç­‰ç­‰ã€‚å¦‚æœæ˜¯æƒ³ç”¨è¿˜æ²¡åŠ å…¥æ ‡å‡†çš„ç‰¹æ€§ï¼Œåˆ™åˆ†åˆ«ç”¨ babel-preset-stage0ã€babel-preset-stage1 ç­‰æ¥å¼•å…¥ã€‚è¿™æ ·é€šè¿‡é€‰æ‹©ä¸åŒçš„ presetï¼ŒåŠ ä¸Šæ‰‹åŠ¨å¼•å…¥ä¸€äº›æ’ä»¶ï¼Œå°±æ˜¯æ‰€æœ‰ babel ä¼šåšçš„è½¬æ¢ã€‚

å¯ä»¥æŠŠè¿™ä¸ªè¿‡ç¨‹ç†è§£ä¸ºé›†åˆæ±‚å¹¶é›†çš„è¿‡ç¨‹ã€‚

![webpack88](..\images\webpack88.png)

å¹¶é›†çš„ç»“æœå°±æ˜¯æ‰€æœ‰æ”¯æŒçš„ç‰¹æ€§ã€‚

babel 6 å°±æ˜¯é€šè¿‡è¿™æ ·çš„æ–¹å¼æ¥æ”¯æŒå„ç§ç›®æ ‡ç¯å¢ƒä¸æ”¯æŒçš„ç‰¹æ€§è½¬æ¢çš„é…ç½®ã€‚

**ç»†æƒ³ä¸€ä¸‹ï¼Œè¿™æ ·çš„æ–¹å¼æœ‰æ²¡æœ‰é—®é¢˜ï¼Ÿ**

è¿™æ ·è™½ç„¶èƒ½è¾¾åˆ°ç›®çš„ï¼Œä½†æ˜¯æ˜¯æœ‰é—®é¢˜çš„ï¼Œä¸»è¦æœ‰ä¸¤ç‚¹ï¼š

- es çš„æ ‡å‡†æ¯å¹´éƒ½åœ¨å˜ï¼Œç°åœ¨çš„ stage-0 å¯èƒ½å¾ˆå¿«å°± stage-2 äº†ï¼Œé‚£ preset æ€ä¹ˆç»´æŠ¤ï¼Œè¦ä¸è¦è·Ÿç€å˜ï¼Œç”¨æˆ·æ€ä¹ˆçŸ¥é“è¿™ä¸ª stage-x éƒ½æ”¯æŒä»€ä¹ˆç‰¹æ€§ï¼Ÿ
- åªèƒ½è½¬æˆ es5ï¼Œé‚£ç›®æ ‡ç¯å¢ƒæ”¯æŒä¸€äº› es6 ç‰¹æ€§äº†ï¼Œé‚£è¿™äº›è½¬æ¢å’Œ polyfill å²‚ä¸æ˜¯æ— ç”¨åŠŸï¼Ÿ è€Œä¸”è¿˜å¢åŠ äº†äº§ç‰©çš„ä½“ç§¯ã€‚
- polyfill æ‰‹åŠ¨å¼•å…¥ï¼Œæ¯”è¾ƒéº»çƒ¦ï¼Œæœ‰æ²¡æœ‰æ›´å¥½çš„æ–¹å¼

è¿™ä¸¤ä¸ªé—®é¢˜æ˜¯ babel 6 çš„æ—¶å€™ä¸€ç›´å­˜åœ¨çš„ã€‚æ‰€ä»¥è¿™ç§æ–¹æ¡ˆç®—æ˜¯åŠæ ¼ï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰é—®é¢˜çš„ï¼Œæˆ‘ä»¬ç»™ 70 åˆ†ä¸è¿‡åˆ†å§ã€‚ ï¼ˆèƒ½å®ŒæˆåŠŸèƒ½å°±å¯ä»¥ç»™ 60 åˆ†ï¼Œå¤šåŠ  10 åˆ†æ˜¯ç»™ babel 6 å¼•å…¥çš„ presetï¼Œç¡®å®ç®€åŒ–äº†å¾ˆå¤šé…ç½®ï¼‰

é‚£æ€ä¹ˆè§£å†³ babel 6 çš„é—®é¢˜å‘¢ï¼Ÿbabel 7 ç»™å‡ºäº†ç­”æ¡ˆã€‚

## 2ã€babel 7

babel 7 æ”¹åŠ¨æŒºå¤§çš„ï¼Œæ¯”å¦‚æ‰€æœ‰çš„åŒ…éƒ½è¿ç§»åˆ°äº† @babel çš„ scope ä¸‹ï¼Œä¹Ÿå°±æ˜¯ @babel/xxxï¼Œè¿™äº›æˆ‘ä»¬ä¸ç®¡ï¼Œåªçœ‹ babel 7 æ˜¯æ€ä¹ˆè§£å†³ babel 6 çš„é—®é¢˜çš„ï¼Œ

babel 7 åºŸå¼ƒäº† preset-20xx å’Œ preset-stage-x çš„ preset åŒ…ï¼Œè€Œæ¢æˆäº† preset-envï¼Œpreset-env é»˜è®¤ä¼šæ”¯æŒæ‰€æœ‰ es æ ‡å‡†çš„ç‰¹æ€§ï¼Œå¦‚æœæ²¡è¿›å…¥æ ‡å‡†çš„ï¼Œä¸å†å°è£…æˆ presetï¼Œéœ€è¦æ‰‹åŠ¨æŒ‡å®š plugin-proposal-xxxã€‚

å®ƒçš„é›†åˆæ˜¯è¿™æ ·çš„ï¼š

![webpack89](..\images\webpack89.png)

æ˜¯ä¸æ˜¯æ¯”èµ· babel 6 æ›´ç®€å•äº†ã€‚

ï¼ˆpreset-react ç­‰ä¸æ˜¯ es æ ‡å‡†è¯­æ³•ï¼Œä¹Ÿæ²¡æœ‰å•¥å˜åŒ–ï¼Œå°±ä¸åŒ…æ‹¬åœ¨é‡Œé¢äº†ï¼‰ã€‚

ä½†æ˜¯ preset å’Œ plugin proposal çš„æ”¹å˜åªæ˜¯è§£å†³äº†ä¹‹å‰çš„ preset ç»å¸¸å˜çš„é—®é¢˜ã€‚é‚£ä¹ˆå¤šè½¬æ¢äº†ä¸€äº›ç¯å¢ƒæ”¯æŒçš„ç‰¹æ€§ï¼Œè¿™ä¸ªé—®é¢˜æ˜¯æ€ä¹ˆè§£å†³çš„å‘¢ï¼Ÿ

ç­”æ¡ˆæ˜¯ compat-tableï¼Œå®ƒç»™å‡ºäº†æ¯ä¸ªç‰¹æ€§åœ¨ä¸åŒæµè§ˆå™¨æˆ–è€… node ç¯å¢ƒä¸­çš„æœ€ä½æ”¯æŒç‰ˆæœ¬ï¼Œbabel åŸºäºè¿™ä¸ªè‡ªå·±ç»´æŠ¤äº†ä¸€ä»½æ•°æ®åº“ï¼Œåœ¨ [@babel/compat-data](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbabel%2Fbabel%2Fblob%2Fmain%2Fpackages%2Fbabel-compat-data%2Fdata%2Fplugins.json) ä¸‹ã€‚

å…¶ä¸­æœ‰æ¯ä¸ªç‰¹æ€§åœ¨ä¸åŒç¯å¢ƒçš„ä»€ä¹ˆç‰ˆæœ¬æ”¯æŒçš„æ•°æ®ï¼š

![webpack90](..\images\webpack90.png)

æœ‰äº†è¿™äº›æ•°æ®ï¼Œé‚£ä¹ˆåªè¦ç”¨æˆ·æŒ‡å®šä»–çš„ç›®æ ‡ç¯å¢ƒæ˜¯å•¥å°±å¯ä»¥äº†ï¼Œè¿™æ—¶å€™å¯ä»¥ç”¨ browserslist çš„ query æ¥å†™ï¼Œæ¯”å¦‚ last 1 versionï¼Œ> 1% è¿™ç§å­—ç¬¦ä¸²ï¼Œbabel ä¼šä½¿ç”¨ brwoserslist æ¥æŠŠå®ƒä»¬è½¬æˆç›®æ ‡ç¯å¢ƒå…·ä½“ç‰ˆæœ¬çš„æ•°æ®ã€‚

![webpack91](..\images\webpack91.png)

æœ‰äº†ä¸åŒç‰¹æ€§æ”¯æŒçš„ç¯å¢ƒçš„æœ€ä½ç‰ˆæœ¬çš„æ•°æ®ï¼Œæœ‰äº†å…·ä½“çš„ç‰ˆæœ¬ï¼Œé‚£ä¹ˆè¿‡æ»¤å‡ºæ¥çš„å°±æ˜¯ç›®æ ‡ç¯å¢ƒä¸æ”¯æŒçš„ç‰¹æ€§ï¼Œç„¶åå¼•å…¥å®ƒä»¬å¯¹åº”çš„æ’ä»¶å³å¯ã€‚è¿™å°±æ˜¯ preset-env åšçš„äº‹æƒ…ã€‚

![webpack92](..\images\webpack92.png)

é…ç½®æ–¹å¼æ¯”å¦‚ï¼š

```javascript
{
    "presets": [["@babel/preset-env", { "targets": "> 0.25%, not dead" }]]
}
```

è¿™æ ·å°±é€šè¿‡ preset-env è§£å†³äº†è½¬æ¢äº†ç›®æ ‡ç¯å¢ƒå·²ç»æ”¯æŒçš„ç‰¹æ€§çš„é—®é¢˜ã€‚å…¶å® polyfill ä¹Ÿå¯ä»¥é€šè¿‡ targets æ¥è¿‡æ»¤ã€‚

![webpack93](..\images\webpack93.png)

ä¸å†æ‰‹åŠ¨å¼•å…¥ polyfillï¼Œé‚£ä¹ˆæ€ä¹ˆå¼•å…¥ï¼Ÿ å½“ç„¶æ˜¯ç”¨ preset-env è‡ªåŠ¨å¼•å…¥äº†ã€‚ä½†æ˜¯ä¹Ÿä¸æ˜¯é»˜è®¤å°±ä¼šå¯ç”¨è¿™ä¸ªåŠŸèƒ½ï¼Œéœ€è¦é…ç½®ã€‚

```javascript
{
    "presets": [["@babel/preset-env", { 
        "targets": "> 0.25%, not dead",
        "useBuiltIns": "usage",// or "entry" or "false"
        "corejs": 3
    }]]
}
```

é…ç½®ä¸‹ corejs å’Œ useBuiltInsã€‚

- corejs å°±æ˜¯ babel 7 æ‰€ç”¨çš„ polyfillï¼Œéœ€è¦æŒ‡å®šä¸‹ç‰ˆæœ¬ï¼Œcorejs 3 æ‰æ”¯æŒå®ä¾‹æ–¹æ³•ï¼ˆæ¯”å¦‚ Array.prototype.fill ï¼‰çš„ polyfillã€‚
- useBuiltIns å°±æ˜¯ä½¿ç”¨ polyfill ï¼ˆcorejsï¼‰çš„æ–¹å¼ï¼Œæ˜¯åœ¨å…¥å£å¤„å…¨éƒ¨å¼•å…¥ï¼ˆentryï¼‰ï¼Œè¿˜æ˜¯æ¯ä¸ªæ–‡ä»¶å¼•å…¥ç”¨åˆ°çš„ï¼ˆusageï¼‰ï¼Œæˆ–è€…ä¸å¼•å…¥ï¼ˆfalseï¼‰ã€‚

é…ç½®äº†è¿™ä¸¤ä¸ª option å°±å¯ä»¥è‡ªåŠ¨å¼•å…¥ polyfill äº†ã€‚

![webpack94](..\images\webpack94.png)

polyfill é»˜è®¤æ˜¯å…¨å±€å¼•å…¥çš„ï¼Œæœ‰çš„æ—¶å€™ä¸æƒ³æ±¡æŸ“å…¨å±€å˜é‡å°±è¦ç”¨ @babel/plugin-transform-runtime è½¬æ¢ä¸‹ã€‚ï¼ˆè¿™ä¸ªæ’ä»¶ babel 6 å°±æœ‰äº†ï¼‰ã€‚

![webpack95](..\images\webpack95.png)

è¿™æ ·å°±ä¸å†æ±¡æŸ“å…¨å±€ç¯å¢ƒäº†ï¼Œè€Œæ˜¯ä½¿ç”¨ä¸€ä¸ªå”¯ä¸€çš„æ ‡è¯†ç¬¦æ¥å¼•å…¥ã€‚

çœ‹èµ·æ¥ï¼Œbabel 7 å¥½åƒå·²ç»å¾ˆå®Œç¾äº†ï¼Œå¯ä»¥æ‰“ 90 å¤šåˆ†äº†ï¼Ÿ

ä¸æ˜¯çš„ï¼Œbabel 7 æœ‰ babel 7 çš„é—®é¢˜ã€‚

**babel 7 çš„é—®é¢˜**

@babel/plugin-transform-runtime æ˜¯ä¸æ”¯æŒé…ç½® targets çš„ï¼Œå› ä¸ºä¸çŸ¥é“ç›®æ ‡ç¯å¢ƒæ”¯æŒå•¥ï¼Œå®ƒåªèƒ½å…¨éƒ¨åšè½¬æ¢ã€‚ä½ å¯èƒ½è¯´ä¸æ˜¯æœ‰ preset-env ä¹ˆï¼Ÿ

babel ä¸­æ’ä»¶çš„åº”ç”¨é¡ºåºæ˜¯ï¼šå…ˆ plugin å† presetï¼Œplugin ä»å·¦åˆ°å³ï¼Œpreset ä»å³åˆ°å·¦ï¼Œè¿™æ · plugin-transform-runtime æ˜¯åœ¨ preset-env å‰é¢çš„ã€‚

ç­‰ @babel/plugin-transform-runtime è½¬å®Œäº†ä¹‹åï¼Œå†äº¤ç»™ preset-env è¿™æ—¶å€™å·²ç»åšäº†æ— ç”¨çš„è½¬æ¢äº†ã€‚

æˆ‘ä»¬æ¥è¯•éªŒä¸€ä¸‹ï¼š

æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ Array.prototype.fill çš„ç¯å¢ƒæ”¯æŒæƒ…å†µï¼š

![webpack96](..\images\webpack96.png)

å¯ä»¥çœ‹åˆ°åœ¨ Chrome 45 åŠä»¥ä¸Šæ”¯æŒè¿™ä¸ªç‰¹æ€§ï¼Œè€Œåœ¨ Chrome 44 å°±ä¸æ”¯æŒäº†ã€‚

æˆ‘ä»¬å…ˆå•ç‹¬è¯•ä¸€ä¸‹ preset-envï¼š

å½“æŒ‡å®š targets ä¸º Chrome 44 æ—¶ï¼Œåº”è¯¥è‡ªåŠ¨å¼•å…¥polyfillï¼š

![webpack97](..\images\webpack97.png)

å½“æŒ‡å®š targets ä¸º Chrome 45 æ—¶ï¼Œä¸éœ€è¦å¼•å…¥polyfillï¼š

![webpack98](..\images\webpack98.png)

ç»“æœéƒ½ç¬¦åˆé¢„æœŸï¼Œ44 å¼•å…¥ï¼Œ45 ä¸å¼•å…¥ã€‚

æˆ‘ä»¬å†æ¥è¯•è¯• @babel/plugin-transform-runtimeï¼š

![webpack99](..\images\webpack99.png)

æ˜¯ä¸æ˜¯å‘ç°é—®é¢˜äº†ï¼ŒChrome 45 ä¸æ˜¯æ”¯æŒ Array.prototype.fill æ–¹æ³•ä¹ˆï¼Œä¸ºå•¥è¿˜æ˜¯å¼•å…¥äº† polyfillã€‚

äºæ˜¯å»é—®äº†ä¸‹ä½œè€…ï¼Œæäº†ä¸ª [feature request](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbabel%2Fbabel%2Fissues%2F13226)ï¼Œä½œè€…è¯´å¯ä»¥ç”¨æœ€æ–°çš„ babel polyfill ç³»åˆ—åŒ…è§£å†³äº†è¿™ä¸ªé—®é¢˜.

å»çœ‹äº†ä¸‹ï¼Œè¿™ä¸ªåŒ…è¿˜åœ¨è¯•éªŒé˜¶æ®µï¼Œç¡®å®è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚

è¿™ä¸ªåŒ…ä¼°è®¡åœ¨ babel 8 ä¼šå†…ç½®åˆ° babelã€‚

é‚£ä¹ˆç»™ babel 7 æ‰“ä¸ªåˆ†å§ï¼Œæœ¬æ¥ preset-env çš„å¼•å…¥ä½¿æˆ‘ä»¬èƒ½æ›´ç²¾å‡†çš„è½¬æ¢ä»£ç å’Œå¼•å…¥ polyfillï¼Œæƒ³ç»™ 90 åˆ†ï¼Œä½†æ˜¯ plugin-transform-runtime çš„é—®é¢˜è®©æˆ‘ç»™å®ƒå‡äº† 10 åˆ†ï¼Œç»¼åˆç»™ 80 åˆ†å§ã€‚

## 3ã€babel 8

babel 8 è¿˜æ²¡å‡ºæ¥ï¼Œä½†æ˜¯æˆ‘ä»¬çŸ¥é“ babel å†æ€ä¹ˆæ›´æ–°ä¹Ÿæ˜¯å›´ç»•ä¸»çº¿æ¥çš„ï¼Œä¹Ÿå°±æ˜¯å¯¹ç›®æ ‡ç¯å¢ƒä¸æ”¯æŒçš„ç‰¹æ€§è‡ªåŠ¨è¿›è¡Œç²¾å‡†çš„è½¬æ¢å’Œ polyfillã€‚æ¯ä¸ªç‰ˆæœ¬éƒ½æ˜¯è§£å†³äº†ä¸Šä¸ªç‰ˆæœ¬çš„é—®é¢˜çš„ï¼Œbabel 8 çš„ @babel/polyfills åŒ…å°±è§£å†³äº† babel 7 çš„ @babel/plugin-transform-runtime çš„é—ç•™é—®é¢˜ï¼Œå¯ä»¥é€šè¿‡ targets æ¥æŒ‰éœ€ç²¾å‡†å¼•å…¥ polyfill äº†ã€‚

å®ƒæ”¯æŒé…ç½®ä¸€ä¸ª polyfill providerï¼Œä¹Ÿå°±æ˜¯è¯´ä½ å¯ä»¥æŒ‡å®š corejs2ã€corejs3ã€es-shims ç­‰çš„polyfillï¼Œè¿˜å¯ä»¥è‡ªå®šä¹‰ polyfilï¼Œä¹Ÿå°±æ˜¯ä½ å¯ä»¥ä½¿ç”¨è‡ªå·±çš„ polyfillã€‚

ç„¶åæœ‰äº† polyfill æºä¹‹åï¼Œä½¿ç”¨ polyfill çš„æ–¹å¼ä¹ŸæŠŠä¹‹å‰ transform-runtime åšçš„äº‹æƒ…å†…ç½®äº†ï¼Œä¹Ÿå°±æ˜¯ä»ä¹‹å‰çš„ useBuiltIns: entryã€ useBuiltIns: usage çš„ä¸¤ç§ï¼Œå˜æˆäº† 3 ç§ï¼š

è¿™ä¸ªæ–¹æ¡ˆå®ç°åï¼ŒBabel çš„é…ç½®ä¼šæ˜¯ä¸‹é¢çš„æ ·å­ï¼š

```
// babel.config.js
const targets = [
  '>1%'
]
const presets = [
  [
    '@babel/env',
    {
      debug: true
    }
  ]
]
const plugins = [
  '@babel/plugin-proposal-class-properties'
]
const polyfills = [
  [
    'corejs3',
    {
      method: 'usage-pure'
    }
  ]
]

module.exports = { targets, presets, plugins, polyfills }
```



- entry-global: è¿™ä¸ªå’Œä¹‹å‰çš„ useBuiltIns: entry å¯¹æ ‡ï¼Œå°±æ˜¯å…¨å±€å¼•å…¥ polyfillã€‚

  ![webpack100](..\images\webpack100.png)

- usage-entry: è¿™ä¸ªå’Œ useBuiltIns: usage å¯¹æ ‡ï¼Œå°±æ˜¯å…·ä½“æ¨¡å—å¼•å…¥ç”¨åˆ°çš„ polyfillã€‚

  ![webpack101](..\images\webpack101.png)

- usage-pureï¼šè¿™ä¸ªå°±æ˜¯ä¹‹å‰éœ€è¦ transform-runtime æ’ä»¶åšçš„äº‹æƒ…ï¼Œä½¿ç”¨ä¸æ±¡æŸ“å…¨å±€å˜é‡çš„ pure çš„æ–¹å¼å¼•å…¥å…·ä½“æ¨¡å—ç”¨åˆ°çš„ polyfill.

  ![webpack102](..\images\webpack102.png)

å…¶å®è¿™ä¸‰ç§æ–¹å¼ babel 7 ä¹Ÿæ”¯æŒï¼Œä½†æ˜¯ç°åœ¨ä¸å†éœ€è¦æ’ä»¶äº†ï¼Œè€Œä¸”è¿˜æ”¯æŒäº† polyfill provider çš„é…ç½®ï¼Œæ‰€ä»¥åˆ°äº† babel 8 çš„é˜¶æ®µï¼Œ @babel/preset-env æ‰æ˜¯åŠŸèƒ½å®Œå¤‡çš„ã€‚

**é‚£ä¹ˆæ’ä»¶å¦‚æœæƒ³ç”¨ targets è¯¥æ€ä¹ˆç”¨å‘¢ï¼Ÿ**

@babel/helper-compilation-targets ï¼Œhelper æ˜¯ç”¨äºæ’ä»¶ä¹‹é—´å¤ç”¨ä»£ç çš„æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯ç»™æ’ä»¶å¼€å‘ç”¨çš„åº“ã€‚

![webpack103](..\images\webpack103.png)

æˆ‘çœ‹äº†ä¸‹ï¼Œè¿™ä¸ªåº“æä¾›äº† 3 ä¸ª apiï¼š

- æ ¹æ® query æŸ¥è¯¢ç›®æ ‡ç¯å¢ƒç‰ˆæœ¬ï¼š getTargets
- è¿‡æ»¤ç›®æ ‡ç¯å¢ƒ: filterItems
- åˆ¤æ–­æŸä¸ªæ’ä»¶æ˜¯å¦éœ€è¦ï¼šisRequired

åˆ†åˆ«å¯¹åº”æˆ‘ä»¬å‰é¢èŠåˆ°çš„éœ€è¦ å…ˆ**é€šè¿‡ query ç¡®å®šç›®æ ‡ç¯å¢ƒ**ï¼Œç„¶å**å¯¹ç›®æ ‡ç¯å¢ƒåšè¿‡æ»¤**ï¼Œä¹‹å**åˆ¤æ–­æŸä¸ªæ’ä»¶æ˜¯å¦éœ€è¦**çš„ 3ä¸ªé˜¶æ®µã€‚

æ’ä»¶é‡Œé¢é€šè¿‡ api.targets() æ‹¿åˆ°ç¯å¢ƒçš„é…ç½®ï¼Œç„¶åé€šè¿‡ isRequired æ¥ç¡®å®šæŸä¸ªæ’ä»¶æœ‰æ²¡æœ‰å¿…è¦ç”¨ã€‚

![webpack104](..\images\webpack104.png)

è¿™æ ·ï¼Œä¸ç®¡æ˜¯å†…ç½® plugin å’Œ preset çš„å®ç°æ–¹å¼ä¹Ÿå¥½ï¼Œè¿˜æ˜¯æ’ä»¶æ‰€èƒ½ç”¨çš„ api ä¹Ÿå¥½ï¼Œéƒ½å®Œç¾æ”¯æŒäº† targetsï¼Œåˆ°äº†è¿™ä¸ªé˜¶æ®µ targets æ‰ç®—çœŸæ­£èå…¥è¿›äº† babel ä¸­ã€‚

è¿™ä¸ªé˜¶æ®µçš„ babelï¼Œæˆ‘è§‰å¾—å·²ç»å¯ä»¥ç»™å‡º 90 åˆ†çš„åˆ†æ•°äº†ï¼š

æ”¯æŒæŒ‰ç…§é…ç½®çš„ç›®æ ‡ç¯å¢ƒæŒ‰éœ€è¿›è¡Œ polyfill å’Œ transformï¼Œæ”¯æŒ polyfill çš„åˆ‡æ¢å’Œè‡ªå®šä¹‰ï¼Œé…ç½®æ–¹å¼ä¹Ÿè¶³å¤Ÿç®€å•ï¼Œæ’ä»¶ä¸­ä¹Ÿå¯ä»¥ç”¨ targetsï¼Œè€Œä¸”æä¾›äº†æ–¹ä¾¿çš„ helper åŒ…ã€‚