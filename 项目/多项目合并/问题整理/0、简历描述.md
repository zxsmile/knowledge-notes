**前端多项目服务单元合并** 

2024.08 - 2024.10



- [ ] **项目介绍：** 反洗钱产品化平台原来由多个子系统组成，每个子系统仓库代码独立，容器平台资源成本高，每个月都有多个系统的迭代需求，子系统每次都需要单独部署上线，人力上线成本高，为节省资源，将开发室内前端项目分类，同一个类别内的项目全部合并为一个代码仓库，并部署在容器平台的一个服务单元上，迭代需求多项目一次部署即可完成上线，提升了上线效率。 我独立负责了本项目的前端工作



- [ ] **工作内容：**
  - [ ] **技术方案：**新建一个`vue`项目作为最外层的包裹项目，通过流水线将各个子项目打包到dist的不同目录中相互独立，并部署到容器平台，通过不同的路由去访问各个子项目
  - [ ] **项目工程化改造：**编写并配置外层项目的`webpack`，实现统一下载子项目依赖，一键构建不同子项目、多入口构建方式的改造
  - [ ] **`Ngnix`部署配置：**修改项目部署之后的访问路径，路由文件参数，保障项目与静态资源访问
  - [ ] **容器化平台配置：**新建流水线并配置构建命令以确保流水线`ci/cd`运行、基于 `Dockerfile` 打包镜像、新建服务单元并关联流水线、挂载配置性文件
  - [ ] **性能优化：**优化项目包体积，优化`web`端加载速度，采用`splitChunks`实现子项目共享字体包、`css`静态资源、`gzip`压缩包体积、浏览器强缓存`cache-control`等手段优化，解决了项目部署问题、字体闪动问题，加载慢问题，包体积从`36.61MB`减少至`18.41MB`，首次加载速度从`3023ms`减少至`1079ms`
  - [ ] **输出文档：**编写项目实现的技术文档，并在团队内分享































项目背景：产品化平台由多个子系统组成，容器平台资源成本高,每个月都有多个系统的迭代需求，人力上线成本高，为节省资源，将开发室内所有前端项目按照一定类别分类，同一个类别内的项目全部合并为容器平台上的一个服务单元，但项目的开发和访问还是呈现独立状态。

负责内容：

1、方案选择：新建一个`vue`项目作为最外层的包裹项目，需要合并的项目作为该项目的子项目，通过流水线将各个子项目打包到`dist`的不同目录中相互独立，并部署到容器平台上，通过不同的路由去访问各个子项目。

2、增加`workspaces`字段可以直接在最外层的`vue`项目上执行`npm install`命令下载所有子项目的依赖， 使用`npm install xxxx --legacy-peer-deps`解决最外层的`vue`项目中执行`npm i` 报错，依赖冲突。

3、在`package.json`文件中的`script`字段里面配置构建脚本，使用`PROJECT_NAME`变量来区分构建的是那个子项目。

4、编写最外层的`vue.config.js`，由于是多个项目，所以`webpack`的构建入口使用多入口方式，通过`PROJECT_NAME`变量来读取每个项目的`main.js`入口文件，每个项目也要使用自己的`html`模版显示页面，所以需要配置子项目的`vue.config.js`文件中的`html`模版路径（`chainWebpack`）

5、修改`nginx.conf`文件，这个文件主要配置项目部署之后的访问路径，部署在根目录下对原项目没有啥影响，但部署在二级目录下的项目，如果使用的是`history`路由模式，要将`vue.config.js`中的`publicPath`改为`'./'`，路由文件增加`base`参数，值为项目部署的二级路由，和`nginx.conf`中的二级路由保持一致，比如我当前的路由文件的`base`参数就应该设置为`/model/`

`location` 要写 `^~/vue3` ，写 `/vue3` 页面会一直空白，并报错找不到 `assets` 目录下的资源文件。因为原`Vue2`项目的location是 `/` ， `/vue3` 会匹配到原`Vue2`项目，且原项目中没有 `/vue3` 这个路由，所以页面空白，即没有资源文件。`^~/vue3`` 表示忽略其他location配置的URI，直接匹配 ``/vue3`，所以成功。

在前端开发中，`:ml-search[Vue Router]`的`base`参数用于定义单页应用（SPA）的基础路径，主要用于解决部署路径问题。当应用部署在非根目录时（如`http://example.com/my-app/`），需通过`base`参数指定正确的路径前缀，以确保路由解析和跳转的准确性。 ‌12

### 配置方式

创建路由实例时，通过以下方式设置`base`参数：

```
javascriptCopy Codeconst router = new VueRouter({
  mode: 'history',
  base: '/my-app/',
  routes: [
    // 路由配置
  ]
});
```

若应用部署在根目录（如`http://example.com/`），则无需设置`base`参数，默认值为`/`。 ‌

### 核心作用

1. ‌**路径解析**‌：所有路由解析时会自动添加`base`参数指定的前缀。例如，若`base`为`/app/`，访问`/home`时实际解析为`/app/home`。 ‌12
2. ‌**避免404错误**‌：在历史模式（history）下，正确配置可确保使用Vue Router跳转时不会出现404；若使用`window.location.href`跳转，则可能因未携带`base`参数导致路径错误。 ‌3

### 注意事项

- 仅在非根目录部署时配置（如子路径部署），根目录部署无需设置。 ‌12
- 需与服务器配置（如Nginx的`root`或`alias`指令）配合使用，确保资源加载路径正确。

6、性能优化提高web端加载速度，通过 `gzip`压缩、浏览器内存缓存、共享字体包资源